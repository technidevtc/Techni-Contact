<?php
/*
 Techni-Contact V2 - MD2I SAS
 http://www.techni-contact.com

 Auteur : Hook Network SARL - http://www.hook-network.com
 Date de création : 20 juillet 2005

 Fichier : /secure/extranet/product_detail.html
 Description : Edition produit
/=================================================================*/

require_once substr(dirname(__FILE__),0,strpos(dirname(__FILE__),'/',stripos(dirname(__FILE__),'technico')+1)+1).'config.php';
require_once(ADMIN."logo.php");

function & m_loadProduct(& $handle, $id, $idAdvertiser)
{
    $ret = false;
    
	$res = & $handle->query('select pm.id, p.name, p.fastdesc, p.descc as `desc`, p.descd, pm.refSupplier, pm.price, pm.price2, pm.unite, pm.marge, pm.idTVA, p.delai_livraison, pm.contrainteProduit, s.id as idsup, p.keywords from products_fr p, products pm left join sup_requests s on pm.id = s.idProduct where p.id = \'' . $handle->escape($id) . '\' and p.idAdvertiser = \'' . $handle->escape($idAdvertiser) . '\' and p.active = 1 and p.id = pm.id' , __FILE__, __LINE__);
	if ($handle->numrows($res, __FILE__, __LINE__) == 1)
    {
        $ret = & $handle->fetchArray($res, 'assoc');

        if($result = & $handle->query('select idFamily from products_families where idProduct = \'' . $handle->escape($id) . '\'', __FILE__, __LINE__))
        {
            $ret['familiesHidden'] = '';
            while($row = & $handle->fetch($result))
            {
                $ret['familiesHidden'] .= $row[0] . ',';
            }
        }
    }
    
    return $ret;
}


function lessThan(& $handle, $nb, $type, $id)
{
    $ret = false;
    
    $res = & $handle->query('select id from products_add_adv where type = \'' . $handle->escape($type) . '\' and idAdvertiser = \'' . $handle->escape($id) . '\' and reject = 0', __FILE__, __LINE__);
	if ($handle->numrows($res, __FILE__, __LINE__) < $nb)
    {
        $ret = true;
    }

    return $ret;

}


/* Editer un produit annonceur
   i : réf handle connexion
   i : id produit
   i : réf nom produit
   i : réf desc rapide produit
   i : id annonceur
   i : réf liste familles
   i : réf liste mots clé
   i : réf description
   i : réf description détaillée
   i : type doc 1
   i : type doc 2
   i : type doc 3
   o : true si ok, false si erreur */
function & editAdvertiserProduct(& $handle, $idProduct, & $name, & $fastdesc, & $desc, & $descd, & $refSupplier, $price, $price2, $unite, $margeRemise, $idTVA, & $delai_livraison, & $contrainteProduit, $idAdvertiser, & $families, & $keywords, $t1, $t2, $t3, $ref = '')
{
    $ret = false;

    $extra_d1 = isset($_GET['nodoc1']) ? false : true;
    $extra_d2 = isset($_GET['nodoc2']) ? false : true;
    $extra_d3 = isset($_GET['nodoc3']) ? false : true;

    $req = false;
	$res = $handle->query("select reject from products_add_adv where type = 'm' and id = '" . $handle->escape($idProduct) . "'", __FILE__, __LINE__);
	if ($handle->numrows($res, __FILE__, __LINE__) > 0) {
		list($reject) = $handle->fetch($res);
		if ($reject == 0) {
			$req = $handle->query("update products_add_adv set name = '" . $handle->escape($name) . "', fastdesc = '" . $handle->escape($fastdesc) . "', descc = '" . $handle->escape($desc) .
				"', descd = '" . $handle->escape($descd) . "', refSupplier = '" . $handle->escape($refSupplier) . "', price = '" . $handle->escape($price) . "', price2 = '" .
				$handle->escape($price2) . "', unite = '" . $handle->escape($unite) . "', marge = '" . $handle->escape($margeRemise) . "', idTVA = '" . $handle->escape($idTVA) .
				"', delai_livraison = '" . $handle->escape($delai_livraison) . "', contrainteProduit = '" . $handle->escape($contrainteProduit) . "', families = '" . $handle->escape($families) .
				"', keywords = '" . $handle->escape($keywords) . "', timestamp = '" . date('U') . "', ref = '" . $handle->escape($ref) . "' where id = '" . $handle->escape($idProduct) . "' and type = 'm'", __FILE__, __LINE__);

				// Effacer les éventuels fichiers en attente
				for($i = 1; $i <= 3; ++$i) {
					@unlink(PRODUCTS_FILES_ADV_INC . $idProduct . '-' . $i . '.doc');
					@unlink(PRODUCTS_FILES_ADV_INC . $idProduct . '-' . $i . '.pdf');
				}
		}
	}
	else {
		$req = $handle->query("insert into products_add_adv (id, type, name, fastdesc, descc, descd, refSupplier, price, price2, unite, marge, idTVA, delai_livraison, contrainteProduit, " .
			"idAdvertiser, families, keywords, timestamp, ref) values ('" . $idProduct . "', 'm', '" . $handle->escape($name) . "', '" . $handle->escape($fastdesc) . "', '" . $handle->escape($desc) .
			"', '" . $handle->escape($descd) . "', '" . $handle->escape($refSupplier) . "', '" . $handle->escape($price) . "', '" . $handle->escape($price2) . "', '" . $handle->escape($unite) .
			"', '" . $handle->escape($margeRemise) . "', '" . $handle->escape($idTVA) . "', '" . $handle->escape($delai_livraison) . "', '" . $handle->escape($contrainteProduit) . "', '" .
			$handle->escape($idAdvertiser) . "', '" . $handle->escape($families) . "', '" . $handle->escape($keywords) . "', '" . date('U') . "', '" . $handle->escape($ref) . "')", __FILE__, __LINE__);
	}

	if ($req) {
		ExtranetLog($handle, $_SESSION['login'], $_SESSION['ip'], 'Demande de modification de la fiche produit ' . $name . ' - ' . $fastdesc . ' | Description : ' . $desc . ' - Détaillée : ' . $descd . ' | Nouvelles données : Référence Fournisseur : ' . $refSupplier . ' - Prix Fournisseur : ' . $price2 . ' - Prix Public : ' . $price . ' - Unité : ' . $unite . ' - TVA : ' . $idTVA . ' - Délai de livraison : ' . $delai_livraison . ' - Contrainte Produit : ' . $contrainteProduit . ' | Mots clés : ' . $keywords . ' | Familles : ' . $families);
		$ret = true;

		// Copier les éventuels fichiers existants et remplacer avec les nouveaux up
		if($extra_d1) {
			@copy(PRODUCTS_FILES_INC . $idProduct . '-1.doc', PRODUCTS_FILES_ADV_INC . $idProduct . '-1.doc');
			@copy(PRODUCTS_FILES_INC . $idProduct . '-1.pdf', PRODUCTS_FILES_ADV_INC . $idProduct . '-1.pdf');
		}
		if($extra_d2) {
			@copy(PRODUCTS_FILES_INC . $idProduct . '-2.doc', PRODUCTS_FILES_ADV_INC . $idProduct . '-2.doc');
			@copy(PRODUCTS_FILES_INC . $idProduct . '-2.pdf', PRODUCTS_FILES_ADV_INC . $idProduct . '-2.pdf');
		}
		if($extra_d3) {
			@copy(PRODUCTS_FILES_INC . $idProduct . '-3.doc', PRODUCTS_FILES_ADV_INC . $idProduct . '-3.doc');
			@copy(PRODUCTS_FILES_INC . $idProduct . '-3.pdf', PRODUCTS_FILES_ADV_INC . $idProduct . '-3.pdf');
		}

		uploadDoc('doc1', $idProduct . '-1', PRODUCTS_FILES_ADV_INC, $t1);
		uploadDoc('doc2', $idProduct . '-2', PRODUCTS_FILES_ADV_INC, $t2);
		uploadDoc('doc3', $idProduct . '-3', PRODUCTS_FILES_ADV_INC, $t3);
	}

	return $ret;
}

///////////////////////////////////////////////////////////////////////////

include('language_local.php');

$title = EDIT_PRODUCT_TITLE;

define('WHERE', WHERE_PRODUCTS_CARD);

require(ADMIN    . 'families.php');
require(ADMIN    . 'products.php');
require(ADMIN    . 'tva.php');
require(EXTRANET . 'head.php');

?>
<div class="barre"><a href="index.html?<?php echo $sid ?>"><?php echo HEAD_HOMEPAGE ?></a> &raquo; <a href="products.html?<?php echo $sid ?>"><?php echo HEAD_PRODUCT_LIST ?></a> &raquo; <?php echo EDIT_PRODUCT_HEAD_TITLE ?></div>
<div class="miseAZero"></div>
<?php
require(EXTRANET . 'alertmdp.php');

define('NB_MAX', 10000);

if(!isset($_GET['id']) || !preg_match('/^[0-9]{1,8}$/', $_GET['id']) || !($pdt = & m_loadProduct($handle, $_GET['id'], $user->id)))
{
?>
<div class="centre">
	<div class="bloc">
		<div class="bloc-titre" style="text-align: center"><?php echo EDIT_PRODUCT_ERROR_ID ?></div>
	</div>
</div>
<?php
}
else if($pdt['idsup'] != '')
{
?>
<div class="centre">
	<div class="bloc">
		<div class="bloc-titre" style="text-align: center"><?php echo EDIT_PRODUCT_ERROR_EDIT_DELETE ?></div>
	</div>
</div>
<?php
}
else
{

///////////////////////////////////////////////////////////////////////////

$families  = & displayFamilies($handle);
$listeTVAs = & displayTVAs($handle, ' order by taux desc');
$idTVAdftDft = getConfig($handle, 'idTVAdft');

$errorstring = '';

if($_SERVER['REQUEST_METHOD'] == 'POST')
{
	$name = isset($_POST['name']) ? substr(trim($_POST['name']), 0, 255) : '';
	$name = preg_replace('/ +/', ' ', $name);
	if($name == '') $errorString .= PRODUCT_ERROR_NAME;
	elseif($name[0] < '0' && $name[0] > '9' && $name[0] < 'A' && $name[0] > 'Z')
		$errorString .= PRODUCT_ERROR_NAME_LETTER;
	
	$fastdesc = isset($_POST['fastdesc']) ? substr(trim($_POST['fastdesc']), 0, 255) : '';
	if($fastdesc == '') $errorString .= PRODUCT_ERROR_FASTDESC;
	
	$familiesHidden = isset($_POST['familiesHidden']) ? $_POST['familiesHidden'] : '';
	$familiesTab    = explode(',', $familiesHidden);
	$familiesHidden = $familiesShown  = '';
	
	for($i = 0; $i < count($familiesTab); ++$i)
	{
		if(preg_match('/^[0-9]+$/', $familiesTab[$i]))
		{
			if(($result = & $handle->query('select name from families_fr where id = \'' . $handle->escape($familiesTab[$i]). '\'', __FILE__, __LINE__)) && $handle->numrows($result, __FILE__, __LINE__) == 1)
			{
				$record = & $handle->fetch($result);
				$familiesHidden .= $familiesTab[$i] . ',';
				
				if($familiesShown != '') $familiesShown .= ' - ';
				// code redondant avec linkFamily.php du manager (en cas de modif ...)
				$familiesShown .= '<a href="javascript:removeFamily(\\\'' . $familiesTab[$i] . '\\\', \\\'' . to_entities(str_replace(array('"', "'", '&', '(', ')'), array(' ', ' ', '', '', ''), Utils::toASCII($record[0]))) . '\\\')">' . to_entities(str_replace(array('"', "'", '&', '(', ')'), array(' ', ' ', '', '', ''), Utils::toASCII($record[0]))) . '</a>';
			}
		}
	}

	if($familiesHidden == '') $errorString .= PRODUCT_ERROR_FAMILY;

	$k1 = isset($_POST['k1']) ? substr(trim($_POST['k1']), 0, 255) : '';
	$k2 = isset($_POST['k2']) ? substr(trim($_POST['k2']), 0, 255) : '';
	$k3 = isset($_POST['k3']) ? substr(trim($_POST['k3']), 0, 255) : '';
	$k4 = isset($_POST['k4']) ? substr(trim($_POST['k4']), 0, 255) : '';
	$k5 = isset($_POST['k5']) ? substr(trim($_POST['k5']), 0, 255) : '';

	$desc = isset($_POST['desc']) ? trim($_POST['desc']) : '';
	if($desc == '') $errorString .= PRODUCT_ERROR_DESC;

	$descd = isset($_POST['descd']) ? trim($_POST['descd']) : '';

	$type1 = isset($_POST['type1']) && $_POST['type1'] == '.doc' ? '.doc' : '.pdf';
	$type2 = isset($_POST['type2']) && $_POST['type2'] == '.doc' ? '.doc' : '.pdf';
	$type3 = isset($_POST['type3']) && $_POST['type3'] == '.doc' ? '.doc' : '.pdf';

	$isSupplier = $user->parent == 61049 ? true : false;

	$PriceType = isset($_POST['PriceType']) ? $_POST['PriceType'] : '0';
	
	// Champs en cas de saisie d'un produit avec un prix simple
	$price    = isset($_POST['price'])    ? substr(trim($_POST['price']), 0, 9)  : '';
	$price2   = isset($_POST['price2'])   ? substr(trim($_POST['price2']), 0, 9) : '';
	$code_ref = isset($_POST['code_ref']) ? $_POST['code_ref'] : '';
	$unite    = isset($_POST['unite'])    ? substr(trim($_POST['unite']), 0, 6)  : 1;
	if ($unite == '') $unite = 1;
	$idTVA    = isset($_POST['idTVA'])    ? substr(trim($_POST['idTVA']), 0, 2)  : '';
	
	// Champs communs aux produits avec prix simple ou avec références
	$delai_livraison   = isset($_POST['delai_livraison'])   ? substr(trim($_POST['delai_livraison']), 0, 255) : '';
	$contrainteProduit = isset($_POST['contrainteProduit']) ? substr(trim($_POST['contrainteProduit']), 0, 9) : 0;
	$refSupplier       = isset($_POST['refSupplier'])       ? substr(trim($_POST['refSupplier']), 0, 9)       : '';
	
	if ($PriceType == '0') // si prix simple saisi
	{
		if ($isSupplier)
		{
			if($contrainteProduit != '' && !preg_match('/^[0-9]+$/', $contrainteProduit))
				$errorString .= PRODUCT_ERROR_CONSTRAINT;
				
			if($refSupplier == '')
				$errorString .= PRODUCT_ERROR_REFSUPPLIER;
			
			if ($user->prixPublic == 0)
			{
				if (!preg_match('/^[0-9]+((\.|,)[0-9]+){0,1}$/', $price2))
					$errorString .= PRODUCT_ERROR_PRICE;
			}
			else
			{
				if (!preg_match('/^[0-9]+((\.|,)[0-9]+){0,1}$/', $price))
				   $errorString .= PRODUCT_ERROR_PRICE2;
			}
			
			if($unite != '' && !preg_match('/^[1-9]{1}[0-9]*$/', $unite))
				$errorString .= PRODUCT_ERROR_UNIT;
			
			if (!existTVA($handle, $idTVA))
				$errorString .= PRODUCT_ERROR_VAT;
		}
		else
		{
			if (!preg_match('/^[0-9]+((\.|,)[0-9]+){0,1}$/', $price))
			   $errorString .= PRODUCT_ERROR_PRICE;
		}
	}
	elseif($PriceType == '4') // si tableau de référence
	{
		if ($isSupplier)
		{
			if($contrainteProduit != '' && !preg_match('/^[0-9]+$/', $contrainteProduit))
				$errorString .= PRODUCT_ERROR_CONSTRAINT;
				
			list($colscount, $code_ref_tab) = explode('<=>', $code_ref);
			
			// Au moins 1 colonne sup
			if(empty($code_ref_tab) || !preg_match('/^[0-9]+$/', $colscount) || $colscount <= 7)
				$errorString .= PRODUCT_ERROR_SUP_ATTRIBUT;
			
			// Vérifier libellés des colonnes saisis
			$code_ref_tab_rows = explode('<_>', $code_ref_tab);
			$code_ref_tab_cols = explode('<->', $code_ref_tab_rows[0]);
			
			// Nombre de colonnes correspond + libellé première et dernière
			if (count($code_ref_tab_cols) != $colscount ||
				$code_ref_tab_cols[0] != 'Référence TC' ||
				$code_ref_tab_cols[1] != 'Libellé' ||
				$code_ref_tab_cols[2] != 'Référence' ||
				$code_ref_tab_cols[$colscount - 4] != 'Unité' ||
				$code_ref_tab_cols[$colscount - 3] != 'Taux TVA' ||
				$code_ref_tab_cols[$colscount - 2] != 'Prix' ||
				$code_ref_tab_cols[$colscount - 1] != 'Éco Taxe')
			{
				
				$code_ref_tab_cols[0] = 'Référence TC';
				$code_ref_tab_cols[1] = 'Libellé';
				$code_ref_tab_cols[2] = 'Référence';
				
				if($colscount > 7)
				{
					for($k = 3; $k < $colscount-4; $k++)
						$code_ref_tab_cols[$k] = '';
					$code_ref_tab_cols[$colscount - 4] = 'Unité';
					$code_ref_tab_cols[$colscount - 3] = 'Taux TVA';
					$code_ref_tab_cols[$colscount - 2] = 'Prix';
					$code_ref_tab_cols[$colscount - 1] = 'Éco Taxe';
				}
				else
				{
					$code_ref_tab_cols[3] = '';
					$code_ref_tab_cols[4] = 'Unité';
					$code_ref_tab_cols[5] = 'Taux TVA';
					$code_ref_tab_cols[6] = 'Prix';
					$code_ref_tab_cols[7] = 'Éco Taxe';
				}
				
				$errorString .= PRODUCT_ERROR_SUP_NB_COLS;
			}
			
			// Nom des autres colonnes
			if($colscount > 7)
			{
			    for($i = 3; $i < $colscount-4; ++$i)
				{
				    if(trim($code_ref_tab_cols[$i]) == '')
						$errorString .= PRODUCT_ERROR_LABEL_COL_P . ($i + 1) . PRODUCT_ERROR_LABEL_COL_S;
				}
			}
			
			// Vérifier si au moins 1 ligne
			if(count($code_ref_tab_rows) <= 1)
				$errorString .= PRODUCT_ERROR_LINE_1;
			
			$some_lines = false;
			
			// Vérifier nombre de colonnes dans chaque ligne (annuler celles qui correspondent pas)
			$label_lines = 0;
			
			$code_ref_lines = array();
			for($i = 1; $i < count($code_ref_tab_rows); ++$i)
			{
			    $line_data = explode('<->', $code_ref_tab_rows[$i]);
				
				$line_colscount = count($line_data);
				
				if($line_colscount != $colscount)
					$errorString .= PRODUCT_ERROR_LINE_PRE . $i . PRODUCT_ERROR_LINE_FORMAT;
				else
				{
					$code_ref_line = array();
					$code_ref_line['id']          = & $line_data[0];
					$code_ref_line['label']       = & $line_data[1];
					$code_ref_line['refSupplier'] = & $line_data[2];
					$code_ref_line['unite']       = & $line_data[$line_colscount-4];
					$code_ref_line['idTVA']       = & $line_data[$line_colscount-3];
					$code_ref_line['price']       = & $line_data[$line_colscount-2];
					$code_ref_line['ecotax']       = & $line_data[$line_colscount-1];
					
					for($j = 3; $j < $line_colscount-4; ++$j)
					{
						if ($j > 3 ) $code_ref_line['content'] .= '<->';
						$code_ref_line['content'] .= $line_data[$j];
					}
					$label_lines++;
					$some_lines = true;
				    
					// Vérif si quand la Référence TC est présente, elle est valide
				    if($code_ref_line['id'] != '' && !preg_match('/^[0-9]+$/', $code_ref_line['id']))
					    $errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_LINE_NUM;
					
				    // Vérif si libellé
				    if(trim($code_ref_line['label']) == '')
					    $errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_LINE_LABEL;
				    
					// Vérif si référence fournisseur
					if(trim($code_ref_line['refSupplier']) == '')
					    $errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_LINE_REFSUPPLIER;
				   
				    // Vérifier si au moins 1 autre donnée est saisie
				    $line_ok = false;
					$line_content = explode('<->', $code_ref_line['content']);
					for($j = 0; $j < count($line_content); $j++)
					{
						if(trim($line_content[$j]) != '')
						{
							$line_ok = true;
							break;
						}
				    }
					if(!$line_ok)
						$errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_LINE_DATA;
					
					// Test de validité des unité, taux de TVA, prix fournisseur, marge/remise et prix public s'ils sont saisis
					
					if(!preg_match('/^[1-9]{1}[0-9]*$/',  trim($code_ref_line['unite']))) // vérif validité unité
						$errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_LINE_UNIT;
					
					if (!existTVA($handle, trim($code_ref_line['idTVA'])))
						$errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_LINE_VAT;
					
					if (trim($code_ref_line['price']) != '' && !preg_match('/^[0-9]+((\.|,)[0-9]+){0,1}$/', trim($code_ref_line['price'])))
						$errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_SUP_LINE_PRICE;
					
					$code_ref_lines[] = $code_ref_line;
				}
			}
			
			// Vérifier si au moins 1 ligne
			if(!$some_lines)
				$errorString .= PRODUCT_ERROR_LINE_1_OK;
			
		}
		else
		{
			list($colscount, $code_ref_tab) = explode('<=>', $code_ref);
			
			// Au moins 1 colonne sup
			if(empty($code_ref_tab) || !preg_match('/^[0-9]+$/', $colscount) || $colscount <= 3)
				$errorString .= PRODUCT_ERROR_ADV_ATTRIBUT;
			
			// Vérifier libellés des colonnes saisis
			$code_ref_tab_rows = explode('<_>', $code_ref_tab);
			$code_ref_tab_cols = explode('<->', $code_ref_tab_rows[0]);
			
			
			// Nombre de colonnes correspond + libellé première et dernière
			if(count($code_ref_tab_cols) != $colscount ||
				$code_ref_tab_cols[0] != 'Référence TC' ||
				$code_ref_tab_cols[1] != 'Libellé' ||
				$code_ref_tab_cols[$colscount - 1] != 'Prix')
			{
				$code_ref_tab_cols[0] = 'Référence TC';
				$code_ref_tab_cols[1] = 'Libellé';
				
				if($colscount > 3)
				{
					for($k = 2; $k < $colscount-1; $k++)
						$code_ref_tab_cols[$k] = '';
					$code_ref_tab_cols[$colscount - 1] = 'Prix';
				}
				else
				{
					$code_ref_tab_cols[2] = '';
					$code_ref_tab_cols[3] = 'Prix';
				}
				$errorString .= PRODUCT_ERROR_ADV_NB_COLS;
			}
			
			// Nom des autres colonnes
			if($colscount > 3)
			{
				for($i = 2; $i < $colscount - 1; ++$i)
				{
					if(trim($code_ref_tab_cols[$i]) == '')
						$errorString .= PRODUCT_ERROR_LABEL_COL_P . ($i + 1) . PRODUCT_ERROR_LABEL_COL_S;
				}
			}
			
			// Vérifier si au moins 1 ligne
			if(count($code_ref_tab_rows) <= 1)
				$errorString .= PRODUCT_ERROR_LINE_1;
			
			$some_lines = false;
			
			// Vérifier nombre de colonnes dans chaque ligne (annuler celles qui correspondent pas)
			$label_lines = 0;
			
			$code_ref_lines = array();
			for($i = 1; $i < count($code_ref_tab_rows); ++$i)
			{
			    $line_data = explode('<->', $code_ref_tab_rows[$i]);
				
				$line_colscount = count($line_data);
				
				if($line_colscount != $colscount)
					$errorString .= PRODUCT_ERROR_LINE_PRE . $i . PRODUCT_ERROR_LINE_FORMAT;
				else
				{
					
					$code_ref_line = array();
					$code_ref_line['id']          = $line_data[0];
					$code_ref_line['label']       = $line_data[1];
					$code_ref_line['price']       = $line_data[$line_colscount-1];
					
					for($j = 2; $j < $line_colscount - 1; ++$j)
					{
						if ($j > 2 ) $code_ref_line['content'] .= '<->';
						$code_ref_line['content'] .= $line_data[$j];
					}
					
					++$label_lines;
					$some_lines = true;
					
					// Vérif si quand la Référence TC est présente, elle est valide
				    if($code_ref_line['id'] != '' && !preg_match('/^[0-9]+$/', $code_ref_line['id']))
					    $errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_LINE_NUM;
					
					// Vérif si libellé
					if(trim($code_ref_line['label']) == '')
						$errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_LINE_LABEL;
					
					// Vérifier si au moins 1 donnée en + de l'identifiant TC et du libellée est présente
					$line_ok = false;
					$line_content = explode('<->', $code_ref_line['content']);
					for($j = 0; $j < count($line_content); $j++)
					{
						if(trim($line_content[$j]) != '')
						{
							$line_ok = true;
							break;
						}
				    }
					if(!$line_ok)
						$errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_LINE_DATA;
				   
					if(trim($code_ref_line['price']) != '' && !preg_match('/^[0-9]+((\.|,)[0-9]+){0,1}$/', trim($code_ref_line['price'])))
						$errorString .= PRODUCT_ERROR_LINE_PRE . $label_lines . PRODUCT_ERROR_ADV_LINE_PRICE;
					
					$code_ref_lines[] = $code_ref_line;
				}
			}
			// Vérifier si au moins 1 ligne
			if(!$some_lines)
				$errorString .= PRODUCT_ERROR_LINE_1_OK;
		}
	} // fin PriceType
	
	if($errorString == '' && ($go = lessThan($handle, NB_MAX, 'm', $user->id)))
	{
		switch($PriceType)
		{
			case '1' :
				$price = COMMON_PRICE_TYPE_ON_DEMAND;
				$refSupplier = $price2 = '';
				$idTVA = '0';
				$delai_livraison = $contrainteProduit = '';
				break;
			case '2' :
				$price = COMMON_PRICE_TYPE_ON_ESTIMATE;
				$refSupplier = $price2 = '';
				$idTVA = '0';
				$delai_livraison = $contrainteProduit = '';
				break;
			case '3' :
				$price = COMMON_PRICE_TYPE_CONTACT_US;
				$refSupplier = $price2 = '';
				$idTVA = '0';
				$delai_livraison = $contrainteProduit = '';
				break;
			case '4' :
				$price = 'ref';
				$refSupplier = $price2 = '';
				$idTVA = '0';
				break;
			default :
				$PriceType = '0';
		}
		
		if ($isSupplier)
		{
			$margeRemise = $user->margeRemise;
			
			if ($PriceType == '0')
			{
				if ($user->prixPublic == 0)
					$price  = round($price2 * (100 + $margeRemise)) / 100;
				else
					$price2 = round($price * (100 - $margeRemise)) / 100;
			}
		}
		else
		{
			$price2 = '';
			$refSupplier = $contrainteProduit = $refSupplier = '';
			$idTVA = $user->idTVA;
			$margeRemise = $user->margeRemise;
			$unite = 1;
		}
		
		if($k1 != '') $keywords = $k1;
		if($k2 != '') { if($keywords != '') $keywords .= '|'; $keywords .= $k2; }
		if($k3 != '') { if($keywords != '') $keywords .= '|'; $keywords .= $k3; }
		if($k4 != '') { if($keywords != '') $keywords .= '|'; $keywords .= $k4; }
		if($k5 != '') { if($keywords != '') $keywords .= '|'; $keywords .= $k5; }
		
		// enregistrer la modification
		$ok = editAdvertiserProduct($handle, $_GET['id'], $name, $fastdesc, $desc, $descd, $refSupplier, $price, $price2, $unite, $margeRemise, $idTVA, $delai_livraison, $contrainteProduit, $user->id, $familiesHidden, $keywords, $type1, $type2, $type3, $code_ref);
	}
}
else
{
	$isSupplier = $user->parent == 61049 ? true : false;
	
	foreach ($pdt as $k => $v) $$k = $v;
	
	switch(strtolower($price))
	{
		case strtolower(COMMON_PRICE_TYPE_ON_DEMAND) :
			$PriceType = '1';
			$refSupplier = $price = $price2 = $unite = $idTVA = $delai_livraison = $contrainteProduit = '';
			break;
		case strtolower(COMMON_PRICE_TYPE_ON_ESTIMATE) :
			$PriceType = '2';
			$refSupplier = $price = $price2 = $unite = $idTVA = $delai_livraison = $contrainteProduit = '';
			break;
		case strtolower(COMMON_PRICE_TYPE_CONTACT_US) :
			$PriceType = '3';
			$refSupplier = $price = $price2 = $unite = $idTVA = $delai_livraison = $contrainteProduit = '';
			break;
		case 'ref' :
			$PriceType = '4';
			$refSupplier = $price = $price2 = $unite = $idTVA = '';
			break;
		default :
			$PriceType = '0';
	}
	
	if ($PriceType == '4')
	{
		$result = & $handle->query("select content from references_cols where idProduct = " . $_GET['id'], __FILE__, __LINE__);
		$data_ref = & $handle->fetch($result);
		$code_ref_tab_cols = unserialize($data_ref[0]);
		
		// si le tableau de référence est antérieur à la mise à jour du lot 3, on rajoute Référence TC au début
		if ($code_ref_tab_cols[0] != 'Référence TC') array_unshift ($code_ref_tab_cols, 'Référence TC');
		
		$result = & $handle->query("
      SELECT id, label, content, refSupplier, price, price2, unite, marge, idTVA, ecotax
      FROM references_content
      WHERE idProduct = " .$_GET['id'] . " AND vpc = 1 AND deleted = 0
      ORDER BY classement", __FILE__, __LINE__);
		while($data_ref = & $handle->fetchAssoc($result))
		{
			$data_content = unserialize($data_ref['content']);
			
			$data_ref['content'] = $data_content[0];
			for ($i = 1; $i < count($data_content); $i++)
				$data_ref['content'] .= '<->' . $data_content[$i];
			
			$code_ref_lines[] = & $data_ref;
		}
	}
	
	$tab_k = explode('|', $keywords);  $tab_k_l = count($tab_k);
    $k1 = $tab_k_l > 0 ? $tab_k[0] : '';
    $k2 = $tab_k_l > 1 ? $tab_k[1] : '';
    $k3 = $tab_k_l > 2 ? $tab_k[2] : '';
    $k4 = $tab_k_l > 3 ? $tab_k[3] : '';
    $k5 = $tab_k_l > 4 ? $tab_k[4] : '';
	
    $familiesTab    = explode(',', $familiesHidden);
    $familiesHidden = $familiesShown  = '';
	
	for($i = 0; $i < count($familiesTab); ++$i)
	{
		if(preg_match('/^[0-9]+$/', $familiesTab[$i]))
		{
			if(($result = & $handle->query('select name from families_fr where id = \'' . $handle->escape($familiesTab[$i]). '\'', __FILE__, __LINE__)) && $handle->numrows($result, __FILE__, __LINE__) == 1)
			{
				$record = & $handle->fetch($result);
				
				$familiesHidden .= $familiesTab[$i] . ',';
				
				if($familiesShown != '')
				{
					$familiesShown .= ' - ';
				}
				// code redondant avec linkFamily.php (en cas de modif ...)
				$familiesShown .= '<a href="javascript:removeFamily(\\\'' . $familiesTab[$i] . '\\\', \\\'' . to_entities(str_replace(array('"', "'", '&', '(', ')'), array(' ', ' ', '', '', ''), Utils::toASCII($record[0]))) . '\\\')">' . to_entities(str_replace(array('"', "'", '&', '(', ')'), array(' ', ' ', '', '', ''), Utils::toASCII($record[0]))) . '</a>';
			}
		}
	}
}


$next = true;

if($_SERVER['REQUEST_METHOD'] == 'POST')
{
	if($errorString == '')
	{
		if (!$go)
		{
			$out = EDIT_PRODUCT_ERROR_MAX;
		}
		elseif($ok)
		{
			$out = EDIT_PRODUCT_SUCCESS;
		}
		else
		{
			$out = EDIT_PRODUCT_ERROR;
		}
?>
<div class="centre">
	<div class="bloc">
		<div class="bloc-titre" style="text-align: center"><?php echo $out ?></div>
	</div>
</div>
<?php
		$next = false;
	}
}

if($next)
{
?>
<script type="text/javascript">
<!--

var familiesHidden = '<?php echo $familiesHidden ?>';
var familiesShown  = '<?php echo $familiesShown ?>';

function familyLink(val)
{
    if(val == '')
    {
        alert("<?php echo PRODUCT_LINK_ERRORJS_FAMILY ?>");
        document.modProduct.familiesList.focus();
        return;
    }

    if(val == 0)
    {
        alert("<?php echo PRODUCT_LINK_ERRORJS_LEVEL ?>");
        document.modProduct.familiesList.focus();
        return;
    }

    if(familiesHidden.indexOf(val + ',', 0) != -1)
    {
        alert("<?php echo PRODUCT_LINK_ERRORJS_EXIST ?>");
        document.modProduct.familiesList.focus();
        return;
    }


    document.modProduct.ok.disabled  = true;

    document.modProduct.familiesLinker.disabled = true;
    document.modProduct.familiesLinker.value = "<?php echo PRODUCT_LINK_PROCESSING ?>";
    
    /////////////
    
    var uniq = new Date();
        uniq = uniq.getTime();

    var query = '<?php echo $sid ?>&time=' + uniq + '&id=' + escape(val);

    var data  = getContent('i_linkFamily.html', query);

    if(data == -1)
    {
        alert("<?php echo PRODUCT_LINK_ERRORJS_DATA ?>");
    }
    else
    {
        var tab = data.split('<separator>');

        if(familiesHidden == '')
        {
            familiesShown = '<a href="javascript:removeFamily(\''+tab[0]+'\', \''+tab[1]+'\')">' + tab[1] + '</a>';
        }
        else
        {
            familiesShown += ' - <a href="javascript:removeFamily(\''+tab[0]+'\', \''+tab[1]+'\')">' + tab[1] + '</a>';
        }

        familiesHidden += tab[0] + ',';

        testAndWrite('families', "<?php echo PRODUCT_FAMILIES_LINKED ?> : " + familiesShown + '<input type="hidden" name="familiesHidden" value="'+familiesHidden+'">');
    }
    
    document.modProduct.ok.disabled  = false;

    document.modProduct.familiesLinker.disabled = false;
    document.modProduct.familiesLinker.value = "<?php echo PRODUCT_LINK ?>";

    document.modProduct.familiesList.focus();

}


function removeFamily(id, name)
{

    var sentence = '<a href="javascript:removeFamily\\(\\\''+id+'\\\', \\\''+name+'\\\'\\)">'+name+'</a>';

    if(familiesHidden == id + ',')
    {           
        exp = new RegExp(sentence, '');
    }
    else if(familiesHidden.indexOf(id + ',') == 0)
    {
        exp = new RegExp(sentence + ' - ', '');
    }
    else
    {
        exp = new RegExp(' - ' + sentence, '');
    }

    familiesShown = familiesShown.replace(exp, '');


    var exp = new RegExp(id + ',', '');
    familiesHidden = familiesHidden.replace(exp, '');

    testAndWrite('families', "<?php echo PRODUCT_FAMILIES_LINKED ?> : " + familiesShown + '<input type="hidden" name="familiesHidden" value="'+familiesHidden+'">');


}

function check_field(value, type_value, dftvalue)
{
	value = trim(value);
	if (value != '')
	{
		var tempvalue;
		switch (type_value)
		{
			case 'int'   : tempvalue = parseInt(value); break;
			case 'float' : tempvalue = parseFloat(value); break;
			default      : tempvalue = parseFloat(value); break;
		}

		if (isNaN(tempvalue)) return dftvalue;
		else return tempvalue;
	}
	else return '';
}

var idTVAdft = <?php echo $idTVAdftDft ?>;
var listeTVAs = new Array();
<?php
foreach ($listeTVAs as $k => $v)
{
	print("listeTVAs[" . $k . "] = new Array(3); ");
	print("listeTVAs[" . $k . "][0] = '" . $v[0] . "'; ");
	print("listeTVAs[" . $k . "][1] = '" . $v[1] . "'; ");
	print("listeTVAs[" . $k . "][2] = '" . $v[2] . "';\n");
}
?>

function displayOptionsTVA(selected, displayType)
{
	var stringOptionsTVAs = '';
	
	for (var indexTVA = 0; indexTVA < listeTVAs.length; indexTVA++)
	{
		stringOptionsTVAs += '			<option value="' + listeTVAs[indexTVA][0] + '"' + ( (listeTVAs[indexTVA][0] == selected) ? ' selected' : '' ) + '>';
		switch(displayType)
		{
			case 'all' : stringOptionsTVAs += listeTVAs[indexTVA][1] + ' ' + listeTVAs[indexTVA][2]; break;
			case 'short' : stringOptionsTVAs += listeTVAs[indexTVA][1].toLowerCase().replace(/taux\ /,'') + ' ' + listeTVAs[indexTVA][2]; break;
			case 'rate' : stringOptionsTVAs += listeTVAs[indexTVA][2]; break;
			
			default : stringOptionsTVAs += listeTVAs[indexTVA][2]; break;
		}
		stringOptionsTVAs += "%</option>\n";
	}

	return stringOptionsTVAs;
}

function getValidTVA(idTVA, idTVAdft)
{
	if (isNaN(idTVA = parseInt(idTVA))) // si taux de TVA non valide, on retourn le taux par défaut du fournisseur
		return idTVAdft;
	else // si taux de TVA valide, on vérifie qu'il existe bien
	{
		var indexTVA = 0;
		var TVAfound = false;
		for (indexTVA = 0 ; indexTVA < listeTVAs.length ; indexTVA++)
		{
			if (listeTVAs[indexTVA][0] == idTVA)
			{
				TVAfound = true;
				break;
			}
		}
		if (TVAfound) // s'il existe on le retourne
			return idTVA;
		else // sinon on retourne celui par défaut
			return idTVAdft;
	}
}

function SubmitProductChanges()
{
	if (document.modProduct.PriceType.value == '4') createRefCode();
	document.modProduct.action='product_detail.html?id=<?php echo $_GET['id'] . $eo_new_req . '&' . $sid ?>';
	document.modProduct.submit();
	document.modProduct.ok.disabled = true;
}

function PreviewProduct()
{
	if (document.modProduct.PriceType.value == '4') createRefCode();
	document.modProduct.action='pp_product.html?id=<?php echo $_GET['id'] . $eo_new_req . '&' . $sid ?>';
	document.modProduct.target='_blank';
	document.modProduct.submit()
}
//-->
</script>
<br />
<div class="centre">
<?php
if($errorString != '')
{
?>
	<div class="bloc">
		<div class="bloc-titre"><?php echo COMMON_ERROR_VALIDATE ?></div>
		<div class="bloc-texte">
			<?php echo $errorString ?>
		</div>
	</div>
	<br />
	<div class="miseAZero"></div>
	<br />
<?php
}

$eo_new_req  = '';
$eo_new_req .= isset($_GET['noimg'])  ? '&noimg'  : '';
$eo_new_req .= isset($_GET['nodoc1']) ? '&nodoc1' : '';
$eo_new_req .= isset($_GET['nodoc2']) ? '&nodoc2' : '';
$eo_new_req .= isset($_GET['nodoc3']) ? '&nodoc3' : '';


?>
	<script type="text/javascript" src="<?php echo SECURE_URL ?>manager/js/global.js"></script>
	<script type="text/javascript" src="<?php echo SECURE_URL ?>extranet/ressources/js/Classes.js"></script>
  <script type="text/javascript" src="<?php echo SECURE_RESSOURCES_URL ?>ckeditor/ckeditor.js"></script>
	<link type="text/css" href="<?php echo SECURE_URL ?>extranet/ressources/css/HN.css" rel="stylesheet"/>
<style type="text/css">
/* Family Selection Window */
#FamilySelectionWindowShad { z-index: 3; position: absolute; top: 613px; left: 25px; width: 788px; height: 404px; background-color: #000000; visibility: hidden; filter: Alpha (opacity=50, finishopacity=50, style=1) -moz-opacity:.50; opacity:.50; }
#FamilySelectionWindow { z-index: 4; position: absolute; top: 608px; left: 20px; border: 2px solid #999999; visibility: hidden; }

/* Common */
.app-form-edit-button { cursor: pointer; margin: 0 0 -3px 5px }
.app-table-add-icon { cursor: pointer; }
.field-fixed { height: 15px; padding: 0 0 0 3px; border: 1px solid #cccccc; background: #ffffff; font-size: 12px }
.fl { float: left }
.fr { float: right }
.w-100 { width: 100px }
.w-150 { width: 150px }
.w-200 { width: 200px }
.w-250 { width: 250px }
.w-300 { width: 300px }
.w-350 { width: 350px }
.w-400 { width: 400px }
.w-450 { width: 450px }
.w-500 { width: 500px }

/* Families list table */
#link-family-button { float: left; margin: 0 0 0 10px }
#linked-families { float: left; background-color: #ffffff; border-collapse: collapse; border: 1px solid #000000; font: 10px verdana, helvetica, sans-serif; }
#linked-families th { height: 17px; background-color: #f0f0f0 }
#linked-families td { height: 17px; border-style: solid; border-width: 1px 0px; border-color: #000000 }
#linked-families .family-id { width: 102px; text-align: center }
#linked-families .family-name { width: 300px; text-align: left }
#linked-families .edit { width: 24px; text-align: center }
#linked-families .edit img { cursor: pointer }
#linked-families .del { width: 24px; text-align: center }
#linked-families .del img { cursor: pointer }
#PerfReqLabel-LinkedFamilies { float: right; color: #b00000 }
</style>
	<form name="modProduct" method="post" action="product_detail.html?id=<?php echo $_GET['id'] . $eo_new_req . '&' . $sid ?>" class="formulaire" enctype="multipart/form-data">
	<div class="bloc">
		<div class="bloc-titre2"><?php echo PRODUCT_DETAIL ?></div>
		<div class="bloc-texte">
			<div class="bloc-preview"><a href="#" onClick="PreviewProduct()"><?php echo PRODUCT_SEE_ONLINE ?></a></div>
			<br />
			<div class="champ-label"><?php echo PRODUCT_NAME_LABEL ?> * :</div>
			<div class="champ-form"><input type="text" size="30" maxlength="255" name="name" onBlur="this.value = trim(this.value); maj = this.value.charAt(0).toUpperCase(); if(this.value.length > 1) this.value = maj + this.value.substring(1, this.value.length); else this.value = maj" value="<?php echo to_entities($name) ?>"></div>
			<div class="champ-aide"><?php echo PRODUCT_NAME_DESC ?></div>
			<div class="champ-miseAZero"></div>
			<br />
			<div class="champ-label"><?php echo PRODUCT_FASTDESC_LABEL ?> * :</div>
			<div class="champ-form"><input type="text" size="30" maxlength="255" name="fastdesc" onBlur="this.value = trim(this.value); maj = this.value.charAt(0).toUpperCase(); if(this.value.length > 1) this.value = maj + this.value.substring(1, this.value.length); else this.value = maj" value="<?php echo to_entities($fastdesc) ?>"></div>
			<div class="champ-aide"><?php echo PRODUCT_FASTDESC_DESC ?></div>
			<div class="champ-miseAZero"></div>
			<br />
			<div class="champ-label"><?php echo PRODUCT_KEYWORDS_LABEL ?> :</div>
			<div class="champ-form"><input type="text" size="20" name="k1" maxlength="255" value="<?php echo to_entities($k1) ?>">
				<input type="text" size="20" name="k2" maxlength="255" value="<?php echo to_entities($k2) ?>">
				<input type="text" size="20" name="k3" maxlength="255" value="<?php echo to_entities($k3) ?>">
				<input type="text" size="20" name="k4" maxlength="255" value="<?php echo to_entities($k4) ?>">
				<input type="text" size="20" name="k5" maxlength="255" value="<?php echo to_entities($k5) ?>">
			</div>
			<div class="champ-aide"><?php echo PRODUCT_KEYWORDS_DESC ?></div>
			<div class="champ-miseAZero"></div>
			<br />
			<div class="champ-label"><?php echo PRODUCT_FAMILY_LABEL ?> * :</div>
			<div class="champ-form">
				<input type="hidden" id="familiesHidden" name="familiesHidden" value="<?php echo $familiesHidden ?>">
				<div id="FamilySelectionWindow"></div>
				<table id="linked-families" cellspacing="0" cellpadding="0">
					<thead>
					<tr>
						<th class="family-id">ID(s)</th>
						<th class="family-name"><div id="PerfReqLabel-LinkedFamilies"></div>Famille(s)</th>
						<th class="edit"></th>
						<th class="del"></th>
					</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<img id="link-family-button" class="app-table-add-icon" src="<?php echo SECURE_URL ?>extranet/ressources/icons/table_add.png" onclick="PMP.fsw.Show(); PMP.fb.Build(); PMP.fb.mod='add';"/>
			</div>
			<div class="champ-aide"><?php echo PRODUCT_FAMILY_DESC ?></div>
			<div class="champ-miseAZero"></div>
			<br />
			<div class="champ-label"><?php echo PRODUCT_DESCC_LABEL ?> * :</div>
			<div class="champ-form">
        <textarea class="ckeditor" name="desc">
          <?php echo to_entities($desc) ?>
        </textarea>
			</div>
			<div class="champ-aide"><?php echo PRODUCT_DESCC_DESC ?></div>
			<div class="champ-miseAZero"></div>
			<br />
			<div class="champ-label"><?php echo PRODUCT_DESCD_LABEL ?></div>
			<div class="champ-form">
        <textarea class="ckeditor" name="descd">
          <?php echo to_entities($descd) ?>
        </textarea>
			</div>
			<div class="champ-aide"><?php echo PRODUCT_DESCD_DESC ?></div>
			<div class="champ-miseAZero"></div>
			<br />
			<div class="champ-label"><?php echo PRODUCT_IMAGE_LABEL ?> :</div>
			<div class="champ-form">
				<span class="intitule">
					<style type="text/css">
					.grey-block { clear:both; border: 1px solid #e4e4e4; background: #fcfcfc url(../ressources/images/block-bg-grey-150.gif) repeat-x }
					a.btn-red { display: block; padding: 5px; font: bold 12px arial, sans-serif; color: #ffffff; text-align: center; background: #9d0503 url(../ressources/images/dot-bg.png) repeat-x }
					a.btn-red:hover { text-decoration: underline }

					#PPSDB { z-index: 4; position: absolute; left: 25px; top: 50px; width: 500px; border: 2px solid #205683; visibility: hidden }
					#pic-selection { position: relative; }
					#box-pic-add { position: absolute;  }
					#box-pic { margin: 0; padding: 0; border: 1px solid #cccccc }
					#box-pic .pic-block { margin: 10px; cursor: pointer }
					#box-pic .pic-del { width: 50px }
					#box-pic .btn-pic-del { padding: 2px; font-size: 9px }
					#btn-add-pic { width: 160px }
					</style>
					<script type="text/javascript" src="<?php echo EXTRANET_URL ?>ressources/js/AJAXmodules.js"></script>
					<script type="text/javascript">
					if (!window.HN) HN = window.HN = {};
					if (!HN.TC) HN.TC = {};
					if (!HN.TC.BOA) HN.TC.BOA = {};
					$(function(){
						$("#btn-add-pic").click(function(){
							HN.TC.BOA.PPSDB.Show();
							return false;
						});
						HN.TC.BOA.PPSDB = new HN.Mods.DialogBox("PPSDB");
						HN.TC.BOA.PPSDB.setTitleText("Choisir une image produit (JPEG)");
						HN.TC.BOA.PPSDB.setMovable(true);
						HN.TC.BOA.PPSDB.showCancelButton(true);
						HN.TC.BOA.PPSDB.showValidButton(true);
						HN.TC.BOA.PPSDB.setValidFct(function() {
							HN.TC.BOA.refreshProductImages(<?php echo $_GET["id"] ?>);
							HN.TC.BOA.PPSDB.Hide();
						});
						//HN.TC.BOA.PPSDB.setShadow(true);
						HN.TC.BOA.PPSDB.Build();
						
						//PPB = new HN.Mods.PreviewPictureBox("PPB");
						
						HN.TC.BOA.deleteProductImage = function (pdtID) {
							var s = "";
							if (arguments.length < 2) s += "1";
							else for (var i = 1; i < arguments.length; i++) s += (i>1?",":"") + arguments[i];
							$.ajax({
								async: true,
								cache: false,
								data: "action=delpics&pdtID="+pdtID+"&num="+s,
								dataType: "json",
								error: function (XMLHttpRequest, textStatus, errorThrown) { alert("Fatal error while loading Products Data"); },
								success: function (data, textStatus) {
									if (data.pdtID)
										HN.TC.BOA.refreshProductImages(data.pdtID);
								},
								type: "GET",
								url: "AJAX_pdt-edition.php"
							});
						};
						
						HN.TC.BOA.refreshProductImages = function (pdtID) {
							$.ajax({
								async: true,
								cache: false,
								data: "action=getpics&pdtID="+pdtID,
								dataType: "json",
								error: function (XMLHttpRequest, textStatus, errorThrown) { alert("Fatal error while loading Products Data"); },
								success: function (data, textStatus) {
									var tr = document.createElement("tr");
									for (var i = 0; i < data.pics.length; i++) {
										var td = document.createElement("td");
										var div = document.createElement("div");
										div.className = "pic-block";
										div.srcZoom = data.pics[i].zoom+"?t="+(new Date).getTime();;
										td.appendChild(div);
											var img = document.createElement("img");
											img.src = data.pics[i].thumb_big+"?t="+(new Date).getTime();
											img.alt = "";
											img.onclick = function(){ alert(this.parentNode.srcZoom); /*PPB.show(data.pics[i].zoom); */};
											div.appendChild(img);
											var a = document.createElement("a");
											a.setAttribute("href", "#"+data.pdtID+"-"+data.pics[i].num);
											a.className = "btn-red btn-pic-del";
											a.innerHTML = "supprimer";
											a.onclick = function(){
												var parts = this.getAttribute("href").split("-");
												var pdtID = parts[0].substr(1, this.href.length);
												var num = parts[1];
												HN.TC.BOA.deleteProductImage(pdtID, num);
												return false;
											};
											div.appendChild(a);
										
										tr.appendChild(td);
									}
									$("#box-pic tbody").empty().get(0).appendChild(tr);
								},
								type: "GET",
								url: "AJAX_pdt-edition.php"
							});
						};
						HN.TC.BOA.refreshProductImages(<?php echo $_GET["id"] ?>);
					});
					</script>
					<div id="pic-selection">
						<div id="PPSDB">
							<iframe src="<?php echo EXTRANET_URL ?>product-pic.php?id=<?php echo $_GET["id"] ?>" width="100%" frameborder="0" height="80"></iframe>
						</div>
						<div class="intitule">Images produits : seules les 3 premières seront affichées en Front office</div>
						<table id="box-pic" class="grey-block" cellspacing="0" cellpadding="0"><tbody></tbody></table>
						<a href="#" class="btn-red" id="btn-add-pic">Ajouter une image produit</a>
					</div>
				</span>
			</div>
			<div class="champ-aide"><?php echo PRODUCT_IMAGE_DESC ?></div>
			<div class="champ-miseAZero"></div>
			<br />
			<div class="champ-label"><?php echo PRODUCT_DOC_LABEL ?> 1 :</div>
			<div class="champ-form">
				<input type="file" name="doc1" size="40">
				<select name="type1">
					<option value=".doc" selected>DOC</option>
					<option value=".pdf">PDF</option>
				</select>
				<?php if(!isset($_GET['nodoc1']) && (is_file(PRODUCTS_FILES_INC . $_GET['id'] . '-1.doc') || is_file(PRODUCTS_FILES_INC . $_GET['id'] . '-1.pdf'))){ $ext = is_file(PRODUCTS_FILES_INC . $_GET['id'] . '-1.doc') ? 'doc' : 'pdf'; print('[<a href="' . PRODUCTS_FILES_URL . $_GET['id'] . '-1.' . $ext . '" target="_blank">Voir</a>] [<a href="product_detail.html?' . session_name() . '=' . session_id() . '&id=' . $_GET['id'] . $eo_new_req . '&nodoc1">Supprimer</a>]'); } ?>
			</div>
			<div class="champ-aide"><?php echo PRODUCT_DOC_DESC ?></div>
			<div class="champ-miseAZero"></div>
			<br />
			<div class="champ-label"><?php echo PRODUCT_DOC_LABEL ?> 2 :</div>
			<div class="champ-form">
				<input type="file" name="doc2" size="40">
				<select name="type2">
					<option value=".doc" selected>DOC</option>
					<option value=".pdf">PDF</option>
				</select>
				<?php if(!isset($_GET['nodoc2']) && (is_file(PRODUCTS_FILES_INC . $_GET['id'] . '-2.doc') || is_file(PRODUCTS_FILES_INC . $_GET['id'] . '-2.pdf'))){ $ext = is_file(PRODUCTS_FILES_INC . $_GET['id'] . '-2.doc') ? 'doc' : 'pdf'; print('[<a href="' . PRODUCTS_FILES_URL . $_GET['id'] . '-2.' . $ext . '" target="_blank">Voir</a>] [<a href="product_detail.html?' . session_name() . '=' . session_id() . '&id=' . $_GET['id'] . $eo_new_req . '&nodoc2">Supprimer</a>]'); } ?>
			</div>
			<div class="champ-aide"><?php echo PRODUCT_DOC_DESC ?></div>
			<div class="champ-miseAZero"></div>
			<br />
			<div class="bloc-preview"><a href="#" onClick="PreviewProduct()"><?php echo PRODUCT_SEE_ONLINE ?></a></div>
			<div class="champ-label"><?php echo PRODUCT_DOC_LABEL ?> 3 : </div>
			<div class="champ-form">
				<input type="file" name="doc3" size="40">
				<select name="type3">
					<option value=".doc" selected>DOC</option>
					<option value=".pdf">PDF</option>
				</select>
				<?php if(!isset($_GET['nodoc3']) && (is_file(PRODUCTS_FILES_INC . $_GET['id'] . '-3.doc') || is_file(PRODUCTS_FILES_INC . $_GET['id'] . '-3.pdf'))){ $ext = is_file(PRODUCTS_FILES_INC . $_GET['id'] . '-3.doc') ? 'doc' : 'pdf'; print('[<a href="' . PRODUCTS_FILES_URL . $_GET['id'] . '-3.' . $ext . '" target="_blank">Voir</a>] [<a href="product_detail.html?' . session_name() . '=' . session_id() . '&id=' . $_GET['id'] . $eo_new_req . '&nodoc3">Supprimer</a>]'); } ?>
			</div>
			<div class="champ-aide"><?php echo PRODUCT_DOC_DESC ?></div>
			<div class="champ-miseAZero"></div>
<?php
if ($isSupplier)
{
?>
<script type="text/javascript">
var price  = "<?php echo to_entities($price) ?>";
var price2 = "<?php echo to_entities($price2) ?>";
var prixPublic = <?php echo $user->prixPublic != 0 ? 'true' : 'false' ?>;

function ChangePriceType(value)
{
	var PriceData = document.getElementById('PriceData');
	if (value == '0')
	{
		if (prixPublic)
			PriceData.innerHTML = '<input id="price" type="text" size="30" maxlength="255" name="price" onBlur="this.value = trim(this.value);" value="' + price + '">';
		else
			PriceData.innerHTML = '<input id="price2" type="text" size="30" maxlength="255" name="price2" onBlur="this.value = trim(this.value);" value="' + price2 + '">';
		hideRef();
		document.getElementById('SimplePriceFields').style.display = 'inline';
		document.getElementById('PriceRefFields').style.display = 'inline';
		document.getElementById('PriceHelp').innerHTML = prixPublic ? "<?php echo PRODUCT_SUP_PUBLIC_PRICE_HELP ?>" : "<?php echo PRODUCT_SUP_BUY_PRICE_HELP ?>";
	}
	else if (value == '4')
	{
		PriceData.innerHTML = '<div id="menu"></div><div id="references"></div><div id="refcode"></div>'
		displayRef();
		document.getElementById('SimplePriceFields').style.display = 'none';
		document.getElementById('PriceRefFields').style.display = 'inline';
		document.getElementById('PriceHelp').innerHTML = prixPublic ? "<?php echo PRODUCT_SUP_PUBLIC_REF_HELP ?>" : "<?php echo PRODUCT_SUP_BUY_REF_HELP ?>";
	}
	else
	{
		PriceData.innerHTML = '';
		hideRef();
		document.getElementById('SimplePriceFields').style.display = 'none';
		document.getElementById('PriceRefFields').style.display = 'none';
		document.getElementById('PriceHelp').innerHTML = "<?php echo PRODUCT_SUP_CONTACT_HELP ?>";
	}
}

<?php
	if ($PriceType == '4')
	{
		// on part du principe que le tableau est forcément valide et celui d'un fournisseur si les données ne viennent pas d'un POST
		$post = $_SERVER['REQUEST_METHOD'] == 'POST';
		
		function replaceTokens(& $value)
		{
			return str_replace(array("\\", "'", chr(10), chr(13)), array("\\\\", "\'", '', ''), $value);
		}
		
		$nbcols = count($code_ref_tab_cols);
		$lastusercol = $nbcols - ($post ? 5 : 7);
		print "var refCols = new Array('Référence TC','Libellé','Référence',";
		for ($i = 3; $i <= $lastusercol; $i++) print "'" . replaceTokens($code_ref_tab_cols[$i]) . "',";
		print "'Unité','Taux TVA','Prix','Éco Taxe');\n";
		
    print "var refRows = new Array(" . count($code_ref_lines) . ");\n";
		for($i = 0; $i < count($code_ref_lines); ++$i)
		{
			$code_ref_line = & $code_ref_lines[$i];
			
			print "refRows[" . $i . "] = new Array(";
			
			print "'" . replaceTokens($code_ref_line['id']) . "',";
			print "'" . replaceTokens($code_ref_line['label']) . "',";
			print "'" . replaceTokens($code_ref_line['refSupplier']) . "',";
			
			if (isset($code_ref_line['content']))
			{
				$line_content = explode('<->', $code_ref_line['content']);
				for ($j = 0; $j < count($line_content); $j++)
					print "'" . replaceTokens($line_content[$j]) . "',";
			}
			
			print "'" . replaceTokens($code_ref_line['unite']) . "',";
			print "'" . replaceTokens($code_ref_line['idTVA']) . "',";
			if (!$post && $user->prixPublic == 0)
        print "'" . replaceTokens($code_ref_line['price2']) . "',";
			else
        print "'" . replaceTokens($code_ref_line['price']) . "',";
			print "'" . replaceTokens($code_ref_line['ecotax']) . "'";
			
			print ");\n";
		}
	}
	else
	{
?>
//var refCols = new Array('Référence TC', 'Libellé', 'Référence Fournisseur', 'Unité', 'Taux TVA', 'Prix Fournisseur', 'Marge', 'Prix Public');	
var refCols = new Array('Référence TC', 'Libellé', 'Référence', '', 'Unité', 'Taux TVA', 'Prix', 'Éco Taxe');
var refRows = new Array();

<?php
	}
?>
</script>
<script type="text/javascript" src="refs.js"></script>
			<br />
			<div class="champ-label"><?php echo PRODUCT_PRICE_TYPE_LABEL ?> :</div>
			<div class="champ-form">
				<select name="PriceType" onChange="ChangePriceType(this.value)">
					<option value="1"<?php echo $PriceType == '1' ? ' selected' : ''?>><?php echo COMMON_PRICE_TYPE_ON_DEMAND  ?></option>
					<option value="2"<?php echo $PriceType == '2' ? ' selected' : ''?>><?php echo COMMON_PRICE_TYPE_ON_ESTIMATE  ?></option>
					<option value="3"<?php echo $PriceType == '3' ? ' selected' : ''?>><?php echo COMMON_PRICE_TYPE_CONTACT_US  ?></option>
					<option value="4"<?php echo $PriceType == '4' ? ' selected' : ''?>><?php echo COMMON_PRICE_TYPE_REFS  ?></option>
					<option value="0"<?php echo $PriceType == '0' ? ' selected' : ''?>><?php echo COMMON_PRICE_TYPE_SIMPLE_PRICE  ?></option>
				</select>
				<div id="PriceData"></div>
			</div>
			<div style="clear: both"></div>
			<div id="PriceHelp" class="champ-aide"></div>
			<div class="champ-miseAZero"></div>
			<br />
			<div id="SimplePriceFields">
				<div class="champ-label"><?php echo PRODUCT_REFSUPPLIER_LABEL ?> * :</div>
				<div class="champ-form"><input type="text" size="30" maxlength="255" name="refSupplier" onBlur="this.value = trim(this.value);" value="<?php echo to_entities($refSupplier) ?>"></div>
				<div class="champ-aide"><?php echo PRODUCT_REFSUPPLIER_DESC ?></div>
				<div class="champ-miseAZero"></div>
				<br />
				<div class="champ-label"><?php echo PRODUCT_UNIT_LABEL ?> :</div>
				<div class="champ-form"><input type="text" size="30" maxlength="255" name="unite" onBlur="this.value = check_field(this.value, 'int', 1);" value="<?php echo to_entities($unite) ?>"></div>
				<div class="champ-aide"><?php echo PRODUCT_UNIT_DESC ?></div>
				<div class="champ-miseAZero"></div>
				<br />
				<div class="champ-label"><?php echo PRODUCT_VAT_LABEL ?> * :</div>
				<div class="champ-form">
					<select name="idTVA">
<?php
	foreach ($listeTVAs as $v)
		print '						<option value="' . $v[0] . '"' . (($idTVA == $v[0]) ? ' selected' : '') . '>' . $v[1] . ' ' . $v[2] . "%</option>\n";
?>					</select>
				</div>
				<div class="champ-aide"><?php echo PRODUCT_VAT_DESC ?></div>
				<div class="champ-miseAZero"></div>
				<br />
			</div>
			<div id="PriceRefFields">
				<div class="champ-label"><?php echo PRODUCT_DELIVERY_TIME_LABEL ?> :</div>
				<div class="champ-form"><input type="text" size="30" maxlength="255" name="delai_livraison" onBlur="this.value = trim(this.value);" value="<?php echo to_entities($delai_livraison) ?>"></div>
				<div class="champ-aide"><?php echo PRODUCT_DELIVERY_TIME_DESC ?> : <i><?php echo $user->delai_livraison ?></i>.</div>
				<div class="champ-miseAZero"></div>
				<br />
				<div class="bloc-preview"><a href="#" onClick="PreviewProduct()"><?php echo PRODUCT_SEE_ONLINE ?></a></div>
				<div class="champ-label"><?php echo PRODUCT_CONSTRAINT_LABEL ?> :</div>
				<div class="champ-form"><input type="text" size="30" maxlength="255" name="contrainteProduit" onBlur="this.value = check_field(this.value, 'int', 0);" value="<?php echo to_entities($contrainteProduit) ?>"></div>
				<div class="champ-aide"><?php echo PRODUCT_CONSTRAINT_DESC ?></div>
				<div class="champ-miseAZero"></div>
				<br />
			</div>
<script type="text/javascript">
ChangePriceType('<?php echo $PriceType ?>')
</script>
<?php
}
else
{
?>
<script type="text/javascript">
var price = "<?php echo to_entities($price) ?>";

function ChangePriceType(value)
{
	var PriceData = document.getElementById('PriceData');
	if (value == '0')
	{
		PriceData.innerHTML = '<input id="price" type="text" size="30" maxlength="255" name="price" onBlur="this.value = trim(this.value);" value="' + price + '">';
		hideRef();
		document.getElementById('PriceHelp').innerHTML = "<?php echo PRODUCT_ADV_PRICE_HELP ?>";
	}
	else if (value == '4')
	{
		PriceData.innerHTML = '<div id="menu"></div><div id="references"></div><div id="refcode"></div>'
		displayRef();
		document.getElementById('PriceHelp').innerHTML = "<?php echo PRODUCT_ADV_REF_HELP ?>";
	}
	else
	{
		PriceData.innerHTML = '';
		hideRef();
		document.getElementById('PriceHelp').innerHTML = "<?php echo PRODUCT_ADV_CONTACT_HELP ?>";
	}
}

<?php
	if ($PriceType == '4')
	{
		function replaceTokens(& $value)
		{
			return str_replace(array("\\", "'", chr(10), chr(13)), array("\\\\", "\'", '', ''), $value);
		}
		
		$nbcols = count($code_ref_tab_cols);
		print "var refCols = new Array('Référence TC','Libellé',";
		for ($i = 2; $i < $nbcols-1; $i++) print "'" . replaceTokens($code_ref_tab_cols[$i]) . "',";
		print "'Prix');\n";
		
	    print "var refRows = new Array(" . count($code_ref_lines) . ");\n";
		for($i = 0; $i < count($code_ref_lines); ++$i)
		{
			$code_ref_line = & $code_ref_lines[$i];
			
			print "refRows[" . $i . "] = new Array(";
			
			print "'" . replaceTokens($code_ref_line['id']) . "',";
			print "'" . replaceTokens($code_ref_line['label']) . "',";
			
			if (isset($code_ref_line['content']))
			{
				$line_content = explode('<->', $code_ref_line['content']);
				for ($j = 0; $j < count($line_content); $j++)
					print "'" . replaceTokens($line_content[$j]) . "',";
			}
			print "'" . replaceTokens($code_ref_line['price']) . "'";
			
			print ");\n";
		}
	}
	else
	{
?>
//var refCols = new Array('Référence TC', 'Libellé', 'Référence Fournisseur', 'Unité', 'Taux TVA', 'Prix Fournisseur', 'Marge', 'Prix Public');	
var refCols = new Array('Référence TC', 'Libellé', '', 'Prix');
var refRows = new Array();

<?php
	}
?>
</script>
<script type="text/javascript" src="refs_annonceurs.js"></script>
			<br />
			<div class="champ-label"><?php echo PRODUCT_PRICE_TYPE_LABEL ?> :</div>
			<div class="champ-form">
				<select name="PriceType" onChange="ChangePriceType(this.value)">
					<option value="1"<?php echo $PriceType == '1' ? ' selected' : ''?>><?php echo COMMON_PRICE_TYPE_ON_DEMAND  ?></option>
					<option value="2"<?php echo $PriceType == '2' ? ' selected' : ''?>><?php echo COMMON_PRICE_TYPE_ON_ESTIMATE  ?></option>
					<option value="3"<?php echo $PriceType == '3' ? ' selected' : ''?>><?php echo COMMON_PRICE_TYPE_CONTACT_US  ?></option>
					<option value="4"<?php echo $PriceType == '4' ? ' selected' : ''?>><?php echo COMMON_PRICE_TYPE_REFS  ?></option>
					<option value="0"<?php echo $PriceType == '0' ? ' selected' : ''?>><?php echo COMMON_PRICE_TYPE_SIMPLE_PRICE  ?></option>
				</select>
				<div id="PriceData"></div>
			</div>
			<div style="clear: both"></div>
			<div id="PriceHelp" class="champ-aide"></div>
			<div class="champ-miseAZero"></div>
			<br />
<script type="text/javascript">
ChangePriceType('<?php echo $PriceType ?>')
</script>
<?php
}
?>
		</div>
	</div>
	<br />
	<div class="bloc">
		<div align="center">
			<br />
			<div class="champ-valid"><input type="button" name="ok" value="<?php echo EDIT_PRODUCT_SUBMIT ?>" onClick="SubmitProductChanges()"></div>
			<div class="bloc-texte"><?php echo PRODUCT_BOTTOM_NOTE ?></div>
		</div>
	</div>
</div>

<script type="text/javascript">
// FAMILIES //
<?php
$families = array();
$families[0]['name'] = '';
$families[0]['ref_name'] = '';
$families[0]['idParent'] = 0;

$result = & $handle->query("select f.id, fr.name, fr.ref_name, f.idParent from families f, families_fr fr where f.id = fr.id", __FILE__, __LINE__);
while ($family = & $handle->fetchAssoc($result))
{
	$families[$family['id']]['name'] = $family['name'];
	$families[$family['id']]['ref_name'] = $family['ref_name'];
	$families[$family['id']]['idParent'] = $family['idParent'];
	if (!isset($families[$family['idParent']]['nbchildren']))
		$families[$family['idParent']]['nbchildren'] = 1;
	else
		$families[$family['idParent']]['nbchildren']++;
	$families[$family['idParent']]['children'][$families[$family['idParent']]['nbchildren']-1] = $family['id'];
}

?>
// TODO intégrer le get des familles en ajax dans l'objet FamiliesBrowser
var families = [];
var familiesIndexByName = [];
var familiesIndexByRefName = [];
var name = 0; var ref_name = 1; var idParent = 2; var nbchildren = 3; var children = 4;

function fam_sort_ref_name(a, b)
{
	if (families[a][ref_name] > families[b][ref_name]) return 1;
	if (families[a][ref_name] < families[b][ref_name]) return -1;
	return 0;
}

<?php
foreach ($families as $id => $fam)
{
	print 'families[' . $id . '] = ["' . str_replace('"', '\"', $fam['name']) . '", "' . $fam['ref_name'] . '", ' . $fam['idParent'] . ', ';
	if (isset($fam['nbchildren']))
	{
		print $fam['nbchildren'] . ', [' . $fam['children'][0];
		for ($i = 1; $i < $fam['nbchildren']; $i++)
			print ", " . $fam['children'][$i];
		print "]";
	}
	else
	{
		print "0, []";
	}
	print  ']; ';
	//print 'familiesIndexById[' . $id . '] = ' . $id . '; ';
	print 'familiesIndexByName["' . str_replace('"', '\"', $fam['name']) . '"] = ' . $id . '; ';
	print 'familiesIndexByRefName["' . $fam['ref_name'] . '"] = ' . $id . ';';
	print "\n";
}
?>

// Product's main properties (namespace)
var PMP = {};

/* Family selection window */
PMP.fb = new HN.FamiliesBrowser();
PMP.fb.setID("FamilySelectionWindow");
PMP.fb.Build();
PMP.fb.mod = "add";

PMP.fsw = new HN.Window();
PMP.fsw.setID("FamilySelectionWindow");
PMP.fsw.setTitleText("Choisir une famille");
PMP.fsw.setMovable(true);
PMP.fsw.showCancelButton(true);
PMP.fsw.showValidButton(true);
PMP.fsw.setValidFct(function() {
	var family = PMP.fb.getCurFam();
	if (family.id != 0)
	{
		/*var as = "action=" + PMP.fb.mod;
		as += "&productID=<?php echo $_GET['id'] ?>";
		as += "&familyID=" + family.id;
		if (PMP.fb.mod == "update") as += "&oldfamilyID=" + PMP.fb.oldfamilyid;
		PMP.Family.AJAXHandle.data = as;
		$.ajax(PMP.Family.AJAXHandle);*/
		
		var data = familiesHidden.split(",");
		familiesHidden = "";
		var id = parseInt(family.id);
		if (PMP.fb.mod == "add")
		{
			for (i = 0; i < data.length-1; i++) {
				if (parseInt(data[i]) != id) familiesHidden += data[i] + ",";
			}
			familiesHidden += id + ",";
		}
		else if (PMP.fb.mod == "update")
		{
			for (i = 0; i < data.length-1; i++)
				if (parseInt(data[i]) == PMP.fb.oldfamilyid) familiesHidden += id + ",";
				else familiesHidden += data[i] + ",";
		}
		PMP.Family.fillTable();
		PMP.fsw.Hide();
	}
});
PMP.fsw.setShadow(true);
PMP.fsw.Build();

// Family namespace
PMP.Family = {};
/*
PMP.Family.AJAXHandle = {
	type : "GET",
	url: "AJAX-JSON-LinkedFamilies.php",
	dataType: "json",
	error: function (XMLHttpRequest, textStatus, errorThrown) {
		$("#PerfReqLabel-LinkedFamilies").text(textStatus);
	},
	success: function (data, textStatus) {
		if (data.error) $("#PerfReqLabel-LinkedFamilies").text(data.error);
		else
		{
			var tbody = $("#linked-families tbody");
			tbody.empty();
			familiesHidden = "";
			for (i = 0; i < data.length; i++)
			{
				tbody.append(
					"<tr id=\"linked-family-"+data[i].id+"\">" +
					"	<td class=\"family-id\">"+data[i].id+"</td>" +
					"	<td class=\"family-name\">"+data[i].name+"</td>" +
					"	<td class=\"edit\">" + "<img src=\"<?php echo ADMIN_URL ?>ressources/icons/table_edit.png\" alt=\"editer\" title=\"editer\" onclick=\"PMP.Family.UpdateLinkedFamily("+data[i].id+")\"/></td>" +
					"	<td class=\"del\">" + "<img src=\"<?php echo ADMIN_URL ?>ressources/icons/table_delete.png\" alt=\"supprimer\" title=\"supprimer\" onclick=\"PMP.Family.DeleteLinkedFamily("+data[i].id+")\"/></td>" +
					"</tr>");
					familiesHidden += data[i].id + ",";
			}
			$("#PerfReqLabel-LinkedFamilies").text("");
			$("#families input").val(familiesHidden);
		}
	}
};

PMP.Family.GetLinkedFamilies = function() {
	PMP.Family.AJAXHandle.data = "action=get&productID=<?php echo $_GET['id'] ?>";
	$.ajax(PMP.Family.AJAXHandle);
}
*/
PMP.Family.UpdateLinkedFamily = function(id) {
	PMP.fb.mod = "update";
	PMP.fb.oldfamilyid = id;
	PMP.fb.SelectFamByID(id);
	PMP.fsw.Show();
}
PMP.Family.DeleteLinkedFamily = function(id) {
	if (document.getElementById("linked-family-"+id))
	{
		var data = familiesHidden.split(",");
		familiesHidden = "";
		id = parseInt(id);
		for (i = 0; i < data.length-1; i++)
			if (parseInt(data[i]) != id) familiesHidden += data[i] + ",";
		
		PMP.Family.fillTable();
		//PMP.Family.AJAXHandle.data = "action=delete&productID=<?php echo $_GET['id'] ?>&familyID="+id;
		//$.ajax(PMP.Family.AJAXHandle);
	}
}

PMP.Family.fillTable = function() {
	var data = familiesHidden.split(",");
	var tbody = $("#linked-families tbody");
	tbody.empty();
	for (i = 0; i < data.length-1; i++)
	{
		data[i] = parseInt(data[i]);
		tbody.append(
			"<tr id=\"linked-family-"+data[i]+"\">" +
			"	<td class=\"family-id\">"+data[i]+"</td>" +
			"	<td class=\"family-name\">"+families[data[i]][name]+"</td>" +
			"	<td class=\"edit\">" + "<img src=\"<?php echo ADMIN_URL ?>ressources/icons/table_edit.png\" alt=\"editer\" title=\"editer\" onclick=\"PMP.Family.UpdateLinkedFamily("+data[i]+")\"/></td>" +
			"	<td class=\"del\">" + "<img src=\"<?php echo ADMIN_URL ?>ressources/icons/table_delete.png\" alt=\"supprimer\" title=\"supprimer\" onclick=\"PMP.Family.DeleteLinkedFamily("+data[i]+")\"/></td>" +
			"</tr>");
	}
	$("#PerfReqLabel-LinkedFamilies").text("");
	$("#familiesHidden").val(familiesHidden);
}

//PMP.Family.GetLinkedFamilies();
PMP.Family.fillTable();

<?php if ($price == 'ref') { ?>
ShowRefTab();
<?php } ?>
</script>

<?php
}  // fin next

} // fin id ok

require(EXTRANET . 'tail.php');

?>