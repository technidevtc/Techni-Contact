<?php
require_once substr(dirname(__FILE__),0,strpos(dirname(__FILE__),'/',stripos(dirname(__FILE__),'technico')+1)+1).'config.php';
//require(SITE.'misc-send-request.php');
require(ADMIN.'generator.php');

$handle = DBHandle::get_instance();
$db = DBHandle::get_instance();

include(LANG_LOCAL_INC."includes-".DB_LANGUAGE."_local.php");
include(LANG_LOCAL_INC."www-".DB_LANGUAGE."_local.php");
include(LANG_LOCAL_INC."common-".DB_LANGUAGE."_local.php");
include(LANG_LOCAL_INC."infos-".DB_LANGUAGE."_local.php");
define("FORM_PERSONNAL_INFOS_WARNING", "Merci de ne pas faire apparaitre vos coordonnées personnelles dans cette zone.");

// default lead type is 3 since v3
//$lead_type = 3;
$page_title = $lead_type_string = "Augmentez votre chiffre d'affaires en présentant vos produits";
//
//$lead_pdtID = isset($_POST["pdtID"]) ? $_POST["pdtID"] : (isset($_GET["pdtID"]) ? $_GET["pdtID"] : "2847135");
//$lead_catID = isset($_POST["catID"]) ? $_POST["catID"] : (isset($_GET["catID"]) ? $_GET["catID"] : "51");
//if (!preg_match('/^[1-4]$/', $lead_type) || !($pdt = loadProduct($lead_pdtID, $lead_catID))) {
//  header("Location: ".URL."404.php");
//  exit();
//}


////////////////////////////////////////////////////////////////////////////////


// Var telling us if the user tried to validate from this same page
$valid_form = $_SERVER["REQUEST_METHOD"] == 'POST' && isset($_POST["nom"]);

// Arrays for customers and errors information
$error = $infos = array();

if ($valid_form) { // User validate the form
  ////////////////////////////////////////////////////////////////////////////////
  // Checking User infos validity
  ////////////////////////////////////////////////////////////////////////////////

  mb_convert_variables("ISO-8859-1","UTF-8",$_POST);

  $infos["nom"] = isset($_POST["nom"]) ? substr(trim($_POST["nom"]), 0, 255) : '';
  $infos["prenom"] = isset($_POST["prenom"]) ? substr(trim($_POST["prenom"]), 0, 255) : '';
  $infos["societe"] = isset($_POST["societe"]) ? substr(trim($_POST["societe"]), 0, 255) : '';
  $infos["fonction"] = isset($_POST["fonction"]) ? substr(trim($_POST["fonction"]), 0, 255) : '';
  $infos["salaries"] = isset($_POST["salaries"]) ? substr(trim($_POST["salaries"]), 0, 255) : '';
  $infos["secteur"] = isset($_POST["secteur"]) ? substr(trim($_POST["secteur"]), 0, 255) : '';
  $infos["naf"] = isset($_POST["naf"]) ? substr(trim($_POST["naf"]), 0, 255) : '';
  $infos["siret"] = isset($_POST["siret"]) ? substr(trim($_POST["siret"]), 0, 255) : '';
  $infos["adresse"] = isset($_POST["adresse"]) ? substr(trim($_POST["adresse"]), 0, 255) : '';
  $infos["cadresse"] = isset($_POST["cadresse"]) ? substr(trim($_POST["cadresse"]), 0, 255) : '';
  $infos["cp"] = isset($_POST["cp"]) ? substr(trim($_POST["cp"]), 0, 255) : '';
  $infos["ville"] = isset($_POST["ville"]) ? substr(trim($_POST["ville"]), 0, 255) : '';
  $infos["pays"] = isset($_POST["pays"]) ? substr(trim($_POST["pays"]), 0, 255) : '';
  $infos["telephone"] = isset($_POST["telephone"]) ? substr(trim($_POST["telephone"]), 0, 255) : '';
  $infos["produits"] = isset($_POST["produits"]) ? trim($_POST["produits"]) : '';
  $infos["fax"] = isset($_POST["fax"]) ? substr(trim($_POST["fax"]),   0, 255) : '';
  $infos["email"] = isset($_POST["email"]) ? substr(trim($_POST["email"]), 0, 255) : '';
  //$infos["infos_sup"] = isset($_POST["infos_sup"]) ?	substr(trim($_POST["infos_sup"]), 0, 2047) : '';
  $infos["url"] = isset($_POST["url"]) ? substr(trim($_POST["url"]), 0, 255) : '';
  $infos["precisions"] = isset($_POST["precisions"]) ?	substr(trim($_POST["precisions"]), 0, 2047) : '';
  if ($infos["precisions"] == FORM_PERSONNAL_INFOS_WARNING) $infos["precisions"] = "";

  // Always required fields
  if (empty($infos["nom"])) $error["nom"] = true;
  else setCookie('nom', htmlentities($infos["nom"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (empty($infos["prenom"])) $error["prenom"] = true;
  else setCookie('prenom', htmlentities($infos["prenom"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (empty($infos["telephone"])) $error["telephone"] = true;
  else setCookie('telephone', htmlentities($infos["telephone"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (!preg_match('`^[[:alnum:]]([-_.]?[[:alnum:]])*@[[:alnum:]]([-_.]?[[:alnum:]])*\.([a-z]{2,4})$`', $infos["email"])) $error["email"] = true;
  else setCookie('email', htmlentities($infos["email"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  // Fields that may be required
  if (empty($infos["fonction"]) && !isset($notReqFields["fonction"])) $error["fonction"] = true;
  else setCookie('fonction', htmlentities($infos["fonction"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (empty($infos["societe"]) && !isset($notReqFields["societe"])) $error["societe"] = true;
  else setCookie('societe', htmlentities($infos["societe"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (empty($infos["adresse"]) && !isset($notReqFields["nb_salaries"])) $error["adresse"] = true;
  else setCookie('adresse', htmlentities($infos["adresse"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (empty($infos["cp"]) && !isset($notReqFields["cp"])) $error["cp"] = true;
  else setCookie('cp', htmlentities($infos["cp"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (empty($infos["ville"]) && !isset($notReqFields["ville"])) $error["ville"] = true;
  else setCookie('ville', htmlentities($infos["ville"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (empty($infos["pays"]) && !isset($notReqFields["pays"])) $error["pays"] = true;
  else setCookie('pays', htmlentities($infos["pays"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (empty($infos["salaries"]) && !isset($notReqFields["nb_salaries"])) $error["salaries"] = true;
  else setCookie('salaries', htmlentities($infos["salaries"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (empty($infos["secteur"]) && !isset($notReqFields["secteur_activite"])) $error["secteur"] = true;
  else setCookie('secteur', htmlentities($infos["secteur"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  // never required fields
  setCookie('fax', htmlentities($infos["fax"]), time() + 24 * 3600 * 365, '/', DOMAIN);
  setCookie('naf', htmlentities($infos["naf"]), time() + 24 * 3600 * 365, '/', DOMAIN);
  setCookie('siret', htmlentities($infos["siret"]), time() + 24 * 3600 * 365, '/', DOMAIN);
  setCookie('cadresse', htmlentities($infos["cadresse"]), time() + 24 * 3600 * 365, '/', DOMAIN);
  //setCookie('infos_sup', htmlentities($infos["infos_sup"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  if (!empty($infos["url"])) {
    if (!preg_match('/^((http|https|ftp):\/\/)?(([A-Z0-9][A-Z0-9_-]*)(\.[A-Z0-9][A-Z0-9_-]*)+)(:(\d+))?\/?$/i', $infos["url"]))
      $error["url"] = true;
    else {
      if (!preg_match('/^(http|https|ftp):\/\//i', $infos["url"])) $infos["url"] = 'http://'.$infos["url"];
      if (strrpos($infos["url"] , '/') != strlen($infos["url"])-1) $infos["url"] .= '/';
      setCookie('url', htmlentities($infos["url"]), time() + 24 * 3600 * 365, '/', DOMAIN);
    }
  }
  else setCookie('url', htmlentities($infos["url"]), time() + 24 * 3600 * 365, '/', DOMAIN);

  // Custom Fields
  for ($i = 0; $i < $cf_count; $i++) {
    $cf = &$customFields[$i];

    $cf_value = trim($_POST[$cf["name"]]);
    $cf["length"] = (int)$cf["length"];
    if ($cf["length"] > 0) $cf_value = substr($cf_value, 0, $cf["length"]);
    $valueList = explode(",", $cf["valueList"]);
    if ($cf["type"] == "select" && !in_array($cf_value, $valueList)) $error[$cf["name"]] = true;
    if (!empty($cf_value)) {
      switch ($cf["validationType"]) {
        case "integer":
          if (!preg_match('`^[0-9]+$`', $cf_value))
            $error[$cf["name"]] = true;
          break;
        case "date":
          if (!preg_match('`^[0-3]?[0-9]{1})(\/|-|\s)[0-2]?[0-9]{1}(\/|-|\s)[0-9]{4,4}$`', $cf_value))
            $error[$cf["name"]] = true;
          break;
        case "email":
          if (!preg_match('`^[[:alnum:]]([-_.]?[[:alnum:]])*@[[:alnum:]]([-_.]?[[:alnum:]])*\.([a-z]{2,4})$`', $cf_value))
            $error[$cf["name"]] = true;
          break;
        case "url":
          if (!preg_match('/^((http|https|ftp):\/\/)?(([A-Z0-9][A-Z0-9_-]*)(\.[A-Z0-9][A-Z0-9_-]*)+)(:(\d+))?\/?$/i', $cf_value))
            $error[$cf["name"]] = true;
          break;
        default: break;
      }
    }
    elseif ($cf["required"])
      $error[$cf["name"]] = true;

    $cfv[$cf["name"]] = $cf_value;
  }

  ////////////////////////////////////////////////////////////////////////////////
  // Requests processing
  ////////////////////////////////////////////////////////////////////////////////

  if ( empty($error) && !isset($_POST["onlyCheck"]) ) {
//    require(ICLASS.'_ClassEmail.php');

    // month start and end timestamps
    $month_start = mktime(0,0,0,date('m'),1,date('Y'));
    $month_end = mktime(0,0,0,date('m')+1,1,date('Y'));

    // Criteo Data Tracking Tag String
    $cdtts = "";
    $cdtts_log = "";

    // Common timestamp for the whole script
    $timestamp = time();

    // adv campaign ID
    $campaignID = !empty($_COOKIE["campaignID"]) ? $_COOKIE["campaignID"] : 0;
    setCookie('campaignID', "", time()+86400*15, '/', DOMAIN);



    ////////////////////////////////////////////////////////////////////////////////
    // CONTACT SUCCESS INFOS
    ////////////////////////////////////////////////////////////////////////////////

    $contactID = generateID(1, 0x7fffffff, 'id', 'contacts_form', $handle);

    $db->query("
    INSERT INTO contacts_form (
            id, timestamp, nom, prenom, societe,
            adresse, cadresse, cp, ville, pays,
            tel, fax, email, source, objet,
            message, fonction, salaries, secteur,
            naf, siret, precisions, campaignID)
    VALUES (
            '".$contactID."', '".time()."', '".$db->escape($infos["nom"])."', '".$db->escape($infos["prenom"])."', '".$db->escape($infos["societe"])."',
            '".$db->escape($infos["adresse"])."', '".$db->escape($infos["cadresse"])."', '".$db->escape($infos["cp"])."', '".$db->escape($infos["ville"])."', '".$db->escape($infos["pays"])."',
            '".$db->escape($infos["telephone"])."', '".$db->escape($infos["fax"])."', '".$db->escape($infos["email"])."', 'contact-prospect-generic', '".$db->escape('Demande infos contrat lead')."',
            '".$db->escape($infos["message"])."', '".$db->escape($infos["fonction"])."', '".$db->escape($infos["salaries"])."', '".$db->escape($infos["secteur"])."',
            '".$db->escape($infos["naf"])."', '".$db->escape($infos["siret"])."', '".$db->escape($infos["precisions"])."','".$db->escape($campaignID)."')", __FILE__, __LINE__);


    ////////////////////////////////////////////////////////////////////////////////
    // MAILS
    ////////////////////////////////////////////////////////////////////////////////
    // Customer and Main Product Data
    $CustomerMailData = array(
      "CUSTOMER_REQUESTTYPE" => $lead_type_string,
      "CUSTOMER_LASTNAME" => $infos["nom"],
      "CUSTOMER_FIRSTNAME" => $infos["prenom"],
      "CUSTOMER_JOB" => $infos["fonction"],
      "CUSTOMER_PHONE" => $infos["telephone"],
      "CUSTOMER_FAX" => $infos["fax"],
      "CUSTOMER_FAX2" => $infos["fax"],
      "CUSTOMER_EMAIL" => $infos["email"],
      "CUSTOMER_EMAIL2" => $infos["email"],
      "CUSTOMER_COMPANY_NAME" => $infos["societe"],
      "CUSTOMER_COMPANY_WORKFORCE" => $infos["salaries"],
      "CUSTOMER_COMPANY_URL" => $infos["url"],
      "CUSTOMER_COMPANY_URL2" => $infos["url"],
      "CUSTOMER_COMPANY_SECTOR" => htmlentities($infos["secteur"]),
      "CUSTOMER_COMPANY_NAF" => $infos["naf"],
      "CUSTOMER_COMPANY_SIREN" => $infos["siret"],
      "CUSTOMER_COMPANY_ADDRESS" => $infos["adresse"],
      "CUSTOMER_COMPANY_COMPLEMENT" => $infos["cadresse"],
      "CUSTOMER_COMPANY_PC" => htmlentities($infos["cp"]),
      "CUSTOMER_COMPANY_CITY" => htmlentities($infos["ville"]),
      "CUSTOMER_COMPANY_COUNTRY" => htmlentities($infos["pays"]),
      "CUSTOMER_CUSTOM_FIELDS" => $cfvs,
      "SITE_MAIN_URL" => URL
      //"Customer-Company-DeleveryNote" => htmlentities($infos["infos_sup"]),
    );

    $MainProductMailData = array(
      "MAINPRODUCT_ID" => $pdt["id"],
      "MAINPRODUCT_CAT_ID" => $pdt["cat_id"],
      "MAINPRODUCT_NAME" => $pdt["name"],
      "MAINPRODUCT_REFNAME" => $pdt["ref_name"],
      "MAINPRODUCT_FAMILYID" => $pdt["cat_id"],
      "MAINPRODUCT_FASTDESC" => $pdt["fastdesc"],
      "MAINPRODUCT_DESCRIPTION" => $pdt["descc"],
      "MAINPRODUCT_DETAILEDDESCRIPTION" => empty($pdt["descd"]) ? "" : $pdt["descd"],
      "MAINPRODUCT_URL" => URL."produits/".$pdt["cat_id"]."-".$pdt["id"]."-".$pdt["ref_name"].".html",
      "MAINPRODUCT_IMAGE" => is_file(PRODUCTS_IMAGE_INC."thumb_big/".$pdt["id"]."-1".".jpg") ? PRODUCTS_IMAGE_URL."thumb_big/".$pdt["id"]."-1".".jpg" : PRODUCTS_IMAGE_URL."no-pic-thumb_big.gif",
      "MAINPRODUCT_PRICEDATA" => '',
      "MAINPRODUCT_ADVERTISER_ID" => $pdt["adv_id"],
      "MAINPRODUCT_ADVERTISER_NAME" => $pdt["nom1"],
      "MAINPRODUCT_ADVERTISER_CATEGORY" => $pdt["category"],
      "MAINPRODUCT_ADVERTISER_ADDRESS" => $pdt["adresse1"],
      "MAINPRODUCT_ADVERTISER_PC" => $pdt["cp"],
      "MAINPRODUCT_ADVERTISER_CITY" => $pdt["ville"],
      "MAINPRODUCT_ADVERTISER_COUNTRY" => $pdt["pays"],
      "MAINPRODUCT_ADVERTISER_PHONE" => $pdt["tel1"],
      "MAINPRODUCT_ADVERTISER_FAX" => $pdt["fax1"],
      "MAINPRODUCT_ADVERTISER_COMPLEMENT" => empty($pdt["adresse2"]) ? "" : $pdt["adresse2"],
      "MAINPRODUCT_ADVERTISER_CONTACT" => empty($pdt["contact"]) ? "" : $pdt["contact"],
      "MAINPRODUCT_ADVERTISER_EMAIL" => empty($pdt["email"]) ? "" :  $pdt["email"],
      "MAINPRODUCT_ADVERTISER_URL" => empty($pdt["adv_url"]) ? "" :  $pdt["adv_url"],
      "MAINPRODUCT_ADVERTISER_WEBPASS" => $pdt["webpass"],
      "MAINPRODUCT_ORIGINAL_ADVERTISER_ID" => $pdt["oadv_id"],
      "MAINPRODUCT_ORIGINAL_ADVERTISER_NAME" => $pdt["oadv_name"],
      "MAINPRODUCT_PRECISIONS" => $infos["precisions"],
      "MAINPRODUCT_GENERATEDCONTACTID" => $pdt["leadID"],
      "MAINPRODUCT_ADVERTISER_SHOWINFOSONLINE" => (int)$pdt["show_infos_online"],
      "SL_ADVERTISER_LIST" => $sl_adv_mail_infos
    );


    ////////////////////////////////////////////////////////////////////////////////
    // MAIL CREATION
    ////////////////////////////////////////////////////////////////////////////////
    // TC mail
    $arrayEmail = array(
      "email" => 'e.verry@techni-contact.com',
      "subject" => $infos["societe"]." souhaiterait devenir annonceur sur Techni-Contact",
      "headers" => "From: Contact prospect annonceur <web@techni-contact.com>\nCc: t.henryg@techni-contact.com, f.stumm@techni-contact.com\nReply-To: <". $infos["email"] .">\r\n",
      "template" => "prospect-fo_inscription-TC_info",
      "data" => array(
        "EXP_DATE" => date('d/m/Y - H:i:s'),
        'PROSPECT_NAME' => $infos["societe"],
        'PROSPECT_LASTNAME' => $infos["nom"],
        'PROSPECT_FIRSTNAME' => $infos["prenom"],
        'PROSPECT_POSITION' => $infos["fonction"],
        'PROSPECT_ACTIVITY' => $infos["secteur"],
        'PROSPECT_TEL' => $infos["telephone"],
        'PROSPECT_MAIL' => $infos["email"],
        'PROSPECT_SIZE' => $infos["salaries"],
        'PROSPECT_ADRESS' => $infos["adresse"],
        'PROSPECT_ADRESS2' => $infos["cadresse"],
        'PROSPECT_ZIPCODE' => $infos["cp"],
        'PROSPECT_CITY' => $infos["ville"],
        'PROSPECT_COUNTRY' => $infos["pays"],
        'PROSPECT_FAX' => $infos["fax"],
        'PROSPECT_NAF' => $infos["naf"],
        'PROSPECT_SIRET' => $infos["siret"],
        'PROSPECT_ACTIVICYDESC' => $infos["precisions"],
      )
    );
    $mail = new Email($arrayEmail);
    $mail->send();

    $arrayEmail = array();
    // prospect's mail
    $arrayEmail = array(
      "email" => $infos["email"],
      "subject" => "Renvoyez vite ce document pour augmenter votre CA",
      "headers" => "From: Techni-Contact - Devenir partenaire <f.stumm@techni-contact.com>\nReply-To: Techni-Contact - Devenir partenaire <f.stumm@techni-contact.com>\r\n",
      "template" => "prospect-fo_inscription-prospect_conf",
      "data" => array(
        'PROSPECT_LASTNAME' => $infos["nom"],
        'PROSPECT_FIRSTNAME' => $infos["prenom"],
        'URL' => URL
      )
    );
    $mail = new Email($arrayEmail);
    $mail->send();


    ////////////////////////////////////////////////////////////////////////////////
    // ACCOUNT CREATION AND UPDATE
    ////////////////////////////////////////////////////////////////////////////////
    // automatically create an account if email does not already exists in the db
    if (!($user_id = CustomerUser::getCustomerIdFromLogin($infos["email"], $handle))) {
      $user = new CustomerUser($handle);
      $accinfos = array(
        "coord_livraison" => 0,
        "login" => $infos["email"],
        "titre" => 1,
        "nom" => $infos["nom"],
        "prenom" => $infos["prenom"],
        "fonction" => $infos["fonction"],
        "societe" => $infos["societe"],
        "nb_salarie" => $infos["salaries"],
        "secteur_activite" => $infos["secteur"],
        "code_naf" => $infos["naf"],
        "num_siret" => $infos["siret"],
        "adresse" => $infos["adresse"],
        "complement" => $infos["cadresse"],
        "ville" => $infos["ville"],
        "cp" => $infos["cp"],
        "pays" => $infos["ville"],
        "infos_sup" => "",
        "tel1" => $infos["telephone"],
        "fax1" => $infos["fax"],
        "titre_l" => 1,
        "nom_l" => $infos["nom"],
        "prenom_l" => $infos["prenom"],
        "societe_l" => $infos["societe"],
        "adresse_l" => $infos["adresse"],
        "complement_l" => $infos["cadresse"],
        "ville_l" => $infos["ville"],
        "cp_l" => $infos["cp"],
        "pays_l" => $infos["pays"],
        "infos_sup_l" => "",
        "tel2" => $infos["telephone"],
        "fax2" => $infos["fax"],
        "url" => $infos["url"],
        "actif" => 1,
        "email" => $infos["email"]);
      $user->create();
      $user->setCoordFromArray($accinfos);
      $pass = $user->generatePassword();
      $user->save(time()-120); // on definit un timestamp antidaté de 120 secondes pour corriger le probleme 'Connexion Table clients / contact'
      // de la tache Hors Lot - Aout à Décembre 2010  - OD 10/12/2010
//      var_dump($user);exit;
      // sending mail
      $mail = new Email($handle);
      $mail->Build(
        "Création de votre compte",
        "",
        "creation-compte-lead",
        "From: Service client Techni-Contact <web@techni-contact.com>\n",
        array(
          "CUSTOMER_ID" => $user->id,
          "CUSTOMER_FIRSTNAME" => $user->prenom,
          "CUSTOMER_LASTNAME" => $user->nom,
          "CUSTOMER_EMAIL" => $user->email,
          "CUSTOMER_PASSWORD" => $pass,
          "SITE_MAIN_URL" => URL,
          "SITE_HELP_URL" => URL."aide.html",
          "SITE_ACCOUNT_URL_LOGIN" => COMPTE_URL."login.html"
        ),
        "user"
      );
      $mail->Send($user->email);
      $mail->Save();
    }
    else { // update account timestamp
      $user = new CustomerUser($handle, $user_id);
      $user->save();
    }

  }

  else {
    if (!empty($error)) {
      foreach($error as $key => $value) {
        if ($value == true) {
          echo $key.'|';
        }
      }
    }
    else {
      echo 'checkOk';
    }
    exit();
  }
}

if ($valid_form && empty($error) && !isset($_POST["onlyCheck"]) ) {
  $session = new UserSession();
  $session->authorized_adv_infos = array_merge($CustomerMailData, $MainProductMailData, array("cdtts" => $cdtts, "cdtts_log" => $cdtts_log));
  echo 'LeadOk';
  exit();
}
else {
  // show = true si l'on arrive du panier (pas de 'nom' définit dans $_POST) ou que c'est une demande directe (pas de POST)
  $show = $_SERVER["REQUEST_METHOD"] != 'POST' || !isset($_POST["nom"]);

  // Pays par défaut si pas de cookie et show
  if (!isset($_COOKIE["pays"]) && $show) $pays = 'FRANCE';

  // Préparation liste des fonctions
  $n = $pc = 0; $pl = array(); // Post List
  if ($fh = fopen(MISC_INC."list_post.csv","r")) {
    while (($data = fgetcsv($fh, 128, ";")) !== false) $pl[$n++] = $data;
    $pc = $n - 1; // Post Count -> La 1ère ligne est l'intitulé des colonnes
    fclose($fh);
  }

  // Préparation liste des tailles salariales
  $n = $nec = 0; $nel = array(); // Number of Employee List
  if ($fh = fopen(MISC_INC."list_number-of-employees.csv","r")) {
    while (($data = fgetcsv($fh, 64, ";")) !== false) $nel[$n++] = $data[0];
    $nec = $n - 1; // Number of Employee Count -> La 1ère ligne est l'intitulé des colonnes
    fclose($fh);
  }

  // Préparation liste des secteurs d'activité
  $activity_sectorsList =  ActivitySector::get();

  // Préparation liste des pays en majuscule
  $n = $cc = 0; $cl = array(); // Country List
  if ($fh = fopen(MISC_INC."list_country.csv","r")) {
    while (($data = fgetcsv($fh, 128, ";")) !== false) $cl[$n++] = mb_strtoupper($data[0]);
    $cc = $n - 1; // Country Count -> La 1ère ligne est l'intitulé des colonnes
    fclose($fh);
  }

  for ($i = 1; $i <= $cc; $i++)
    if ((isset($_COOKIE["pays"]) && $show && $_COOKIE["pays"] == htmlentities($cl[$i])) || $infos["pays"] == $cl[$i]) $country_selected = $cl[$i];

  if (!$country_selected) $country_selected = "FRANCE";

  $pdt["url"] = URL."produits/".$pdt["cat_id"]."-".$pdt["id"]."-".$pdt["ref_name"].".html";
  $pdt["pic_url"] = is_file(PRODUCTS_IMAGE_INC."thumb_big/".$pdt["id"]."-1".".jpg") ? PRODUCTS_IMAGE_URL."thumb_big/".$pdt["id"]."-1".".jpg" : PRODUCTS_IMAGE_URL."no-pic-thumb_big.gif";

  if (empty($infos["precisions"])) {
    $infos["precisions"] = FORM_PERSONNAL_INFOS_WARNING;
  }

  define("__BR_NO_AD__", true);
  define("NOINDEX_NOFOLLOW", true);
  //define("__TOP_NO_AD__", true);
  if ($pdt["category"] != __ADV_CAT_SUPPLIER__) {
    define("NO_SUPPLIER_PRODUCT", true);
    if ($pdt["category"] != __ADV_CAT_ADVERTISER__)
      define("NOR_ADVERTISER_PRODUCT", true);
  }
  $title = "Présenter ses produits sur Techni-Contact et devenir partenaire";
  $meta_desc = "";
  require(SITE."head.php");
?>
<script type="text/javascript" src="<?php echo $res_url ?>scripts/tooltips.js"></script>

<script type="text/javascript">
var RevDate = new Date();
document.write( unescape( "%3Cscript src='" + (("https:" == document.location.protocol) ? "https://api2.reversoform.com/www.reversoform.com/includes/js/reversoObj.js" : "http://api.reversoform.com/includes/js/reversoObj.js") + "?t="+RevDate.getTime()+"' type='text/javascript'%3E%3C/script%3E" ) );
</script>
<script type="text/javascript">
// Reverso
var ObjReverso = new ClassReverso();
ObjReverso.serial		= '8389615817859';
ObjReverso.phone		= 'telephone';
ObjReverso.company		= 'societe';
ObjReverso.firstname	= 'prenom';
ObjReverso.lastname		= 'nom';
ObjReverso.address		= 'adresse';
ObjReverso.zip			= 'cp';
ObjReverso.city			= 'ville';
ObjReverso.country		= 'pays';
ObjReverso.naf			= 'naf';
ObjReverso.siret		= 'siret';
</script>
<script type="text/javascript">
  var ERRORS_TEXT = new Array();
  ERRORS_TEXT["telephone"] = "Merci de renseigner votre téléphone.";
  ERRORS_TEXT["nom"] = "Merci de renseigner votre nom.";
  ERRORS_TEXT["prenom"] = "Merci de renseigner votre prénom.";
  ERRORS_TEXT["fax"] = "Merci de renseigner votre fax.";
  ERRORS_TEXT["email"] = "Merci de renseigner votre Email. Ex: xxxx@domaine.com";
  ERRORS_TEXT["fonction"] = "Merci de renseigner votre fonction. <br /> Agriculteur : sélectionnez Directeur / Gérant <br /> Particulier : sélectionnez Je suis un particulier <br /> Libéral : sélectionnez Je suis libéral";
  ERRORS_TEXT["societe"] = "Merci de renseigner le nom de votre société. ";
  ERRORS_TEXT["adresse"] = "Merci de renseigner votre adresse.";
  ERRORS_TEXT["cadresse"] = "Merci de renseigner votre complément d'adresse.";
  ERRORS_TEXT["cp"] = "Merci de renseigner votre code postal.";
  ERRORS_TEXT["ville"] = "Merci de renseigner votre ville.";
  ERRORS_TEXT["pays"] = "Merci de renseigner votre pays.";
  ERRORS_TEXT["salaries"] = "Merci de renseigner votre taille salariale. <br /> Particulier : sélectionnez Je suis un particulier <br /> Libéral ou agriculteur : sélectionnez 0 à 10 salariés";
  ERRORS_TEXT["secteur"] = "Merci de renseigner votre secteur d’activité. <br /> Particulier, sélectionnez Je suis un particulier <br /> Aucune proposition ne correspond : sélectionnez Autres";
  ERRORS_TEXT["naf"] = "Merci de renseigner votre code NAF.";
  ERRORS_TEXT["siret"] = "Merci de renseigner votre Siret.";
  ERRORS_TEXT["autre"] = "Ce champ ne doit pas être vide.";
</script>
<script type="text/javascript">
$(function () {
  var lead_form = $("form[name='lead_form']");
  var errorFields = <?php echo json_encode(array_keys($error)) ?>;
  if (errorFields.length > 0) {
    for (var i=0; i<errorFields.length; i++) errorFields[i] = "label[for='"+errorFields[i]+"']";
    alertstring = "Afin de nous transmettre votre demande, veuillez renseigner le(s) champs suivants :\n";
    $(errorFields.join(","), lead_form).addClass("error").each(function() {
       alertstring += " - " + $.trim(this.innerHTML.substring(0, this.innerHTML.lastIndexOf("*"))) + "\n";
    });
    alert(alertstring);
  }

  // Reverso Initialisation
  ObjReverso.fireCallback = function( response ) {
    if ( response!="NULL") {
      if (response.last_name) $("input[name='nom']", lead_form).val(response.last_name);
      if (response.first_name) $("input[name='prenom']", lead_form).val(response.first_name);
      if (response.address) $("input[name='adresse']", lead_form).val(response.address);
      if (response.zip) $("input[name='cp']", lead_form).val(response.zip);
      if (response.city) $("input[name='ville']", lead_form).val(response.city);
      if (response.country) $("select[name='pays']", lead_form).val(response.country);
      if (response.company) $("input[name='societe']", lead_form).val(response.company);
      $("input[name='reversoReversed']", lead_form).val(1);
    }else{
      $("input[name='reversoReversed']", lead_form).val(0);
    }
  };
  $("input[name='telephone']", lead_form).keyup(function(){
    var tel = this.value.match(/\d+/g).join("");
    if (tel.length >=10) ObjReverso.reverso(tel);
  });
  $("textarea[name='precisions']", lead_form).focus(function(){
    if (this.innerHTML == "<?php echo FORM_PERSONNAL_INFOS_WARNING ?>") this.innerHTML = "";
  });

  var submited = false;

  /*
  $(".edit").tooltip({
    tip: "#tooltip",
    position: "top center",
    onBeforeShow: function() {
      if ($("#tooltip").html() == "") {
        return false;
      }
    }
  });
*/

  $(".edit").focus(function() {
    //var tooltip = $(this).tooltip();
    //tooltip.hide();
    var bad = false;
    if ($(this).hasClass("badInfos") == true) {
      $(this).removeClass("badInfos");
      bad = true;
    }
    var id = $(this).attr("id");
    var idArray = id.split("_"); // 0 => "field", 1 => id
    $("#error_"+idArray[1]).hide();
    if (idArray[1]) {
      if (ERRORS_TEXT[idArray[1]]) {
        var errContent = ERRORS_TEXT[idArray[1]];
      }
      else {
        errContent = "Merci de renseigner " + idArray[1];
      }

      if (errContent.replace(/^\s*|\s*$/,"") != "" && bad == true) {
        $("#tooltip").html(errContent);
        //tooltip.show();
      }
    }
  }).blur(function() {
    $("#tooltip").html("");
    formData = lead_form.serialize();

    var id = $(this).attr("id");
    var idArray = id.split("_"); // 0 => "field", 1 => id
    var fname = idArray[1];

    $.ajax({
      type: "POST",
      data: formData+"&onlyCheck=true",
      url: lead_form.attr("action"),
      success: function(data) {
        data = data.replace(/^\s*|\s*$/,"");
        if (data != 'checkOk') {
          var errors = data.split('|');

          var i = 0;
          var fieldNameError = false;
          // Last element of errors will be empty
          for (i=0; i<errors.length-1; i++) {
            if (submited == true) {
              var errorContent = '';
              if (ERRORS_TEXT[errors[i]]) {
                errorContent = ERRORS_TEXT[errors[i]];
              }
              else {
                errorContent = "Merci de renseigner " + errors[i];
              }
              $("#error_"+errors[i]).html("Merci de renseigner ce champ.");
              $("#error_"+errors[i]).show();
              $("#field_"+errors[i]).addClass("badInfos");
              $("#ok_"+errors[i]).html("<img src='<?php echo $res_url ?>images/error.jpg' class='okImg' alt='X' />");
              /*$("#ok_"+errors[i]).hide();*/
              if (errors[i] == fname)
                fieldNameError = true;
            }
            else {
              if (errors[i] == fname) {
                fieldNameError = true;
              }
            }
          }
          if (fieldNameError == true) {
            var errorContent = '';
            if (ERRORS_TEXT[fname]) {
              errorContent = ERRORS_TEXT[fname];
            }
            else {
              errorContent = "Merci de renseigner " + fname;
            }
            $("#error_"+fname).html("Merci de renseigner ce champ.");
            $("#error_"+fname).show();
            $("#field_"+fname).addClass("badInfos");
            $("#ok_"+fname).html("<img src='<?php echo $res_url ?>images/error.jpg' class='okImg' alt='X' />");
          }
          else {

              $("#ok_"+fname).html("<img src='<?php echo $res_url ?>images/js-checkbox-20-on.gif' class='okImg' alt='ok' />");
              $("#ok_"+fname).show();
              $("#error_"+fname).hide();
              $("#error_"+fname).html("");
          }
        }
        else {
          if (fname != '') {
            $("#ok_"+fname).html("<img src='<?php echo $res_url ?>images/js-checkbox-20-on.gif' class='okImg' alt='ok' />");
            $("#ok_"+fname).show();
          }
        }
      }
    });
  });

  $(".btn-send-lead", lead_form).click(function(){
    submited = true;
    // Ajax request to valid form
    formData = lead_form.serialize();
    $.ajax({
      type: "POST",
      data: formData,
      url: lead_form.attr("action"),
      success: function(data) {
        data = data.replace(/^\s*|\s*$/,"");
        if (data == 'LeadOk') {
          document.location.href = "<?php echo URL ?>partenaire-success.html";
        }
        else {
          data = data.replace(/^\s*|\s*$/,"");
          var errors = data.split('|');

          var i = 0;
          // Last element of errors will be empty
          for (i=0; i<errors.length-1; i++) {
            var errorContent = '';
            if (ERRORS_TEXT[errors[i]]) {
              errorContent = ERRORS_TEXT[errors[i]];
            }
            else {
              errorContent = "Merci de renseigner " + errors[i];
            }
            $("#error_"+errors[i]).html("Merci de renseigner ce champ.");
            $("#error_"+errors[i]).show();
            $("#field_"+errors[i]).addClass("badInfos");
            $("#ok_"+errors[i]).html("<img src='<?php echo $res_url ?>images/error.jpg' class='okImg' alt='X' />");
          }

          self.location.href="#telephone_label";
        }
      }
    });
    return false;
  });

});

function findPosX(obj) {
  var curleft = obj.offsetLeft || 0;
  while (obj = obj.offsetParent) {
    curleft += obj.offsetLeft
  }
  return curleft;
}

function findPosY(obj) {
  var curtop = obj.offsetTop || 0;
  while (obj = obj.offsetParent) {
    curtop += obj.offsetTop
  }
  return curtop;
}

function showTooltip(content, element) {
  var offsetX = 25;
  var offsetY = 25;

  var posX = findPosX(element) + offsetX;
  var posY = findPosY(element) - offsetY;

  $("#tooltip").html(content);
  $("#tooltip").css({top: posY, left: posX});
  $("#tooltip").show();
}

function hideTooltip() {

  $("#tooltip").hide();
  $("#tooltip").html("");

}
</script>
          <div class="lead-form">
            <div class="title"><?php echo $page_title ?></div>
          <?php if ($pdt["category"] == __ADV_CAT_ADVERTISER__ || $pdt["category"] == __ADV_CAT_ADVERTISER_NOT_CHARGED__) { /*?>
            <div class="callback-phone-pictos">
              <img src="<?php echo $res_url ?>images/pictos/lead-phone.jpg" alt=""/>
              <script type="text/javascript">function pop(url){ window.open(url,"CallBack","menubar=no, status=no, scrollbars=no, resizable=no, width=448, height=400"); }</script>
              <a href="javascript:pop('http://callback.sysnekpro.com/')"><img src="<?php echo $res_url ?>images/pictos/callback-free-click.jpg"></a>
            </div>
          <?php*/ } ?>
            <!--<div class="pdt-preview">
              <div class="picture"><img src="<?php //echo $pdt["pic_url"] ?>" class="vmaib"/><div class="vsma"></div></div>
              <div class="infos">
                <div class="vmaib">
                  <strong><?php //echo $pdt["name"] ?></strong><br/>
                  <?php //echo $pdt["fastdesc"] ?><br/>
                  Code fiche produit: <?php //echo $pdt["id"] ?>
                </div><div class="vsma"></div>
              </div>
              <div class="zero"></div>
            </div>-->
            <div class="zero"></div>
            <br/>
            <br/>
            Que vous soyez une grande ou une petite entreprise, <strong>Techni-Contact vous permet de rapidement augmenter votre chiffre d'affaires :</strong><br/>
            <br/>
            <ul>
              <li>- Nous intégrons gratuitement vos produits</li>
              <li>- Vous choisissez les types de contacts que vous souhaitez recevoir</li>
              <li><strong>- Vous ne payez que si le contact reçu est exploitable</strong></li>
              <li>- Vous arrêtez quand vous voulez</li>
            </ul>




            <br/>
            <br/>
            <br/>
            <form id="lead_form" name="lead_form" action="<?php echo URL."partenaire.html" ?>" method="post">
            <div class="contact-infos">
              <!--<input type="hidden" name="type" value="<?php echo $lead_type ?>">
              <input type="hidden" name="pdtID" value="<?php echo $pdt["id"] ?>">
              <input type="hidden" name="catID" value="<?php echo $pdt["cat_id"] ?>">-->
              <input type="hidden" name="reversoReversed" value="0">

              <div class="box white-sr-box lf-pi">
                <div class="btl"></div>
                <div class="btr"></div>
                <div class="bbl"></div>
                <div class="bbr"></div>
                <div class="box-out">
                  <div class="box-in">
                    <div class="legend">Contactez-nous vite pour recevoir des opportunités d'affaires</div>
                    <div class="section-you-ab2">
                      <div class="section-title">Vous</div>
                      <div class="bil">
                        <div class="leadform_ok" id="ok_telephone"></div>
                        <label for="telephone" id="telephone_label">Téléphone</label>
                        <input id="field_telephone" name="telephone" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["telephone"]) && $show) ? $_COOKIE["telephone"] : htmlentities($infos["telephone"]) ?>"/>

                        <div class="leadform_error" id="error_telephone">
                        </div>
                        <!-- End .error -->
                        <div class="leadform_ok" id="ok_nom"></div>
                        <label for="nom">Nom</label>
                        <input id="field_nom" name="nom" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["nom"]) && $show) ? $_COOKIE["nom"] : htmlentities($infos["nom"]) ?>"/>

                        <div class="leadform_error" id="error_nom">
                        </div>
                        <!-- End .error -->
                        <div class="leadform_ok" id="ok_prenom"></div>
                        <label for="prenom">Prénom</label>
                        <input id="field_prenom" name="prenom" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["prenom"]) && $show) ? $_COOKIE["prenom"] : htmlentities($infos["prenom"]) ?>"/>

                        <div class="leadform_error" id="error_prenom">
                        </div>
                        <!-- End .error -->
                      </div>
                      <div class="bir">
                      <div class="leadform_ok" id="ok_fax"></div>
                        <label for="fax">Fax (optionnel)</label>
                        <input id="field_fax" name="fax" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["fax"]) && $show) ? $_COOKIE["fax"] : htmlentities($infos["fax"]) ?>"/>

                        <div class="leadform_error" id="error_fax">
                        </div>
                        <!-- End .error -->
                                                <div class="leadform_ok" id="ok_email"></div>

                        <label for="email">Email</label>
                        <input id="field_email" name="email" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["email"]) && $show) ? $_COOKIE["email"] : htmlentities($infos["email"]) ?>"/>
                        <div class="leadform_error" id="error_email">
                        </div>
                        <!-- End .error -->												<div class="leadform_ok" id="ok_fonction"></div>

                        <label for="fonction">Fonction<?php if (isset($notReqFields["fonction"])) echo "(optionnel)" ?> <span class="infoClick" onmouseover="showTooltip('Agriculteur : sélectionnez Directeur / Gérant<br />Particulier : sélectionnez Je suis un particulier<br />Libéral : sélectionnez Je suis libéral', this);"
                                                                                                                                                                  onmouseout="hideTooltip();"><img src="<?php echo $res_url ?>images/help.jpg" alt="?" /></span></label>
                        <select id="field_fonction" name="fonction" class="edit">
                          <option value=""> - </option>
                        <?php for ($i = 1; $i <= $pc; $i++) { ?>
                          <option value="<?php echo $pl[$i][0] ?>"<?php if (((isset($_COOKIE["fonction"]) && $show && $_COOKIE["fonction"] == htmlentities($pl[$i][0])) || $infos["fonction"] == $pl[$i][0]) && $pl[$i][0] != '') { ?> selected="selected"<?php } ?>><?php echo htmlentities($pl[$i][1]) ?></option>
                        <?php }?>
                        </select>
                        <div class="leadform_error" id="error_fonction">
                        </div>
                        <!-- End .error -->
                      </div>
                      <div class="zero"></div>
                    </div>

                    <div class="section-company-ab2">

                      <div class="section-title">Votre société / organisation</div>
                      <div class="bil">
                                                <div class="leadform_ok" id="ok_societe"></div>

                        <label for="societe">Nom société / organisation<?php if (isset($notReqFields["societe"])) echo "(optionnel)" ?></label>
                        <input id="field_societe" name="societe" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["societe"]) && $show) ? $_COOKIE["societe"] : htmlentities($infos["societe"]) ?>"/>
                        <div class="leadform_error" id="error_societe">
                        </div>
                        <!-- End .error -->
                                                <div class="leadform_ok" id="ok_adresse"></div>

                        <label for="adresse">Adresse<?php if (isset($notReqFields["adresse"])) echo "(optionnel)" ?></label>
                        <input id="field_adresse" name="adresse" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["adresse"]) && $show) ? $_COOKIE["adresse"] : htmlentities($infos["adresse"]) ?>"/>
                        <div class="leadform_error" id="error_adresse">
                        </div>
                        <!-- End .error -->
                                                <div class="leadform_ok" id="ok_cadresse"></div>

                        <label for="cadresse">Complément(ZI,BP,etc)<?php if (isset($notReqFields["complement"])) echo "(optionnel)" ?></label>
                        <input id="field_cadresse" name="cadresse" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["cadresse"]) && $show) ? $_COOKIE["cadresse"] : htmlentities($infos["cadresse"]) ?>"/>
                        <div class="leadform_error" id="error_cadresse">
                        </div>
                        <!-- End .error -->
                                                <div class="leadform_ok" id="ok_cp"></div>

                        <label for="cp">Code Postal<?php if (isset($notReqFields["cp"])) echo "(optionnel)" ?></label>
                        <input id="field_cp" name="cp" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["cp"]) && $show) ? $_COOKIE["cp"] : htmlentities($infos["cp"]) ?>"/>
                        <div class="leadform_error" id="error_cp">
                        </div>
                        <!-- End .error -->												<div class="leadform_ok" id="ok_ville"></div>

                        <label for="ville">Ville<?php if (isset($notReqFields["ville"])) echo "(optionnel)" ?></label>
                        <input id="field_ville" name="ville" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["ville"]) && $show) ? $_COOKIE["ville"] : htmlentities($infos["ville"]) ?>"/>
                        <div class="leadform_error" id="error_ville">
                        </div>
                        <!-- End .error -->												<div class="leadform_ok" id="ok_pays"></div>

                        <label for="pays">Pays<?php if (isset($notReqFields["pays"])) echo "(optionnel)" ?></label>
                        <select id="field_pays" name="pays" class="edit">
                        <?php for ($i = 1; $i <= $cc; $i++) { ?>
                          <option value="<?php echo $cl[$i] ?>"<?php if ($cl[$i] == $country_selected) { ?> selected="selected"<?php } ?>><?php echo htmlentities($cl[$i]) ?></option>
                        <?php } ?>
                        </select>
                        <div class="leadform_error" id="error_pays">
                        </div>
                        <!-- End .error -->
                      </div>
                      <div class="bir">												<div class="leadform_ok" id="ok_salaries"></div>

                        <label for="salaries">Taille salariale<?php if (isset($notReqFields["nb_salarie"])) echo "(optionnel)" ?></label>
                        <select id="field_salaries" name="salaries" class="edit">
                          <option value=""> - </option>
                        <?php for ($i = 1; $i <= $nec; $i++) { ?>
                          <option value="<?php echo $nel[$i] ?>"<?php if ((isset($_COOKIE["salaries"]) && $show && $_COOKIE["salaries"] == htmlentities($nel[$i])) || $infos["salaries"] == $nel[$i]) { ?> selected="selected"<?php } ?>><?php echo htmlentities($nel[$i]) ?></option>
                        <?php } ?>
                        </select>
                        <div class="leadform_error" id="error_salaries">
                        </div>
                        <!-- End .error -->												<div class="leadform_ok" id="ok_secteur"></div>

                        <label for="secteur">Secteur d'activité<?php if (isset($notReqFields["secteur_activite"])) echo "(optionnel)" ?> <span class="infoClick" onmouseover="showTooltip('Particulier : sélectionnez Je suis un particulier<br />Aucune proposition ne correspond : sélectionnez Autres', this);"
                                                                                                                                                                  onmouseout="hideTooltip();"
                                                                                                                                                                  ><img src="<?php echo $res_url ?>images/help.jpg" alt="?" /></span></label>
                        <select id="field_secteur" name="secteur" class="edit">
                          <option value=""> - </option>
                        <?php if(!empty($activity_sectorsList))
                                foreach ($activity_sectorsList as $activity_sector) { ?>
                          <option value="<?php echo $activity_sector['sector'] ?>"<?php if ((isset($_COOKIE["secteur"]) && $show && $_COOKIE["secteur"] == htmlentities($activity_sector['sector'])) || $infos["secteur"] == $activity_sector['sector']) { ?> selected="selected"<?php } ?>><?php echo htmlentities($activity_sector['sector']) ?></option>
                        <?php } ?>
                        </select>
                        <div class="leadform_error" id="error_secteur">
                        </div>
                        <!-- End .error -->												<div class="leadform_ok" id="ok_naf"></div>

                        <label for="naf">Code NAF<?php if (isset($notReqFields["code_naf"])) echo "(optionnel)" ?></label>
                        <input id="field_naf" name="naf" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["naf"]) && $show) ? $_COOKIE["naf"] : htmlentities($infos["naf"]) ?>"/>
                        <div class="leadform_error" id="error_naf">
                        </div>
                        <!-- End .error -->												<div class="leadform_ok" id="ok_siret"></div>

                        <label for="siret">Numéro SIRET<?php if (isset($notReqFields["num_siret"])) echo "(optionnel)" ?></label>
                        <input id="field_siret" name="siret" type="text" maxlength="255" class="edit" value="<?php echo (isset($_COOKIE["siret"]) && $show) ? $_COOKIE["siret"] : htmlentities($infos["siret"]) ?>"/>
                        <div class="leadform_error" id="error_siret">
                        </div>
                        <!-- End .error -->
                      </div>
                      <div class="zero"></div>
                    </div>
                <?php if (!empty($customFields)) { ?>
                    <div class="section-custom-fields-ab2">

                      <div class="section-title">Autres informations</div>
                      <div class="bim">
                  <?php for ($i = 0; $i < $cf_count; $i++) {
                    $cf = &$customFields[$i];
                    if (empty($cfv[$cf["name"]])) $cfv[$cf["name"]] = $cf["valueDefault"];
                    switch($cf["type"]) {
                      case "text":
                      ?>
						<div class="leadform_ok" id="ok_<?php echo $cf["name"] ?>"></div>
                        <label for="<?php echo $cf["name"] ?>"><?php echo $cf["label"] ?><?php echo $cf["required"] ? "" : "(optionnel)" ?></label>
                        <input id="field_<?php echo $cf["name"] ?>" name="<?php echo $cf["name"] ?>" type="text" maxlength="<?php echo $cf["length"] ?>" class="edit" value="<?php echo $cfv[$cf["name"]] ?>"/>
                        <div class="leadform_error" id="error_<?php echo $cf["name"] ?>">
                        </div>
                        <!-- End .error -->
                      <?php
                        break;
                      case "select":
                      ?>
						<div class="leadform_ok" id="ok_<?php echo $cf["name"] ?>"></div>
                        <label for="<?php echo $cf["name"] ?>"><?php echo $cf["label"] ?><?php echo $cf["required"] ? "" : "(optionnel)" ?></label>
                        <select id="field_<?php echo $cf["name"] ?>" name="<?php echo $cf["name"] ?>" class="edit">
                          <option value="">-</option>
                        <?php $valueList = explode(",", $cf["valueList"]);
                          foreach($valueList as $val) { ?>
                          <option value="<?php echo $val ?>"<?php if ($val == $cfv[$cf["name"]]) { ?> selected="selected"<?php } ?>><?php echo $val ?></option>
                        <?php } ?>
                        </select>

                        <div class="leadform_error" id="error_<?php echo $cf["name"] ?>">
                        </div>
                        <!-- End .error -->
                      <?php
                        break;
                      case "textarea":
                      ?>
						<div class="leadform_ok" id="ok_<?php echo $cf["name"] ?>"></div>
                        <label for="<?php echo $cf["name"] ?>"><?php echo $cf["label"] ?><?php echo $cf["required"] ? "" : "(optionnel)" ?></label>
                        <textarea id="field_<?php echo $cf["name"] ?>" name="<?php echo $cf["name"] ?>" class="edit" rows="4"><?php echo $cfv[$cf["name"]] ?></textarea>

                        <div class="leadform_error" id="error_<?php echo $cf["name"] ?>">
                        </div>
                        <!-- End .error -->
                      <?php
                        break;
                      default: break;
                    }
                  } ?>
                      </div>
                    </div>
                <?php } ?>
                    <div class="section-title">Votre activité</div>
                    <label for="precisions" style="color: #017F01;">Décrivez votre activité en quelques mots</label>
                    <textarea style="margin-top: 5px; width: 250px; height: 100px; float: left" class="edit" name="precisions" rows="4" onmouseover="$('#precisionsInfos').show();" onmouseout="$('#precisionsInfos').hide();" ></textarea>
                    <div id="precisionsInfos" style="display: none; text-align: left; float: left; overflow: hidden; width: 150px; margin-left: 25px; font-size: 11px; color: #000000; font-family: Arial; margin-top: 5px;" class="box white-sr-box lf-msg">
                      <div class="btl"></div>
                      <div class="btr"></div>
                      <div class="bbl"></div>
                      <div class="bbr"></div>
                      <div class="box-out">
                        <div class="box-in">
                          <div>
                            <?php echo $infos["precisions"] ?>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div style="clear: both;"></div>
                   <?php //if ($pdt["noLeads2out"] == 0) { ?>
                    <!--<input type="checkbox" name="sl" checked="checked"/>Je souhaite envoyer ma demande à toutes les sociétés susceptibles de traiter mon projet-->
                   <?php //} ?>
                  </div>
                </div>
              </div>

              <table class="form-pictos partenaire">
                <tbody>
                  <tr>
                    <td class="picto"><img src="<?php echo $res_url ?>images/pictos/0-euros.png" alt=""/></td>
                    <td class="label">
                      0 frais d'inscription<br />
                      <br />
                      0 frais de maintenance
                    </td>
                  </tr>
                  </tbody>
              </table>
              <table class="form-pictos partenaire">
                <tbody>
                  <tr><td class="picto"><img src="<?php echo $res_url ?>images/pictos/euros.png" alt=""/></td><td class="label">Des milliers de devis envoyés chaque mois à nos partenaires</td></tr>
                </tbody>
              </table>
              <div class="zero"></div>
              <br/>
              <br/>

              <div class="btn-send-lead"></div>
              <br/>
            </div>
            </form>
          </div>
<script type="text/javascript">
// Postal code autocomplete
var champCodePostal = $('#field_cp');

champCodePostal.keyup( function(){
  if(champCodePostal.val().match('[0-9]{5}') && $("input[name='reversoReversed']").val() == 0){

    $.ajax({
      type: "GET",
      data: "code_postal="+champCodePostal.val(),
      dataType: "json",
      url: "ressources/ajax/AJAX_codesPostaux.php",
      success: function(data) {

        var refBox = $('#field_ville');

        if(data['reponses'].length > 1){

          var html = '<table id="cpAutocomplete" class="auto-completion-box" style="min-width: 221px; top: '+(refBox.offset().top + refBox.height() + 7)+'px; left: '+refBox.offset().left+'px; -moz-user-select: none;" >';
          $.each(data['reponses'], function(){
            html += '<tr class=""><td class="prop">'+this.commune+'</td><td class="results"></td></tr>';

          });
          html += '</table>';

          $('#cpAutocomplete').remove(); // avoid multiple layers in case of multiple keyups
          $('body').append(html);

          $.each($('#cpAutocomplete tr'), function(){
            $(this).mouseenter(function(){
              $(this).addClass('over');
            }).mouseleave(function(){
              $(this).removeClass('over');
            }).click(function(){
              refBox.val($(this).find('td.prop').html());
              $('#cpAutocomplete').remove();
            });
          });

          refBox.blur(function(){
            setTimeout(function(){$('#cpAutocomplete').remove();}, 200);
          });

        }else if(data['reponses'].length == 1){
          refBox.val(data['reponses'][0].commune);
        }
      }
    });
  } // endif(id == champCodePostal)
});
// Postal code autocomplete

</script>

<?php




require(SITE."foot.php");
} // fin affichage form
?>