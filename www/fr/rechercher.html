<?php
require_once substr(dirname(__FILE__),0,strpos(dirname(__FILE__),'/',stripos(dirname(__FILE__),'technico')+1)+1).'config.php';

define("SEARCH", true);

$db = DBHandle::get_instance();

$last_user_search = isset($_POST['last_user_search']) ? (int)$_POST['last_user_search'] : (isset($_GET['last_user_search']) ? (int)$_GET['last_user_search'] : 0);
$q = isset($_POST['search']) ? trim($_POST['search']) : (isset($_GET['search']) ? trim($_GET['search']) : "");
$catFilterID = isset($_POST['catFilterID']) ? (int)trim($_POST['catFilterID']) : (isset($_GET['catFilterID']) ? (int)trim($_GET['catFilterID']) : 0);
$catDetailID = isset($_POST['catDetailID']) ? (int)trim($_POST['catDetailID']) : (isset($_GET['catDetailID']) ? (int)trim($_GET['catDetailID']) : 0);
$ql = strlen($q);

// this search must be in the last user searches
if ($last_user_search == 1) {
  // getting latest user searches
  $user_searches = array();
  $res = $db->query("SELECT DISTINCT `search_terms` FROM `user_searches` WHERE `nb_pdt_results` >= 5 ORDER BY `timestamp` DESC LIMIT 25", __FILE__, __LINE__);
  $last_user_search_found = false;
  while (list($user_search) = $db->fetch($res)) {
    if ($user_search == $q) {
      $last_user_search_found = true;
      break;
    }
  }
}

if (!$last_user_search || $last_user_search_found) {
  // "Google-ing" terms and ignoring plurals
  $preterms = preg_split("`\s|-`", Utils::noDiphthong($q));
  $terms = array();
  $terms_regexp = array();
  for ($i = 0; $i < count($preterms); $i++) {
    if (Utils::is_plural($preterms[$i])) {
      $terms[$i] = (strlen($preterms[$i]) > 3 ? "+" : "").Utils::get_singular($preterms[$i])."* <<".$preterms[$i]."*";
      if (strlen($preterms[$i]) > 3 || is_numeric($preterms[$i])) $terms_regexp[$i] = Utils::toDashAz09(Utils::get_singular($preterms[$i]))."?";
    }
    else {
      $terms[$i] = (strlen($preterms[$i]) > 3 ? "+" : "").$preterms[$i]."*";
      if (strlen($preterms[$i]) > 2 || is_numeric($preterms[$i])) $terms_regexp[$i] = Utils::toDashAz09($preterms[$i]);
    }
    //if ($i == 0) $terms[$i] = ">".$terms[$i];
  }
  $match_expr = implode(" ", $terms);
  $match_expr_regexp = "/".implode(".*", $terms_regexp)."/i";
  $match_expr_regexp_start = "/^".implode(".*", $terms_regexp)."/i";
  //print "match_expr=".to_entities($match_expr) . "<br/>\n";
  //print "match_expr_regexp=".to_entities($match_expr_regexp) . "<br/>\n";
  //print "match_expr_regexp_start=".to_entities($match_expr_regexp_start) . "<br/>\n";

  define("SEARCH_SIMPLE_CAT_COUNT_MAX", 60);
  define("SEARCH_DETAILED_CAT_COUNT_MAX", 3);
  define("SEARCH_DETAILED_CAT_PDT_COUNT_MAX", 5);
  define("GLOBAL_AVERAGE_PRICE", 700);
  define("TYPICAL_DATA_SET_SIZE", 10);

  if ($ql >= 3) {
    
    $mts['TOTAL TIME']['start'] = microtime(true);
    
  // --------------------------------------------------------------------------------
  // XML LOADING
  // Loading XML with complete categories information
  // Loading time of an xml = nb_element_to_check * size/3.5
  // --------------------------------------------------------------------------------
    $mts['XML LOAD']['start'] = microtime(true);
    $dom = new DomDocument();
    $dom->validateOnParse = true;
    $dom->load(XML_CATEGORIES_ALL);
    $xPath = new DOMXPath($dom);
    $mts['XML LOAD']['end'] = microtime(true);
    
    //foreach($mts as $mtn => $mt) print $mtn . " = <b>" . ($mt['end']-$mt['start'])*1000 . "ms</b><br/>\n";
    //exit();
    
    // If a exact category name is found
    $gq = Utils::toDashAz09($q);
    $exact_cat = $xPath->query("//category[@ref_name='".$gq."']")->item(0);
    if ($exact_cat) {
      // saving this search
      $user_searches_fields = array("search_terms" => $db->escape($q),"match_expr" => $db->escape($match_expr),"nb_pdt_results" => 0,"nb_cat_results" => 1, "timestamp" => time());
      $db->query("INSERT INTO `user_searches` (`".implode("`,`",array_keys($user_searches_fields))."`) VALUES ('".implode("','",$user_searches_fields)."')", __FILE__, __LINE__);
      
      header("Location: " . URL."familles/".$gq.".html");
      exit(); 
    }
    
  // --------------------------------------------------------------------------------
  // GLOBAL VAR SETTING
  // --------------------------------------------------------------------------------
    // Category filter : search for results only in the choosen category
    if ($catFilterID) {
      $cur_cat = $xPath->query("parent::category",$dom->getElementById(XML_KEY_PREFIX.$catFilterID))->item(0);
      if ($cur_cat) {
        $catTree = $xPath->query("ancestor-or-self::category", $cur_cat);
        $cat3IDs = array();
        switch ($catTree->length) {
          case 1 : // Main category
            $fcat1 = $catTree->item(0);
            $cat3List = $xPath->query("child::category/child::category", $cur_cat);
            foreach($cat3List as $cat3)
              $cat3IDs[] = (int)$cat3->getAttribute("id");
            break;
            
          case 2 : // Level 2 category
            $fcat1 = $catTree->item(0);
            $fcat2 = $catTree->item(1);
            $cat3List = $xPath->query("child::category", $cur_cat);
            foreach($cat3List as $cat3)
              $cat3IDs[] = (int)$cat3->getAttribute("id");
            break;
            
          case 3 : // Level 3 category
            $fcat1 = $catTree->item(0);
            $fcat2 = $catTree->item(1);
            $fcat3 = $catTree->item(2);
            $cat3IDs[] = (int)$fcat3->getAttribute("id");
            break;
            
          default:
            $catFilterID = 0;
            // Error in XML
            break;
        }
        $cat3Count = count($cat3IDs);
        $cat3IDs = implode(",", $cat3IDs);
        /*if (isset($fcat1)) pp($fcat1->getAttribute("id"));
        if (isset($fcat1)) pp($fcat1->getAttribute("name"));
        if (isset($fcat2)) pp($fcat2->getAttribute("id"));
        if (isset($fcat2)) pp($fcat2->getAttribute("name"));
        if (isset($fcat3)) pp($fcat3->getAttribute("id"));
        if (isset($fcat3)) pp($fcat3->getAttribute("name"));
        pp($cat3IDs);*/
      }
      else {
        $catFilterID = 0;
        // Category ID does not exist
      }
    }
    
    // Show a specific level 3 category
    if ($catDetailID) {
      $cur_cat = $xPath->query("parent::category",$dom->getElementById(XML_KEY_PREFIX.$catDetailID))->item(0);
      if ($cur_cat)
        $catTree = $xPath->query("ancestor-or-self::category", $cur_cat);
      if (!$cur_cat || $catTree->length != 3)
        $catDetailID = 0;
    }
    elseif (isset($fcat3)) { // if filtering for a level 3 category, we set the cat detail ID for it (except if already setted)
      $catDetailID = (int)$fcat3->getAttribute("id");
    }
    
  // --------------------------------------------------------------------------------
  // SQL QUERIES SETTING
  // --------------------------------------------------------------------------------
    $fieldsResults_total = array(
      "count" => 0
    );
    $fieldsSettings = array(
      "products-title" => array(
        "query" => "
          SELECT
            pfr.id, pfr.name, pfr.ref_name,
            ffr.id as catID,
            ps.hits, ps.orders, ps.leads, (" . mktime(0,0,0) . "- ps.first_hit_time) as age,
            MATCH (pfr.name) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE) as score
          FROM
            products_fr pfr, products_families pf, products_stats ps, families_fr ffr, advertisers a
          WHERE
            pfr.id = pf.idProduct AND
            pfr.id = ps.id AND
            pf.idFamily = ffr.id AND
            pfr.idAdvertiser = a.id AND
            a.actif = 1 AND
            pfr.active = 1 AND
            pfr.deleted != 1 AND
            ".($catFilterID?"pf.idFamily in (".$cat3IDs.") AND":"")."
            MATCH (pfr.name) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE)
          ORDER BY
            score DESC, pfr.name ASC",
        "first_term_weight" => "name"
      ),
      "products-fastdesc" => array(
        "query" => "
          SELECT
            pfr.id, pfr.name, pfr.ref_name, pfr.fastdesc,
            ffr.id as catID,
            ps.hits, ps.orders, ps.leads, (" . mktime(0,0,0) . "- ps.first_hit_time) as age,
            MATCH (pfr.fastdesc) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE) as score
          FROM
            products_fr pfr, products_families pf, products_stats ps, families_fr ffr, advertisers a
          WHERE
            pfr.id = pf.idProduct AND
            pfr.id = ps.id AND
            pf.idFamily = ffr.id AND
            pfr.idAdvertiser = a.id AND
            a.actif = 1 AND
            pfr.active = 1 AND
            pfr.deleted != 1 AND
            ".($catFilterID?"pf.idFamily in (".$cat3IDs.") AND":"")."
            MATCH (pfr.fastdesc) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE)
          ORDER BY
            score DESC, pfr.name ASC",
        "first_term_weight" => "fastdesc"
      ),
      "products-id" => array(
        "query" => "
          SELECT
            pfr.id, pfr.name, pfr.ref_name, pfr.fastdesc,
            ffr.id as catID,
            ps.hits, ps.orders, ps.leads, (" . mktime(0,0,0) . "- ps.first_hit_time) as age,
            MATCH (pfr.id) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE) as score
          FROM
            products_fr pfr, products_families pf, products_stats ps, families_fr ffr, advertisers a
          WHERE
            pfr.id = pf.idProduct AND
            pfr.id = ps.id AND
            pf.idFamily = ffr.id AND
            pfr.idAdvertiser = a.id AND
            a.actif = 1 AND
            pfr.active = 1 AND
            pfr.deleted != 1 AND
            ".($catFilterID?"pf.idFamily in (".$cat3IDs.") AND":"")."
            MATCH (pfr.id) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE)
          ORDER BY
            score DESC, pfr.name ASC"
      ),
      "references-idtc" => array(
        "query" => "
          SELECT
            rc.idProduct as id,
            pfr.name, pfr.ref_name,
            pf.idFamily as catID,
            ps.hits, ps.orders, ps.leads, (" . mktime(0,0,0) . "- ps.first_hit_time) as age,
            MATCH (rc.id) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE) as score
          FROM
            references_content rc, products_fr pfr, products_families pf, products_stats ps, families_fr ffr, advertisers a
          WHERE
            rc.idProduct = pfr.id AND
            rc.idProduct = pf.idProduct AND
            rc.idProduct = ps.id AND
            rc.vpc = 1 AND
            rc.deleted = 0 AND
            pf.idFamily = ffr.id AND
            pfr.idAdvertiser = a.id AND
            a.actif = 1 AND
            pfr.active = 1 AND
            pfr.deleted != 1 AND
            ".($catFilterID?"pf.idFamily in (".$cat3IDs.") AND":"")."
            MATCH (rc.id) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE)
          GROUP BY
            rc.idProduct
          ORDER BY
            score DESC"
      ),
      "references-refSupplier" => array(
        "query" => "
          SELECT
            rc.idProduct as id, rc.refSupplier,
            pfr.name, pfr.ref_name,
            pf.idFamily as catID,
            ps.hits, ps.orders, ps.leads, (" . mktime(0,0,0) . "- ps.first_hit_time) as age,
            MATCH (rc.refSupplier) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE) as score
          FROM
            references_content rc,
            products_fr pfr,
            products_families pf,
            products_stats ps,
            families_fr ffr,
            advertisers a
          WHERE
            rc.idProduct = pfr.id AND
            rc.idProduct = pf.idProduct AND
            rc.idProduct = ps.id AND
            rc.vpc = 1 AND
            rc.deleted = 0 AND
            pf.idFamily = ffr.id AND
            pfr.idAdvertiser = a.id AND
            a.actif = 1 AND
            pfr.active = 1 AND
            pfr.deleted != 1 AND
            ".($catFilterID?"pf.idFamily in (".$cat3IDs.") AND":"")."
            MATCH (rc.refSupplier) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE)
          GROUP BY
            rc.idProduct
          ORDER BY
            score DESC",
        "first_term_weight" => "refSupplier"
      ),
      "products-alias" => array(
        "query" => "
          SELECT
            pfr.id, pfr.name, pfr.ref_name, pfr.alias,
            pf.idFamily as catID,
            ps.hits, ps.orders, ps.leads, (" . mktime(0,0,0) . "- ps.first_hit_time) as age,
            MATCH (pfr.alias) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE) as score
          FROM
            products_fr pfr, products_families pf, products_stats ps, families_fr ffr, advertisers a
          WHERE
            pfr.id = pf.idProduct AND
            pfr.id = ps.id AND
            pf.idFamily = ffr.id AND
            pfr.idAdvertiser = a.id AND
            a.actif = 1 AND
            pfr.active = 1 AND
            pfr.deleted != 1 AND
            ".($catFilterID?"pf.idFamily in (".$cat3IDs.") AND":"")."
            MATCH (pfr.alias) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE)
          ORDER BY
            score DESC, pfr.name ASC",
        "first_term_weight" => "alias"
      )
    );
    $fk = array_keys($fieldsSettings); // Fields Keys
    $fieldsResults = array_flip($fk);
    $fkCount = count($fk);
    
    
  // --------------------------------------------------------------------------------
  // REQUESTING PRODUCTS
  // Loop 1 : getting results by field type
  // --------------------------------------------------------------------------------
    $mts['LOOP 1 : SQL REQUEST']['start'] = microtime(true);
    for($i = 0; $i < $fkCount; $i++) {
      $settings = &$fieldsSettings[$fk[$i]];
      $results = &$fieldsResults[$fk[$i]];
      $results = array(
        "data" => array(),
        "count" => 0,
        "min_score" => 0x7fffffff,
        "max_score" => 0,
        "ttl_score" => 0);
      
      $mt = microtime(true);
      $res = $db->query($settings['query'], __FILE__, __LINE__);
      //print $settings['query'] ."<br/>\n";
      $results['sql_request_time'] = (microtime(true) - $mt)*1000;
      $results['count'] = $db->numrows($res);
      //print $fk[$i] . " RESULTS COUNT :" . $results['count'] . " | SQL REQUEST TIME : " . $results['sql_request_time'] . "ms<br/>\n";
      if ($results['count'] == 0) continue;
      $fieldsResults_total['count'] += $results['count'];
      
      while ($pdt = $db->fetchAssoc($res)) {
        $results['data'][] = $pdt;
        $results['ttl_score'] += $pdt['score'];
      }
      
      // Data are already sorted by score desc (sql request)
      $results['min_score'] = $results['data'][$results['count']-1]['score'];
      $results['max_score'] = $results['data'][0]['score']; // different from min_score only if there is plurals in the search
      
      // Priorizing the results beginning with the first searched term
      if (isset($settings['first_term_weight'])) {
        $firstResults = array();
        $otherResults = array();
        foreach($results['data'] as &$pdt) {
          if (stripos($pdt[$settings['first_term_weight']], $preterms[0]) !== 0)
            $pdt['score'] = $results['min_score'] * 0.5;
        }
        unset($pdt);
      }
    }
    unset($settings, $results);
    $mts['LOOP 1 : SQL REQUEST']['end'] = microtime(true);
    
    if ($fieldsResults_total['count'] == 1) { // 1 result
      for($i = 0; $i < $fkCount; $i++)
        if ($fieldsResults[$fk[$i]]['count'] == 1) break;
      $single_pdt = $fieldsResults[$fk[$i]]['data'][0];
      
      // saving this search
      $user_searches_fields = array("search_terms" => $db->escape($q),"match_expr" => $db->escape($match_expr),"nb_pdt_results" => 1,"nb_cat_results" => 1, "timestamp" => time());
      $db->query("INSERT INTO `user_searches` (`".implode("`,`",array_keys($user_searches_fields))."`) VALUES ('".implode("','",$user_searches_fields)."')", __FILE__, __LINE__);
      // saving this search
      $user_searches_fields = array("search_terms" => $db->escape($q),"match_expr" => $db->escape($match_expr),"nb_pdt_results" => $catResults['ttl_count'],"nb_cat_results" => $catResults['count'], "timestamp" => time());
      $db->query("INSERT INTO `user_searches` (`".implode("`,`",array_keys($user_searches_fields))."`) VALUES ('".implode("','",$user_searches_fields)."')", __FILE__, __LINE__);
      
      header("Location: ".URL."produits/".$single_pdt['catID']."-".$single_pdt['id']."-".$single_pdt['ref_name'].".html");
      exit(); 
    
    } elseif ($fieldsResults_total['count'] > 1) { // several results
    
    
  // --------------------------------------------------------------------------------
  // OFFSET COMPUTING
  // Loop 2 : Computing score offset depending on priorities
  // --------------------------------------------------------------------------------
      $mts['LOOP 2 : OFFSET COMPUTING']['start'] = microtime(true);
      $fkr = array_reverse($fk); // Fields Results Keys Reversed
      $scoreOffset = 0;
      for($i = 0; $i < $fkCount; $i++) {
        $results = &$fieldsResults[$fkr[$i]];
        if ($results['count'] == 0) continue;
        $results['offset_score'] = $scoreOffset;
        foreach($results['data'] as &$pdt)
          $pdt['offset_score'] = $pdt['score'] + $scoreOffset;
        unset($pdt);
        
        $scoreOffset += $results['max_score'];
      }
      unset($results);
      $mts['LOOP 2 : OFFSET COMPUTING']['end'] = microtime(true);
      
  // --------------------------------------------------------------------------------
  // CATEGORY GROUPING
  // Loop 3 : Initialising categories with score offset computation
  // --------------------------------------------------------------------------------
      $mts['LOOP 3 : CATEGORY GROUPING']['start'] = microtime(true);
      $catResults = array(
        "data" => array(),
        "count" => 0,
        "ttl_count" => 0,
        "avg_count" => 0);
      
      for($i = 0; $i < $fkCount; $i++) {
        $results = &$fieldsResults[$fk[$i]];
        if ($results['count'] == 0) continue;
        foreach($results['data'] as &$pdt) {
          if (!isset($catResults['data']["_".$pdt['catID']])) {
            // forcing the key to be a string with "_" to conserve it when using array_multisort
            $catResults['data']["_".$pdt['catID']] = array(
              "id" => $pdt['catID'],
              "data" => array(),
              "count" => 0,
              "max_score" => 0,
              "ttl_score" => 0,
              "ttl_score2" => 0,
              "scoref" => 0);
          }
          if (!isset($catResults['data']["_".$pdt['catID']]['data']["_".$pdt['id']])) {
            $catResults['data']["_".$pdt['catID']]['count']++;
            $catResults['data']["_".$pdt['catID']]['ttl_score'] += $pdt['offset_score'];
            $catResults['data']["_".$pdt['catID']]['data']["_".$pdt['id']] = array(
              "id" => $pdt['id'],
              "name" => $pdt['name'],
              "catID" => $pdt['catID'],
              "score" => $pdt['offset_score'],
              "hits" => $pdt['hits'],
              "orders" => $pdt['orders'],
              "leads" => $pdt['leads'],
              "hpd" => ($pdt['hits'] / $pdt['age'] * 86400),
              "hits2orders" => $pdt['hits'] > 0 ? $pdt['orders'] / $pdt['hits'] : 0,
              "hits2leads" => $pdt['hits'] > 0 ? $pdt['leads'] / $pdt['hits'] : 0);
          }
        }
        unset($pdt);
      }
      unset($results);
      $mts['LOOP 3 : CATEGORY GROUPING']['end'] = microtime(true);
      
    
  // --------------------------------------------------------------------------------
  // STATS COMPUTING
  // --------------------------------------------------------------------------------
      $mts['STATS COMPUTING']['start'] = microtime(true);
      // Setting some usefull vars
      $cat0 = $xPath->query("parent::categories",$dom->getElementById(XML_KEY_PREFIX."0"))->item(0);
      $stats_key = explode("|",$xPath->query("child::stats_key",$cat0)->item(0)->nodeValue);
      
      $stats = explode("|",$xPath->query("child::stats",$cat0)->item(0)->nodeValue);
      for($sk = 0, $slen = count($stats); $sk < $slen; $sk++) $global[$stats_key[$sk]] = $stats[$sk];
      
      $global['hits_avg'] = $global['hits'] / $global['pdt_count'];
      $global['leads_avg'] = $global['leads'] / $global['pdt_count'];
      $global['orders_avg'] = $global['orders'] / $global['pdt_count'];
      $global['hpd_avg'] = ($global['hits'] / $global['age_avg'] * 86400) / $global['pdt_count'];
      
      // Arbitrary user weight :
      // ----------------------------------------
      // Normal weight
      $hits2leads_w = 0.2;	// weight of products leads
      $hits2orders_w = 0.8;	// weight of products orders
      
      $global_w = 0.8;		// weight of the global(whole db) average hits/orders/...
      $cat1_w = 2.0;		// same for cat 1
      $cat2_w = 0.8;		// for cat 2
      $cat3_w = 0.4;		// for cat 3
      
      // Frequency weight if 2 times more
      $hits_freq_w2 = 1.1;				// 2 times more hits than average = 10% more weight
      $hitsPerDay_freq_w2 = 1.2;		// same for hits per day (ex: 20%)
      
      // Frequency for a category = it's relative part in the whole db
      $cat1_freq_w2 = 1.1;	// weight of a cat1 frequency relative to the average ; ex: if 2 times the average frequency, 10% more weight (1.1)
      $cat2_freq_w2 = 1.1;	// same for cat 2
      $cat3_freq_w2 = 1.1;	// for cat 3
      
      // Precalculating some vars
      // ----------------------------------------
      $hits_freq_w2p = log($hits_freq_w2, 2);
      $hitsPerDay_freq_w2p = log($hitsPerDay_freq_w2,2);
      $cat1_freq_w2p = log($cat1_freq_w2,2);
      $cat2_freq_w2p = log($cat2_freq_w2,2);
      $cat3_freq_w2p = log($cat3_freq_w2,2);
      $cat1_freq_c = pow(1/(1/(int)$global['cat1_count']),$cat1_freq_w2p); // Coef to normalize to 1 if the frequency of the current cat 1 is the same as the average
      $cat2_freq_c = pow(1/(1/(int)$global['cat2_count']),$cat2_freq_w2p); // same for cat 2
      $cat3_freq_c = pow(1/(1/(int)$global['cat3_count']),$cat3_freq_w2p); // for cat 3
      
      // Loop 4 : Sorting Categories Products by score + categories score computation
      foreach ($catResults['data'] as &$catData) {
        
        $ccat3 = $xPath->query("parent::category",$dom->getElementById(XML_KEY_PREFIX.$catData['id']))->item(0); // ccatX = current category level X in loop
        if ($ccat3 == null)
          continue;
        $catTree = $xPath->query("ancestor-or-self::category", $ccat3);
        $ccat1 = $catTree->item(0);
        $ccat2 = $catTree->item(1);
        
        $stats = explode("|",$xPath->query("child::stats",$ccat1)->item(0)->nodeValue);
        for($sk = 0, $slen = count($stats); $sk < $slen; $sk++) $scat1[$stats_key[$sk]] = $stats[$sk];
        $stats = explode("|",$xPath->query("child::stats",$ccat2)->item(0)->nodeValue);
        for($sk = 0, $slen = count($stats); $sk < $slen; $sk++) $scat2[$stats_key[$sk]] = $stats[$sk];
        $stats = explode("|",$xPath->query("child::stats",$ccat3)->item(0)->nodeValue);
        for($sk = 0, $slen = count($stats); $sk < $slen; $sk++) $scat3[$stats_key[$sk]] = $stats[$sk];
        //$scat1 = unserialize($xPath->query("child::stats",$ccat1)->item(0)->nodeValue);
        //$scat2 = unserialize($xPath->query("child::stats",$ccat2)->item(0)->nodeValue);
        //$scat3 = unserialize($xPath->query("child::stats",$ccat3)->item(0)->nodeValue);
        
        $scat1['hits_avg'] = $scat1['hits'] / $scat1['pdt_count'];
        $scat1['leads_avg'] = $scat1['leads'] / $scat1['pdt_count'];
        $scat1['orders_avg'] = $scat1['orders'] / $scat1['pdt_count'];
        $scat1['hpd_avg'] = ($scat1['hits'] / $scat1['age_avg'] * 86400) / $scat1['pdt_count'];

        $scat2['hits_avg'] = $scat2['hits'] / $scat2['pdt_count'];
        $scat2['leads_avg'] = $scat2['leads'] / $scat2['pdt_count'];
        $scat2['orders_avg'] = $scat2['orders'] / $scat2['pdt_count'];
        $scat2['hpd_avg'] = ($scat2['hits'] / $scat2['age_avg'] * 86400) / $scat2['pdt_count'];

        $scat3['hits_avg'] = $scat3['hits'] / $scat3['pdt_count'];
        $scat3['leads_avg'] = $scat3['leads'] / $scat3['pdt_count'];
        $scat3['orders_avg'] = $scat3['orders'] / $scat3['pdt_count'];
        $scat3['hpd_avg'] = ($scat3['hits'] / $scat3['age_avg'] * 86400) / $scat3['pdt_count'];

        // Computation :
        // ----------------------------------------
        // We calculate an "average" hits/orders/... per product using a lot of weighted coefficient computed from
        // the whole db (global), and the relative size of the current cat1, cat2 and cat3
        // k0 k1 k2 k3 = arbitrary coef * computed relative size coef
        // for hits :
        $h_k0 = $global_w;
        $h_k1 = $cat1_w * $cat1_freq_c * pow($scat1['hits']/$global['hits'], $cat1_freq_w2p);
        $h_k2 = $cat2_w * $cat2_freq_c * pow($scat2['hits']/$global['hits'], $cat2_freq_w2p);
        $h_k3 = $cat3_w * $cat3_freq_c * pow($scat3['hits']/$global['hits'], $cat3_freq_w2p);
        $final_hits_w_avg = ($h_k0*$global['hits_avg'] + $h_k1*$scat1['hits_avg'] + $h_k2*$scat2['hits_avg'] + $h_k3*$scat3['hits_avg']) / ($h_k0+$h_k1+$h_k2+$h_k3); // Final Weighted average hits per product

        // for leads :
        $l_k0 = $global_w;
        $l_k1 = $cat1_w * $cat1_freq_c * pow($scat1['leads']/$global['leads'], $cat1_freq_w2p);
        $l_k2 = $cat2_w * $cat2_freq_c * pow($scat2['leads']/$global['leads'], $cat2_freq_w2p);
        $l_k3 = $cat3_w * $cat3_freq_c * pow($scat3['leads']/$global['leads'], $cat3_freq_w2p);
        $final_leads_w_avg = ($l_k0*$global['leads_avg'] + $l_k1*$scat1['leads_avg'] + $l_k2*$scat2['leads_avg'] + $l_k3*$scat3['leads_avg']) / ($l_k0+$l_k1+$l_k2+$l_k3); // Final Weighted average leads per product

        // for orders :
        $o_k0 = $global_w;
        $o_k1 = $cat1_w * $cat1_freq_c * pow($scat1['orders']/$global['orders'], $cat1_freq_w2p);
        $o_k2 = $cat2_w * $cat2_freq_c * pow($scat2['orders']/$global['orders'], $cat2_freq_w2p);
        $o_k3 = $cat3_w * $cat3_freq_c * pow($scat3['orders']/$global['orders'], $cat3_freq_w2p);
        $final_orders_w_avg = ($o_k0*$global['orders_avg'] + $o_k1*$scat1['orders_avg'] + $o_k2*$scat2['orders_avg'] + $o_k3*$scat3['orders_avg']) / ($o_k0+$o_k1+$o_k2+$o_k3); // Final Weighted average orders per product

        // for hits per day :
        $final_hpd_w_avg = ($h_k0*$global['hpd_avg'] + $h_k1*$scat1['hpd_avg'] + $h_k2*$scat2['hpd_avg'] + $h_k3*$scat3['hpd_avg']) / ($h_k0+$h_k1+$h_k2+$h_k3); // Final Weighted average hitsPerDay per product

        // for hits to leads and hits to orders
        $final_hits2leads_w_freq = $final_hits_w_avg / $final_leads_w_avg;
        $final_hits2orders_w_freq = $final_hits_w_avg / $final_orders_w_avg;
        
        // Computing product selling score
        foreach ($catData['data'] as &$pdt) {
          $pdt['score2'] = ($pdt['hits2leads'] * $final_hits2leads_w_freq * $hits2leads_w + $pdt['hits2orders'] * $final_hits2orders_w_freq * $hits2orders_w)
            * pow($pdt['hits']/$final_hits_w_avg, $hits_freq_w2p)
            * pow($pdt['hpd']/$final_hpd_w_avg, $hitsPerDay_freq_w2p);
          $pdt['scoref'] = $pdt['score'] * $pdt['score2']; // final final, once weighted and multiplied by the relevant score
          $catData['ttl_score2'] += $pdt['score2'];
        }
        unset($pdt);
        
        /*print "<br/>\n<br/>\n";
        print $ccat1->getAttribute("name") . " | " . $ccat2->getAttribute("name") . " | " . $ccat3->getAttribute("name") . "<br/>\n";
        print "global_hits_avg = " . $global['hits_avg'] . "<br/>\n";
        print "cat1_hits_avg = " . $ccat1_hits_avg . "<br/>\n";
        print "cat2_hits_avg = " . $ccat2_hits_avg . "<br/>\n";
        print "cat3_hits_avg = " . $ccat3_hits_avg . "<br/>\n";
        print "h_k0 = " . $h_k0 . "<br/>\n";
        print "h_k1 = " . $h_k1 . "<br/>\n";
        print "h_k2 = " . $h_k2 . "<br/>\n";
        print "h_k3 = " . $h_k3 . "<br/>\n";
        print "final_hits2leads_w_freq = " . $final_hits2leads_w_freq . "<br/>\n";
        print "final_hits2orders_w_freq = " . $final_hits2orders_w_freq . "<br/>\n";
        print "final_orders_w_avg = " . $final_orders_w_avg . "<br/>\n";
        print "final_hpd_w_avg = " . $final_hpd_w_avg . "<br/>\n";
        print "<br/>\n<br/>\n";
        */
        Utils::sortDbInPlace($catData['data'], "score", SORT_DESC, SORT_NUMERIC, "score2", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING);
        $i = 0;
        foreach ($catData['data'] as &$pdt) {
          if ($i++ >= SEARCH_DETAILED_CAT_PDT_COUNT_MAX) break;
          $catData['scoref'] += $pdt['scoref']; // sum of product's final scores
        }
        unset($pdt);
        $ccat3Name = $ccat3->getAttribute("name");
        $catData['name_match'] = (int)preg_match($match_expr_regexp, Utils::toDashAz09($ccat3->getAttribute("name")));
        $catData['name_match'] += (int)preg_match($match_expr_regexp_start, Utils::toDashAz09($ccat3->getAttribute("name")));
        
        $firstPdt = reset($catData['data']);
        $catData['max_score'] = $firstPdt['score'];
        $catResults['ttl_count'] += $catData['count'];
      }
      unset($catData);
      $catResults['count'] = count($catResults['data']);
      $catResults['avg_count'] = $catResults['ttl_count'] / $catResults['count'];
      $mts['STATS COMPUTING']['end'] = microtime(true);
      
      // saving this search
      $user_searches_fields = array("search_terms" => $db->escape($q),"match_expr" => $db->escape($match_expr),"nb_pdt_results" => $catResults['ttl_count'],"nb_cat_results" => $catResults['count'], "timestamp" => time());
      $db->query("INSERT INTO `user_searches` (`".implode("`,`",array_keys($user_searches_fields))."`) VALUES ('".implode("','",$user_searches_fields)."')", __FILE__, __LINE__);
      
      // Final sorting by max score then average score	
      if ($catResults['count'] > 1)
        Utils::sortDbInPlace($catResults['data'], "name_match", SORT_DESC, SORT_STRING, "max_score", SORT_DESC, SORT_NUMERIC, "scoref", SORT_DESC, SORT_NUMERIC);
      
      
  // --------------------------------------------------------------------------------
  // DETERMININING THE PRODUCT DETAILED INFOS TO GET
  // --------------------------------------------------------------------------------

      // Getting a limited number of products to be showed, or all the products from a level 3 category
      $mts['GET PRODUCT DETAILED INFOS']['start'] = microtime(true);
      $pdtIDs = array(); // detailed product ID's to be loaded
      if ($catDetailID) {
        if (isset($catResults['data']['_'.$catDetailID])) { // one level 3 category to show
          $catData = &$catResults['data']['_'.$catDetailID];
          foreach($catData['data'] as &$pdt)
            $pdtIDs[] = $pdt['id'];
          unset($catData, $pdt);
        }
      } else {
        foreach($catResults['data'] as $catData) {
          foreach($catData['data'] as $pdt) {
            $pdtIDs[] = $pdt['id'];
          }
        }
      }
      
      
      if (!empty($pdtIDs)) {
  // --------------------------------------------------------------------------------
  // GETTING PRODUCT DETAILED INFOS
  // --------------------------------------------------------------------------------
        // Shipping fee
        $res = $db->query("select config_name, config_value from config where config_name = 'fdp' or config_name = 'fdp_franco' or config_name = 'fdp_sentence'", __FILE__, __LINE__ );
        while ($rec = $db->fetch($res)) {
          $$rec[0] = $rec[1];
        }
        
        // Getting detailed information for showed products
        $res = $db->query("
          SELECT
            p.id, p.price as pdt_price, p.timestamp, p.shipping_fee,
            pfr.name, pfr.ref_name, pfr.fastdesc, pfr.delai_livraison AS delivery_time,
            pf.idFamily as catID,
            a.id as adv_id, a.nom1 as adv_name, a.category as adv_cat, a.delai_livraison as adv_delivery_time,
            rc.id as ref_idtc, rc.refSupplier as ref_refSupplier, rc.price+rc.ecotax as ref_price, (p.as_estimate + a.as_estimate) as product_as_estimate,
            (select count(idProduct) from references_content where idProduct = p.id) as nb_refs
          FROM products p
          INNER JOIN products_fr pfr ON p.id = pfr.id AND pfr.active = 1 AND pfr.deleted != 1
          INNER JOIN products_families pf ON p.id = pf.idProduct
          INNER JOIN advertisers a ON p.idAdvertiser = a.id AND a.actif = 1
          LEFT JOIN references_content rc ON p.id = rc.idProduct and rc.classement = 1 AND rc.vpc = 1 AND rc.deleted = 0
          WHERE p.id in (" . implode(",", $pdtIDs) . ")", __FILE__, __LINE__);
        
        $pdtInfos = array();
        while ($pdt = $db->fetchAssoc($res)) {
          $pdt['saleable'] = $pdt['hasPrice'] = false;
          $pdt['price'] = $pdt['pdt_price'];
          if ($pdt['price'] == "ref") {
            $pdt['price'] = $pdt['ref_price'];
          }
          if (empty($pdt['price'])) {
            $pdt['price'] = "sur devis";
          }
          elseif (preg_match('/^[0-9]+((\.|,)[0-9]+){0,1}$/', $pdt['price'])) { // real price
            $pdt['hasPrice'] = true;
            if ($pdt['adv_cat'] == __ADV_CAT_SUPPLIER__) {
              $pdt['saleable'] = true;
            }
          }
          else {
            $pdt['price'] = "sur devis";
          }
          
          $pdt['shipping_fee'] = empty($pdt['shipping_fee']) ? ($pdt['shipping_fee'] = $pdt['hasPrice'] ? ($pdt['price'] > $fdp_franco ? "Offert" : $fdp." € HT") : "N/D") : $pdt['shipping_fee']." € HT";
          if (empty($pdt['delivery_time'])) $pdt['delivery_time'] = $pdt['adv_delivery_time'];
          
          $pdtInfos[$pdt['id']] = $pdt;
        }
        $mts['GET PRODUCT DETAILED INFOS']['end'] = microtime(true);
      
      
  // --------------------------------------------------------------------------------
  // SETTING CAT/PDT TO SHOW VARS
  // Setting hash table var with all the products to show on the page
  // --------------------------------------------------------------------------------
        $mts['SETTING CAT/PDT TO SHOW VARS']['start'] = microtime(true);
        
        // getting all corresponding categories infos
        $catList = array();
        foreach ($catResults['data'] as &$catData) {
          $ccat3 = $xPath->query("parent::category",$dom->getElementById(XML_KEY_PREFIX.$catData['id']))->item(0);
          if ($ccat3 == null)
            continue;
          $catData['name'] = $ccat3->getAttribute('name');
          $catList[] = &$catData;
        }
        unset($catData);
        $catListLen = count($catList);
        
        // base products list before any filtering
        $pdtListFull = array();
        if (!$catDetailID) {
          foreach ($catResults['data'] as &$catData) {
            foreach ($catData['data'] as &$pdt)
              $pdtListFull[] = &$pdt;
            unset($pdt);
          }
          unset($catData);
        } else {
          $catData = &$catResults['data']['_'.$catDetailID];
          foreach ($catData['data'] as &$pdt)
            $pdtListFull[] = &$pdt;
          unset($pdt);
        }
        
        // Getting filter/sort/.. vars
        $page   = isset($_GET['page'])   ? (int)(trim($_GET['page'])) : 1;
        $sort   = isset($_GET['sort'])   ? trim($_GET['sort']) : "";
        $filter = isset($_GET['filter']) ? trim($_GET['filter']) : "";
        $range  = isset($_GET['range'])  ? (preg_match("/^[0-9]+-[0-9]+$/", $_GET['range']) ? $_GET['range'] : "") : "";
        switch ($filter) {
          case "all" : break;
          case "saleable" : break;
          case "partner" : break;
          case "price" : if (!empty($range)) list($minPrice, $maxPrice) = explode("-", $range); break;
          default : $filter = "";
        }
        $urlOpt = array();
        if (!empty($filter)) $urlOpt['filter'] = "filter=".$filter;
        if (!empty($range)) $urlOpt['filter'] .= "&range=".$range;
        
        // final filtered product list to be shown with usefull vars
        $pdtList = array(
          'data' => array(),
          'count' => 0,
          'totalCount' => 0,
          'saleableCount' => 0,
          'advCatCount' => array(),
          'priceSum' => 0,
          'priceCount' => 0,
          'priceMax' => 0,
          'priceMin' => 0x7fffffff
        );
        foreach ($pdtListFull as $pdt) {
          $pdt = array_merge($pdtInfos[$pdt['id']], $pdt);
          
          // vars for price/saleable filtering
          if ($pdt['hasPrice']) {
            $pdtList['priceCount']++;
            $pdtList['priceSum'] += $pdt['price'];
            $pdtList['priceMax'] = max($pdt['price'], $pdtList['priceMax']);
            $pdtList['priceMin'] = min($pdt['price'], $pdtList['priceMin']);
            if ($pdt['saleable'])
              $pdtList['saleableCount']++;
          }
          
          // product per partner
          if (!isset($pdtList['advCatCount'][$pdt['adv_cat']]))
            $pdtList['advCatCount'][$pdt['adv_cat']] = 0;
          $pdtList['advCatCount'][$pdt['adv_cat']]++;
          
          // Filtering
          $show = true;
          switch ($filter) {
            case "saleable" : if (!$pdt['saleable']) $show = false; break;
            case "partner"  : if ($pdt['adv_cat'] == __ADV_CAT_SUPPLIER__) $show = false; break;
            case "price" : if (!$pdt['hasPrice'] || $pdt['price'] < $minPrice || $pdt['price'] >= $maxPrice) $show = false; break;
            default : break;
          }
          if ($show) {
            $pdt['url'] = Utils::get_pdt_fo_url($pdt['id'], $pdt['ref_name'], $pdt['catID']);
            $pdt['pic_url'] = Utils::get_pdt_pic_url($pdt['id'], 'thumb_big');
            $pdt['cart_add_url'] = "panier:".$pdt['catID']."-".$pdt['id']."-".$pdt['ref_idtc'];
            $pdt['set_as_estimate'] = $pdt['price'] >= __THRESHOLD_PRICE_FOR_ESTIMATE__ || $pdt['product_as_estimate'];
            $pdtList['data'][] = $pdt;
            $pdtList['count']++;
          }
          $pdtList['totalCount']++;
          
        }
        
        if ($pdtList['count']) { // there is products to show
          // price sort options
          $showPriceSortBlock = $pdtList['priceCount'] > 1;
          
          // price filtering block
          $showPriceFilterBlock = $pdtList['priceCount'] > 4;
          if ($showPriceFilterBlock) {
          // Bayesian average of every products
            $bayesianAvg = (GLOBAL_AVERAGE_PRICE * TYPICAL_DATA_SET_SIZE + $pdtList['priceSum']) / ($pdtList['priceCount'] + TYPICAL_DATA_SET_SIZE);
            $priceBayesMean = round($bayesianAvg, -2);
            $priceMin = floor($pdtList['priceMin']);
            if ($priceMin % 100 != 0)
              $priceMin = $priceMin - $priceMin % 100;
            $priceMax = ceil($pdtList['priceMax']);
            if ($priceMax % 100 != 0)
              $priceMax = $priceMax - $priceMax % 100 + 100;
            // CHANGE HERE
            $priceRange1 = ($priceBayesMean + $priceMin) / 2;
            $priceRange2 = ($priceBayesMean + $priceMax) / 2;
          }
          
          define('NB', 50);
          define('GLOBAL_AVERAGE_PRICE', 700);
          define('TYPICAL_DATA_SET_SIZE', 10);
          
          // Page calculations
          $pageBorderRange = 5;
          if ($page < 1) $page = 1;
          $maxpage = floor((($pdtList['count']-1) - ($pdtList['count']-1)%NB) / NB) + 1;
          if ($page > $maxpage) $page = $maxpage;
          if ($page > 1) $urlOpt['page'] = "page=".$page;
                    
          $minBorderPage = $page>$pageBorderRange ? (($pageBorderRange-$page)<1 ? ($maxpage<= $pageBorderRange*2+1 ? 1 : $page-$pageBorderRange) :$pageBorderRange-$page) : 1;
          $minBorderPage = $maxpage-$minBorderPage < ($pageBorderRange*2+1) && $maxpage>$pageBorderRange*2+1 ? $maxpage-$pageBorderRange*2 : $minBorderPage;
          $maxBorderPage = $maxpage<$pageBorderRange*2+1 ? $maxpage : ($minBorderPage+$pageBorderRange*2+1>$maxpage ? $maxpage :$page+$pageBorderRange);
          if($maxpage >= $pageBorderRange*2+1)
            $maxBorderPage = ($page<=$pageBorderRange) ? $pageBorderRange*2+1 : ($page+$pageBorderRange>$maxpage ? $maxpage : $page+$pageBorderRange);
          
          // Items to show
          $startItemIndex = ($page-1) * NB;
          $endItemIndex = min($page * NB, $pdtList['count']) - 1;
          $DisplayedItemCount = $endItemIndex - $startItemIndex + 1;
          
          switch ($sort) {
            case "updated"    : Utils::sortDbInPlace($pdtList['data'], "timestamp", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
            case "view"       : Utils::sortDbInPlace($pdtList['data'], "hits", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
            case "lead"       : Utils::sortDbInPlace($pdtList['data'], "leads", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
            case "price-asc"  : Utils::sortDbInPlace($pdtList['data'], "price", SORT_ASC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
            case "price-desc" : Utils::sortDbInPlace($pdtList['data'], "price", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
            case "relevant"   :
            default :
              $sort = "";
              Utils::sortDbInPlace($pdtList['data'], "scoref", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING);
              break;
          }
          if (!empty($sort)) $urlOpt['sort'] = "sort=".$sort;
          
          //$urlOpt['all'] = empty($urlOpt) ? "" : "&".implode("&", $urlOpt);
          if (!empty($urlOpt['page'])) $urlOpt['page'] = "&".$urlOpt['page'];
          if (!empty($urlOpt['sort'])) $urlOpt['sort'] = "&".$urlOpt['sort'];
          if (!empty($urlOpt['filter'])) $urlOpt['filter'] = "&".$urlOpt['filter'];
          
          // criteo first 3 products
          $criteo = array('pdt_ids' => array());
          for ($k=$startItemIndex, $l=min($startItemIndex+2,$endItemIndex); $k<=$l; $k++)
            $criteo['pdt_ids'][] = $pdtList['data'][$k]['id'];
          
        } // pdtList not empty
        $mts['SETTING CAT/PDT TO SHOW VARS']['end'] = microtime(true);
        
      } // end pdtIDs not empty
    
    } else { // no results from queries
      // saving this search
      $user_searches_fields = array("search_terms" => $db->escape($q),"match_expr" => $db->escape($match_expr),"nb_pdt_results" => $catResults['ttl_count'],"nb_cat_results" => $catResults['count'], "timestamp" => time());
      $db->query("INSERT INTO `user_searches` (`".implode("`,`",array_keys($user_searches_fields))."`) VALUES ('".implode("','",$user_searches_fields)."')", __FILE__, __LINE__);
    }
    
    $mts['TOTAL TIME']['end'] = microtime(true);
  
  } // ql >= 3

  $showFilterBlocks = true;
  // no direct result, we perform an autocompletion search
  if (!isset($pdtList) || !$pdtList['count']) {
    $showFilterBlocks = false;
    define("MAX_AUTOCOMPLETION_RESULTS", 30);
    define("AUTOCOMPLETION_CATEGORIES_RESULT_COUNT", 10);
    define("AUTOCOMPLETION_PRODUCTS_TITLE_RESULT_COUNT", 20);

    $terms = preg_split("`\s|-`", Utils::noDiphthong(urldecode($q)));
    for ($i = 0; $i < count($terms); $i++) {
      if (Utils::is_plural($terms[$i])) {
        $terms[$i] = "".Utils::get_singular($terms[$i])."* <<".$terms[$i]."*";
      }
      else
        $terms[$i] = $terms[$i]."*";
      if ($i == 0) $terms[$i] = ">".$terms[$i];
    }
    $match_expr = mb_convert_encoding(implode(" ", $terms), "ISO-8859-1", "UTF-8");

    if ($ql >= 1) {

      $results = array("total" => array("count" => 0, "start_time" => microtime(true), "end_time" => 0));

    // Search in categories
      $results['categories'] = array("data" => array(), "count" => 0, "start_time" => microtime(true), "end_time" => 0);
      if ($results['total']['count'] < MAX_AUTOCOMPLETION_RESULTS) {
        $ressource = $db->query("
          SELECT
            ffr.name, ffr.ref_name,
            MATCH (ffr.name) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE) AS score,
            (SELECT count(idProduct) FROM products_families pf inner join products_fr pfr ON pfr.id = pf.idProduct where idFamily = ffr.id and pfr.deleted != 1) AS count_product
          FROM
            families_fr ffr
          WHERE
            MATCH (ffr.name) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE)
          ORDER BY
            score DESC, ffr.name ASC");

        $results['categories']['end_time'] = microtime(true);
        while ($result = $db->fetchAssoc($ressource)) {
          array_push($results['categories']['data'], array($result['name'],$result['ref_name'],$result['count_product']));
          $results['categories']['count']++;
          $results['total']['count']++;
          if ($results['categories']['count'] >= AUTOCOMPLETION_CATEGORIES_RESULT_COUNT) break;
          if ($results['total']['count'] >= MAX_AUTOCOMPLETION_RESULTS) break;
        }
      }

      // Search in products titles
      $results['products-title'] = array("data" => array(), "count" => 0, "start_time" => microtime(true), "end_time" => 0);
      if ($results['total']['count'] < MAX_AUTOCOMPLETION_RESULTS) {
        $ressource = $db->query("
          SELECT
            pfr.name, count(pfr.id) AS count_ref, pfr.id, pfr.fastdesc, pfr.ref_name,
            (SELECT idFamily FROM products_families pf WHERE pf.idProduct = pfr.id limit 0,1) AS idFamily,
            MATCH (pfr.name) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE) AS score
          FROM
            products_fr pfr, advertisers a
          WHERE
            pfr.idAdvertiser = a.id AND
            a.actif = 1 AND
            pfr.deleted != 1 AND
            MATCH (pfr.name) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE)
          GROUP BY pfr.ref_name
          ORDER BY score DESC, pfr.name ASC");

        $results['products-title']['end_time'] = microtime(true);
        while ($result = $db->fetchAssoc($ressource)) {
          array_push(
            $results['products-title']['data'],
            array(
              $result['name'],
              $result['count_ref'],
              $result['id'],
              $result['fastdesc'],
              $result['ref_name'],
              $result['idFamily'],
              $result['id']
            )
          );
          $results['products-title']['count']++;
          $results['total']['count']++;
          if ($results['products-title']['count'] >= AUTOCOMPLETION_PRODUCTS_TITLE_RESULT_COUNT) break;
          if ($results['total']['count'] >= MAX_AUTOCOMPLETION_RESULTS) break;
        }
      }

      // Search in IDTC
      $results['references-idtc'] = array("data" => array(), "count" => 0, "start_time" => microtime(true), "end_time" => 0);
      if ($results['total']['count'] < MAX_AUTOCOMPLETION_RESULTS) {
        $ressource = $db->query("
        SELECT
          rc.id, rc.classement, rc.idProduct, pfr.name, pfr.ref_name, pf.idFamily, count(rc.id) AS count_id,  pfr.fastdesc
        FROM
          references_content rc, products_fr pfr, products_families pf, advertisers a
        WHERE
          rc.idProduct = pfr.id AND
          pfr.id = pf.idProduct AND
          pfr.idAdvertiser = a.id AND
          a.actif = 1 AND
          pfr.deleted != 1 AND
          MATCH (rc.id) AGAINST ('" . $db->escape($match_expr) . "' IN BOOLEAN MODE)
        GROUP BY rc.id
        ORDER BY rc.id ASC");

        $results['references-idtc']['end_time'] = microtime(true);
        while ($result = $db->fetchAssoc($ressource)) {
          array_push(
            $results['references-idtc']['data'],
            array(
              $result['name'].' '.$result['id'],
              $result['count_id'],
              $result['id'],
              $result['fastdesc'],
              $result['ref_name'],
              $result['idFamily'],
              $result['idProduct']
            )
          );
          $results['references-idtc']['count']++;
          $results['total']['count']++;
          if ($results['total']['count'] >= MAX_AUTOCOMPLETION_RESULTS) break;
        }
      }

      $results['total']['end_time'] = microtime(true);

      $out['categories'] = $results['categories']['data'];// $results['products-title']['data'], $results['references-idtc']['data']);
      $out['products'] = array_merge($results['products-title']['data'], $results['references-idtc']['data']);
      
      // criteo first 3 products
      $criteo = array('pdt_ids' => array());
      for ($k=0, $l=min(3,count($out['products'])); $k<$l; $k++)
        $criteo['pdt_ids'][] = $out['products'][$k][6];
    }
  }

} // not user search or user search found

$cq_url = URL."rechercher.html?search=".urlencode($q);
$cqf_url = $cq_url . ($catDetailID ? "&catDetailID=".$catDetailID : "");
$pageName = "rg";

define("NOINDEX_FOLLOW", true);
require(SITE . "head.php");
$session->avail_saveSearch = $q; // Avail
?>

<div id="body" class="white-bg">
  
  <div class="categories" id="left-col">
    
    <div class="left-panel">
      <?php if (!empty($msl)) : ?>
      <div class="mini-stores-list">
        <div class="title">Espaces thématiques</div>
        <ul>
        <?php foreach($msl as $ms) : ?>
          <li><a href="<?php echo URL."miniboutiques/".$ms['id']."-".$ms['ref_name'].".html"; ?>"><?php echo $ms['name']; ?></a></li>
        <?php endforeach ?>
        </ul>
      </div>
      <?php endif ?>

     <?php if ($showFilterBlocks) : ?>
      <div id="search-cat-filtering">
        <div class="pdt-filtering-title">Rayons concernés</div>
        <ul class="cat3-cat-filtering">
          <li><a href="<?php echo $cq_url.$urlOpt['sort'].$urlOpt['page']; ?>">Toutes les familles</a></li>
        <?php foreach ($catList as $cat) : ?>
          <li<?php if ($catDetailID == $cat['id']) {?> class="current"<?php } ?>>
            <a href="<?php echo $cq_url."&catDetailID=".$cat['id'].$urlOpt['sort'].$urlOpt['page']; ?>"><?php echo $cat['name']; ?> <span class="color-lightgrey">(<?php echo $cat['count']; ?>)</span></a>
          </li>
        <?php endforeach ?>
        </ul>
      </div>
     <?php endif // show filter blocks ?>
   
    </div>
    <script type="text/javascript">
      $("#search-cat-filtering").find("input[type='checkbox']").change(function(){
        window.location.href = "<?php echo $cq_url; ?>" + ($(this).prop("checked") ? "&catDetailID="+$(this).data('cat_id') : "");
      });
    </script>
    
    <div class="right-panel">
      <div class="search-results">
       
       <?php if ($pdtList['count']) { ?>
        
        <div class="bigger-blue-title margin-top-11">
          Résultat de votre recherche &laquo; <?php echo to_entities($q); ?> &raquo;
         <?php if ($catDetailID) : ?>
          dans la famille <?php echo $cur_cat->getAttribute('name') ?>
         <?php endif ?>
        </div>
        <div class="categories">
          <div class="zero"></div>
          
          <div id="search-pagination-block">
            <div class="search-pdt-count"><?php echo ($startItemIndex+1); ?> - <?php echo ($endItemIndex+1); ?> sur <?php echo $pdtList['count'];?></div>
           
           <?php if ($showPriceSortBlock) : ?>
            <div class="filter-sort">
              Trier par : <select class="search-price-sort">
                <option value=""></option>
                <option value="price-asc"<?php echo ($sort=="price-asc"?' selected="selected"':"") ?>>Prix - / +</option>
                <option value="price-desc"<?php echo ($sort=="price-desc"?' selected="selected"':"") ?>>Prix + / -</option>
              </select>
            </div>
           <?php endif ?>
           
            <div class="page-list">
              <img src="<?php echo URL; ?>ressources/images/pagination-bg-left.png" alt="" class="fl" />
              <div class="page-links">
             <?php for ($k = $minBorderPage; $k <= $maxBorderPage; $k++): ?>
               <?php if ($k == $page) : ?>
                <span class="cat3-current-page cat3-pagination-page"><?php echo $k; ?></span>
               <?php else : ?>
                <a class="pagination-link" href="<?php echo $cqf_url."&page=".$k.$urlOpt['filter'].$urlOpt['sort']; ?>"><?php echo $k; ?></a>
               <?php endif ?>
             <?php endfor ?>
              </div>
              <img src="<?php echo URL; ?>ressources/images/pagination-bg-right.png" alt="" class="pagination-bg-right" />
            </div>
            
            <div class="zero"></div>
          </div>

          <div class="pdt-list">
           <?php for ($k=$startItemIndex; $k<=$endItemIndex; $k++) { $pdt = $pdtList['data'][$k]; ?>
            <?php
   // set if product is set as default estimate
    $pdt_set_as_estimate = false;
    if($pdt['price'] >= __THRESHOLD_PRICE_FOR_ESTIMATE__) $pdt_set_as_estimate = true;
    if($pdt['product_as_estimate']) $pdt_set_as_estimate = true;
    ?>
            <div class="grey-block">
              <div class="fl cat3-prod-list-pic">
                <div class="picture fl">
                  <div class="cat3-picture-border">
                    <a href="<?php echo $pdt['url']; ?>"><img src="<?php echo $pdt['pic_url']; ?>" alt="" class="vmaib"/></a><div class="vsma"></div>
                    <div class="cat3-product-show"></div>
                  </div>
                <?php if ($pdt['adv_cat'] == __ADV_CAT_SUPPLIER__ ) : ?>
                  <div class="conseils-d-experts">
                    <img alt="Bénéficiez du conseil d'experts sur ce produit" src="<?php echo URL; ?>ressources/images/picto-supplier.png" class="vmaib fl">
                    <span class="fr">Bénéficiez du conseils<br />d'experts sur ce produit</span>
                  </div>
                <?php else : ?>
                  <div class="plusieurs-devis">
                    <img alt="Gagnez du temps en recevant plusieurs devis" src="<?php echo URL; ?>ressources/images/picto-advertiser.png" class="vmaib fl">
                    <span class="fr">Gagnez du temps,<br /> en recevant plusieurs devis</span>
                  </div>
                <?php endif ?>
                </div>

                <div class="fr cat3-prod-list-infos">
                  <h2><a class="blue-small-title blue-smaller-title" href="<?php echo $pdt['url']; ?>"><?php echo $pdt['name'] ?></a></h2>
                  <?php echo $pdt['fastdesc']; ?>
                  <?php if ($pdt['adv_cat'] == __ADV_CAT_SUPPLIER__ ) { ?>
                  <p class="cat3-checked-line"><img src="<?php echo URL; ?>ressources/images/green-check.png" alt="" />Livraison: <?php echo $pdt['delivery_time']; ?></p>
                    <?php if(!$pdt['set_as_estimate']) { ?>
                    <p class="cat3-checked-line"><img src="<?php echo URL; ?>ressources/images/green-check.png" alt="" />Frais de port: <strong><?php echo $pdt['shipping_fee']; ?></strong></p>
                    <?php }?>
                 <?php } ?>
                  <?php if(!empty ($pdt['average_note'])) {
                    echo '<span class="cat3-checked-line"><img src="'.URL.'ressources/images/picto-avis.png" alt="picto-avis" /> Avis client ';
                    showStarRater($pdt['average_note']);
                    echo ' <a class="color-blue ShowProductFeedback" href="'.$pdt['id'].'">Lire les avis</a></span>';
                  } ?>
                </div>
              </div>
        
              <div class="fr cat3-prod-list-relations">
                <div class="cat3-price">
                  <?php echo ($pdt['hasPrice'] ? ($pdt['set_as_estimate'] ? 'Sur devis' : 'à partir de : <span>'.sprintf("%.02f",$pdt['price'])."€ HT</span>") : 'à partir de : <span>'.$pdt['price'].'</span>'); ?>
                </div>
                <div class="cat3-action">
                  <a href="<?php echo $pdt['cart_add_url']; ?>" class="<?php if ($pdt['saleable'] && !$pdt['set_as_estimate']) { echo $pdt['nb_refs'] > 1 ? 'btn-cart-add-big-pink': 'btn-cart-add-small-single'; } else { ?>btn-esti-ask-orange<?php } ?>" data-adv-type="<?php echo $pdt['adv_cat']; ?>" ></a>
                 <?php if ($pdt['adv_cat'] == __ADV_CAT_SUPPLIER__ ) : ?>
                  <a href="<?php echo $pdt["cart_add_url"]; ?>" data-adv-type="<?php echo $pdt["adv_cat"]; ?>" class="ask-estimate-link"><div class="puce puce-4"></div>Demander un devis</a>
                 <?php endif ?>
                  <div class="savedProductsListZone_<?php echo $pdt['id'] ?>">
                    <?php $productList = new ProductsSavedList();
                    if ($productList->isProductInSavedList($pdt['id'])) : ?>
                    <div class="puce puce-9"></div><span class="color-green">Produit sauvegardé</span>
                    <a href="<?php echo $session->logged ? COMPTE_URL.'saved-products-list.html' : URL.'liste-produits-sauvegardes.html';?>" class="color-blue">Voir liste</a>
                   <?php else : ?>
                    <a href="saveProductList:add-<?php echo $pdt['id']; ?>" class="btn-users-product-list"><div class="puce puce-5"></div>Sauvegarder ce produit</a>
                   <?php endif; ?>
                  </div>
                </div>
              </div>
              <div class="zero"></div>
            </div>
           <?php } unset($pdt); ?>
          </div>
          <div class="zero"></div>

          <div id="search-pagination-block">
            <div class="search-pdt-count"><?php echo ($startItemIndex+1); ?> - <?php echo ($endItemIndex+1); ?> sur <?php echo $pdtList['count'];?></div>

           <?php if ($showPriceSortBlock) : ?>
            <div class="filter-sort">
              Trier par : <select>
                <option name=""></option>
                <option name="sort-price-asc" <?php echo ($sort=="price-asc"?'selected="selected"':"") ?>>Prix - / +</option>
                <option name="sort-price-desc"<?php echo ($sort=="price-desc"?'selected="selected"':"") ?>>Prix + / -</option>
              </select>
            </div>
           <?php endif ?>

            <div class="page-list">
              <img src="<?php echo URL; ?>ressources/images/pagination-bg-left.png" alt="" class="fl" />
              <div class="page-links">
              <?php for ($k = $minBorderPage; $k <= $maxBorderPage; $k++): ?>
                 <?php if ($k == $page) : ?>
                  <span class="cat3-current-page cat3-pagination-page"><?php echo $k; ?></span>
                 <?php else : ?>
                  <a class="pagination-link" href="<?php echo $cqf_url."&page=".$k.$urlOpt['filter'].$urlOpt['sort']; ?>"><?php echo $k; ?></a>
                 <?php endif ?>
               <?php endfor ?>
              </div>
              <img src="<?php echo URL; ?>ressources/images/pagination-bg-right.png" alt="" class="pagination-bg-right" />
            </div>
            <div class="zero"></div>
          </div>
        </div><!-- categories -->
        
        <div class="search-form-product-ask">
          <?php include_once('form-demande-recherche-produit.html'); // Formulaire demande de recherche produit moteur de recherche 06/05/2011 OD ?>
        </div>
       
       <?php } elseif (!$last_user_search || $last_user_search_found) { // pdtList empty ?>
       
        <div class="search-bottom-form">
        <?php if ($fieldsResults_total['count'] == 0) { ?>
          <div class="search-sorry blue-title blue-smaller-title">Désolé, nous n'avons pas de résultat pour votre recherche &laquo; <?php echo to_entities($q); ?> &raquo;.</div>
          <br/>
          <div id="show-autocomplete-search-results" class="grey-block">
            <div class="blue-title">Peut-être cherchiez-vous ?</div>
           
           <?php if (!empty($out['categories'])) : ?>
            <div class="autocomplete-search-results-third-col">
             <?php foreach ($out['categories'] as $cat) : ?>
               <?php if ($cat[2] > 0) : ?>
                <a href="<?php echo URL."familles/".$cat[1].".html" ?>"><?php echo $cat[0]." (".$cat[2].")" ?></a><br />
               <?php endif ?>
             <?php endforeach ?>
            </div>
           <?php endif // not empty categories ?>
           
           <?php if (!empty($out['products'])) : ?>
            <div class="autocomplete-search-results-third-col">
           <?php $a = 0; foreach($out['products'] as $prod) : ?>
            <?php if (!empty($prod[5]) && !empty($prod[2]) && !empty($prod[4])) { ?>
              <a href="<?php echo Utils::get_pdt_fo_url($prod[2], $prod[4], $prod[5]) ?>"><?php echo $prod[0] ?></a>
             <?php if ($a == count($out['products'])/2) : ?>
            </div>
            <div class="autocomplete-search-results-third-col">
             <?php else : ?>
              <br />
             <?php endif ?>
            <?php } $a++; ?>
           <?php endforeach ?>
            </div>
            <div class="zero"></div>
           <?php endif // not empty product ?>
          </div>
          <?php $form_pdt_search_origin = "recherche"; include_once('form-demande-recherche-produit.html'); // Formulaire demande de recherche produit moteur de recherche 06/05/2011 OD ?>
          <br />
        <?php } else { ?>
          <div class="search-sorry blue-title blue-smaller-title">Aucun produit correspondant aux critères de recherche n'est présent dans cette sous-famille</div>
        <?php } ?>
        </div>
        
       <?php } else { // search must be in the last user searches, but was not found ?>
        <div class="summary">
          <br/>
          Vous n'avez pas trouvé ce que vous cherchiez ? <a href="<?php echo URL;?>contact.html">Contactez nous</a>
        </div>
       <?php } ?>

      </div><!-- search-results -->
    
    </div><!-- right-panel -->

    <div id="cat3-show-product-infos-dialog" title=""></div>
    
  </div><!-- categories -->
  
  <?php require(SITE . "blocks-right.php"); ?>
  
  <div class="clear"></div>

</div><!-- white-bg -->
<div id="cart-add-product-dialog" title="Choisir mon modèle"></div>
<script type="text/javascript">
$(function(){
  $(".search-price-sort").change(function(){
    window.location.href = "<?php echo $cqf_url.$urlOpt['filter'] ?>"+($(this).val() != "" ? "&sort="+$(this).val() : "")+"<?php echo $urlOpt['page'] ?>";
  });
});
</script>
<?php	if (SHOW_TAGS) { ?>
<script type="text/javascript">
xt_mtcl = "<?php echo to_entities($q) ?>";    //keyword value
//do not modify below
if (window.xtparam!=null){window.xtparam+="&mc="+xt_mtcl;}
else{window.xtparam ="&mc="+xt_mtcl;};
</script>
<?php	} ?>

<?php require(SITE . "foot.php") ?>
<?php if (DEBUG) { foreach($mts as $mtn => $mt) print $mtn . " = <b>" . ($mt['end']-$mt['start'])*1000 . "ms</b><br/>\n"; } ?>