<?php
require_once substr(dirname(__FILE__),0,strpos(dirname(__FILE__),'/',stripos(dirname(__FILE__),'technico')+1)+1).'config.php';

header("Content-type: text/html; charset: UTF-8");

if (!isset($_GET["id"]) || !preg_match("/^[1-9]?[0-9]*$/", $_GET["id"])) {
  require("404.php");
  exit();
}

include_once(LANG_LOCAL_INC."meta-titles-".DB_LANGUAGE."_local.php");

$ms = new MiniStore($_GET["id"]);
if (!$ms->existsInDB) {
  require("404.php");
  exit();
}

$db = DBHandle::get_instance();

// Loading XML
$dom = new DomDocument();
$dom->validateOnParse = true;
$dom->load(XML_CATEGORIES_ALL);
$xPath = new DOMXPath($dom);

// Globals stats
$cat0 = $xPath->query("parent::categories",$dom->getElementById(XML_KEY_PREFIX."0"))->item(0);
$stats_key = explode("|",$xPath->query("child::stats_key",$cat0)->item(0)->nodeValue);
$stats = explode("|",$xPath->query("child::stats",$cat0)->item(0)->nodeValue);
for($sk = 0, $slen = count($stats); $sk < $slen; $sk++) $global[$stats_key[$sk]] = $stats[$sk];

// --------------------------------------------------------------------------------
// SELECTION/FAVOURITE/MOST VIEWED/LATEST PDT
// Getting the products ID from xml and/or from the DB
// --------------------------------------------------------------------------------
// Shipping fee
$res = $db->query("select config_name, config_value from config where config_name = 'fdp' or config_name = 'fdp_franco' or config_name = 'fdp_sentence'", __FILE__, __LINE__ );
while ($rec = $db->fetch($res)) {
  $$rec[0] = $rec[1];
}

if ($ms->type == "pdt") {
  
  $results = array("data" => array(), "count" => 0);
  
  $pdt_infos = array();
  foreach($ms->items as $item)
    $pdt_infos[$item['productID']] = array("catID" => $item["categoryID"], "order" => $item["order"]);
  
  $res = $db->query("
    SELECT
      p.id, p.price AS pdt_price, p.timestamp, p.shipping_fee,
      pfr.name, pfr.ref_name, pfr.fastdesc, pfr.delai_livraison AS delivery_time,
      ffr.id AS catID, ffr.ref_name AS cat_ref_name, ffr.name AS cat_name,
      ps.hits, ps.orders, ps.leads, (".mktime(0,0,0)."- ps.first_hit_time) as age,
      a.id AS adv_id, a.nom1 AS adv_name, a.category AS adv_cat, a.delai_livraison AS adv_delivery_time,
      rc.id AS ref_idtc, rc.refSupplier AS ref_refSupplier, rc.price+rc.ecotax AS ref_price,
      (p.as_estimate + a.as_estimate) as product_as_estimate
    FROM products p
    INNER JOIN products_fr pfr ON p.id = pfr.id AND pfr.active = 1
    INNER JOIN products_families pf ON p.id = pf.idProduct
    INNER JOIN families_fr ffr ON pf.idFamily = ffr.id
    INNER JOIN products_stats ps ON p.id = ps.id
    INNER JOIN advertisers a ON p.idAdvertiser = a.id AND a.actif = 1
    LEFT JOIN references_content rc ON p.id = rc.idProduct AND rc.classement = 1 AND rc.vpc = 1 AND rc.deleted = 0
    WHERE p.id in (".implode(",", array_keys($pdt_infos)).")
    GROUP BY p.id", __FILE__, __LINE__);
  
  // Fetching results
  while ($pdt = $db->fetchAssoc($res)) {
    $catID = $pdt_infos[$pdt["id"]]["catID"];
    $order = $pdt_infos[$pdt["id"]]["order"];
    $pdt_infos[$pdt["id"]] = $pdt;
    $pdt_infos[$pdt["id"]]["catID"] = $catID;
    $pdt_infos[$pdt["id"]]["order"] = $order;
    $results["data"][] = &$pdt_infos[$pdt["id"]];
    $results["count"]++;
  }
  
  if ($results["count"] > 0) {
    
    define("NB", 50);
    define("GLOBAL_AVERAGE_PRICE", 700);
    define("TYPICAL_DATA_SET_SIZE", 10);
    
    // GET's
    $page   = isset($_GET["page"])   ? (int)(trim($_GET["page"])) : 1;
    $sort   = isset($_GET["sort"])   ? trim($_GET["sort"]) : "";
    $filter = isset($_GET["filter"]) ? trim($_GET["filter"]) : "";
    $range  = isset($_GET["range"])  ? (preg_match("/^[0-9]+-[0-9]+$/", $_GET["range"]) ? $_GET["range"] : "") : "";
    switch ($filter) {
      case "all" : break;
      case "saleable" : break;
      case "partner" : break;
      case "price" : if (!empty($range)) list($minPrice, $maxPrice) = explode("-", $range); break;
      default : $filter = "";
    }
    $urlOpt = array();
    if (!empty($filter)) $urlOpt["filter"] = "filter=".$filter;
    if (!empty($range)) $urlOpt["filter"] .= "&range=".$range;
    
    // Loop for price calculation and filtering
    $pdtList = array(
      "data" => array(),
      "count" => 0,
      "totalCount" => 0,
      "saleableCount" => 0,
      "advCatCount" => array(),
      "advCatCountShowed" => array(),
      "priceSum" => 0,
      "priceCount" => 0,
      "priceCountShowed" => 0,
      "priceMax" => 0,
      "priceMin" => 0x7fffffff);
    
    foreach ($results["data"] as $k => &$pdt) {
      
      // Determing price
      $pdt["saleable"] = $pdt["hasPrice"] = false;
      $pdt["price"] = $pdt["pdt_price"];
      if ($pdt["price"] == "ref") {
        $pdt["price"] = $pdt["ref_price"];
      }
      if (empty($pdt["price"])) {
        $pdt["price"] = "sur devis";
      }
      elseif (preg_match('/^[0-9]+((\.|,)[0-9]+){0,1}$/', $pdt["price"])) { // real price
        $pdt["hasPrice"] = true;
        $pdtList["priceCount"]++;
        $pdtList["priceSum"] += $pdt["price"];
        $pdtList["priceMax"] = max($pdt["price"], $pdtList["priceMax"]);
        $pdtList["priceMin"] = min($pdt["price"], $pdtList["priceMin"]);
        if ($pdt["adv_cat"] == __ADV_CAT_SUPPLIER__) {
          $pdt["saleable"] = true;
          $pdtList["saleableCount"]++;
        }
      }
      else {
        $pdt["price"] = "sur devis";
      }
      
      // Filtering
      $show = true;
      switch ($filter) {
        case "saleable" : if (!$pdt["saleable"]) $show = false; break;
        case "partner"  : if ($pdt["adv_cat"] == __ADV_CAT_SUPPLIER__) $show = false; break;
        case "price" : if (!$pdt["hasPrice"] || $pdt["price"] < $minPrice || $pdt["price"] >= $maxPrice) $show = false; break;
        default : break;
      }
      
      if (!isset($pdtList["advCatCount"][$pdt["adv_cat"]])) $pdtList["advCatCount"][$pdt["adv_cat"]] = 0;
      $pdtList["advCatCount"][$pdt["adv_cat"]]++;
      
      if ($show) {
        if (!isset($pdtList["advCatCountShowed"][$pdt["adv_cat"]])) $pdtList["advCatCountShowed"][$pdt["adv_cat"]] = 0;
        $pdtList["advCatCountShowed"][$pdt["adv_cat"]]++;
        
        $pdt["hpd"] = ($pdt["hits"] / $pdt["age"] * 86400);
        if ($pdt["hits"] > 0) {
          $pdt["hits2orders"] = $pdt["orders"] / $pdt["hits"] * 100;
          $pdt["hits2leads"] = $pdt["leads"] / $pdt["hits"] * 100;
        }
        else {
          $pdt["hits2orders"] = $pdt["hits2leads"] = 0;
        }
        $pdt["shipping_fee"] = empty($pdt["shipping_fee"]) ? ($pdt["shipping_fee"] = $pdt["hasPrice"] ? ($pdt["price"] > $fdp_franco ? "Offert" : $fdp." € HT") : "N/D") : $pdt["shipping_fee"]." € HT";
        if (empty($pdt["delivery_time"])) $pdt["delivery_time"] = $pdt["adv_delivery_time"];
        $pdt["url"] = URL."produits/".$pdt["catID"]."-".$pdt["id"]."-".$pdt["ref_name"].".html";
        $pdt["cart_add_url"] = "panier:".$pdt["catID"]."-".$pdt["id"]."-".$pdt["ref_idtc"];
        $pdt["pic_url"] = is_file(PRODUCTS_IMAGE_INC."thumb_big/".$pdt["id"]."-1".".jpg") ? PRODUCTS_IMAGE_URL."thumb_big/".$pdt["id"]."-1".".jpg" : PRODUCTS_IMAGE_URL."no-pic-thumb_big.gif";;
        $pdt['set_as_estimate'] = $pdt['price'] >= __THRESHOLD_PRICE_FOR_ESTIMATE__ || $pdt['product_as_estimate'];
        $pdtList["data"][] = &$pdt;
        if ($pdt["hasPrice"])
          $pdtList["priceCountShowed"]++;
        $pdtList["count"]++;
      }
      $pdtList["totalCount"]++;
      
    }
    unset($pdt);
    
    // Determining if we show some blocks
    $showPdtTypeBlock = true;
    if ($pdtList["saleableCount"] == 0 || $pdtList["totalCount"] == $pdtList["saleableCount"]
      || $pdtList["advCatCount"][__ADV_CAT_SUPPLIER__] == 0 || $pdtList["totalCount"] == $pdtList["advCatCount"][__ADV_CAT_SUPPLIER__])
    $showPdtTypeBlock = false;
    
    $showPriceSortBlock = $pdtList["priceCountShowed"] > 1;
    
  // Page calculations
    $pageBorderRange = 5;
    if ($page < 1) $page = 1;
    $maxpage = floor((($pdtList["count"]-1) - ($pdtList["count"]-1)%NB) / NB) + 1;
    if ($page > $maxpage) $page = $maxpage;
    if ($page > 1) $urlOpt["page"] = $page;
    
    $minBorderPage = $page>$pageBorderRange ? (($pageBorderRange-$page)<1 ? ($maxpage<= $pageBorderRange*2+1 ? 1 : $page-$pageBorderRange) :$pageBorderRange-$page) : 1;
    $minBorderPage = $maxpage-$minBorderPage < ($pageBorderRange*2+1) && $maxpage>$pageBorderRange*2+1 ? $maxpage-$pageBorderRange*2 : $minBorderPage;
    $maxBorderPage = $maxpage<$pageBorderRange*2+1 ? $maxpage : ($minBorderPage+$pageBorderRange*2+1>$maxpage ? $maxpage :$page+$pageBorderRange);
    if($maxpage >= $pageBorderRange*2+1)
      $maxBorderPage = ($page<=$pageBorderRange) ? $pageBorderRange*2+1 : ($page+$pageBorderRange>$maxpage ? $maxpage : $page+$pageBorderRange);
    
  // Items to show
    $startItemIndex = ($page-1) * NB;
    $endItemIndex = min($page * NB, $pdtList["count"]) - 1;
    $DisplayedItemCount = $endItemIndex - $startItemIndex + 1;
    
  // Bayesian average of every products
    $bayesianAvg = (GLOBAL_AVERAGE_PRICE * TYPICAL_DATA_SET_SIZE + $pdtList["priceSum"]) / ($pdtList["priceCount"] + TYPICAL_DATA_SET_SIZE);
    
  // Sorting
    switch ($sort) {
      case "updated"    : Utils::sortDbInPlace($pdtList["data"], "timestamp", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
      case "view"       : Utils::sortDbInPlace($pdtList["data"], "hits", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
      case "lead"       : Utils::sortDbInPlace($pdtList["data"], "leads", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
      case "price-asc"  : Utils::sortDbInPlace($pdtList["data"], "price", SORT_ASC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
      case "price-desc" : Utils::sortDbInPlace($pdtList["data"], "price", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
      case "relevant"   :
      default :
        $sort = "";
        Utils::sortDbInPlace($pdtList["data"], "order", SORT_ASC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING);
        break;
    }
    if (!empty($sort)) $urlOpt["sort"] = "sort=".$sort;
    
    $urlOpt["pageFS"] = empty($urlOpt["filter"]) && empty($urlOpt["sort"]) ? "" : "/".$urlOpt["filter"].$urlOpt["sort"];
    if (!empty($urlOpt["page"])) $urlOpt["page"] = ",".$urlOpt["page"];
    if (!empty($urlOpt["sort"])) $urlOpt["sort"] = "&".$urlOpt["sort"];
    if (!empty($urlOpt["filter"])) $urlOpt["filter"] = "&".$urlOpt["filter"];
  }
  
  list($title, $meta_desc, $meta_keys) = str_replace(
    array("%MB_NAME%"),
    array($ms->name),
    array(MB_TITLE, MB_META_DESC, MB_META_KEYS)
  );
  
  if ($pdtList["advCatCountShowed"][__ADV_CAT_SUPPLIER__] == 0) {
    define("NO_SUPPLIER_PRODUCT", true);
    if ($pdtList["advCatCountShowed"][__ADV_CAT_ADVERTISER__] < $pdtList["count"])
      define("NOR_ADVERTISER_PRODUCT", true);
  }
  
  // getting all the pdt cat 3's
  $cat3List = array();
  foreach ($pdtList['data'] as $pdt) {
    $cat3List[$pdt['catID']] = array(
      'ref_name' => $pdt['cat_ref_name'],
      'name' => $pdt['cat_name']
    );
  }
  
  require(SITE.'head.php');
?>
<div id="body" class="white-bg">
  <div class="categories" id="left-col">
    <div class="left-panel">
      <div id="pdt-filtering" class="filtering">
       
       <?php if (count($cat3List) > 1) : ?>
        <div id="cat3-cat-filtering" class="filtering">
          <div class="pdt-filtering-title">Familles concernées</div>
          <ul class="cat3-cat-filtering">
           <?php foreach ($cat3List as $cat_id => $cat_infos) : ?>
            <li><a href="<?php echo URL."familles/".$cat_infos['ref_name'].".html" ?>"><?php echo $cat_infos['name'] ?></a></li>
           <?php endforeach ?>
          </ul>
        </div>
       <?php endif ?>
      
      </div>
    </div>
    
    <div class="right-panel">
      <?php echo $ms->desc ?>
      <div class="zero"></div>
      <div id="cat3-pagination-block">
        
        <div class="cat3-pdt-count"><?php echo $pdtList["count"] ?> produit<?php echo $pdtList["count"] != 1 ? 's': '' ?></div>
       
       <?php if ($showPriceSortBlock) : ?>
        <div class="filter-sort">
          Trier par : <select>
            <option name=""></option>
            <option name="sort-price-asc" <?php echo ($sort=="price-asc"?'selected="selected"':"") ?>>Prix - / +</option>
            <option name="sort-price-desc"<?php echo ($sort=="price-desc"?'selected="selected"':"") ?>>Prix + / -</option>
          </select>
        </div>
       <?php endif ?>

        <div class="page-list">
          <img src="<?php echo URL ?>ressources/images/pagination-bg-left.png" alt="" class="fl" />
          <div class="page-links">
          <?php for ($k = $minBorderPage; $k <= $maxBorderPage; $k++) : ?>
            <?php if ($k == $page) : ?>
              <span class="cat3-current-page cat3-pagination-page"><?php echo $k ?></span>
            <?php else : ?>
              <a class="pagination-link" href="<?php echo URL."miniboutiques/".$ms->id."-".$ms->ref_name.($k==1 ? '' : ','.$k) ?>.html"><?php echo $k ?></a>
            <?php endif ?>
          <?php endfor ?>
          </div>
          <img src="<?php echo URL ?>ressources/images/pagination-bg-right.png" alt="" class="pagination-bg-right" />
        </div>

      </div>
    
     <?php for ($k = $startItemIndex; $k <= $endItemIndex; $k++) : $pdt = &$pdtList["data"][$k] ?>
      <div class="grey-block">
        <div class="fl cat3-prod-list-pic">
          <div class="picture fl">
            <div class="cat3-picture-border">
              <a href="<?php echo $pdt["url"] ?>"><img src="<?php echo $pdt["pic_url"] ?>" alt="" class="vmaib"/></a><div class="vsma"></div>
              <div class="cat3-product-show"></div>
            </div>
          <?php if ($pdt["adv_cat"] == __ADV_CAT_SUPPLIER__ ) : ?>
            <div class="conseils-d-experts">
              <img alt="Bénéficiez du conseil d'experts sur ce produit" src="<?php echo URL ?>ressources/images/picto-supplier.png" class="vmaib fl">
              <span class="fr">Bénéficiez du conseils<br />d'experts sur ce produit</span>
            </div>
          <?php else : ?>
            <div class="plusieurs-devis">
              <img alt="Gagnez du temps en recevant plusieurs devis" src="<?php echo URL ?>ressources/images/picto-advertiser.png" class="vmaib fl">
              <span class="fr">Gagnez du temps,<br /> en recevant plusieurs devis</span>
            </div>
          <?php endif ?>
          </div>
          
          <div class="fr cat3-prod-list-infos">
            <h2><a class="blue-small-title blue-smaller-title" href="<?php echo $pdt["url"] ?>"><?php echo $pdt["name"] ?></a></h2>
            <?php echo $pdt["fastdesc"] ?>
           <?php if ($pdt["adv_cat"] == __ADV_CAT_SUPPLIER__ ) : ?>
            <p class="cat3-checked-line"><img src="<?php echo URL ?>ressources/images/green-check.png" alt="" />Livraison: <?php echo $pdt["delivery_time"] ?></p>
              <?php if (!$pdt['set_as_estimate']) : ?>
              <p class="cat3-checked-line"><img src="<?php echo URL ?>ressources/images/green-check.png" alt="" />Frais de port: <strong><?php echo $pdt["shipping_fee"] ?></strong></p>
              <?php endif ?>
           <?php endif ?>
           <?php if(!empty ($pdt['average_note'])) {
              echo '<span class="cat3-checked-line"><img src="'.URL.'ressources/images/picto-avis.png" alt="picto-avis" /> Avis client ';
              showStarRater($pdt['average_note']);
              echo ' <a class="color-blue ShowProductFeedback" href="'.$pdt["id"].'">Lire les avis</a></span>';
            } ?>
          </div>
        </div>
        
        <div class="fr cat3-prod-list-relations">
          <div class="cat3-price">
            <?php echo ($pdt["hasPrice"] ? ($pdt['set_as_estimate'] ? 'Sur devis' : 'à  partir de : <span>'.sprintf("%.02f",$pdt["price"])."€ HT</span>") : 'à  partir de : <span>'.$pdt["price"].'</span>') ?>
          </div>
          <div class="cat3-action">
            <a href="<?php echo $pdt["cart_add_url"] ?>" class="<?php if ($pdt["saleable"] && !$pdt['set_as_estimate']) { echo $pdt['nb_refs'] > 1 ? 'btn-cart-add-big-pink': 'btn-cart-add-small-single'; } else { ?>btn-esti-ask-orange<?php } ?>" data-adv-type="<?php echo $pdt["adv_cat"] ?>" ></a>
            <div class="savedProductsListZone_<?php echo $pdt['id'] ?>">
              <?php $productList = new ProductsSavedList();
              if ($productList->isProductInSavedList($pdt['id'])) : ?>
                <div class="puce puce-9"></div><span class="color-green">Produit sauvegardé</span>
                <a href="<?php echo $session->logged ? COMPTE_URL.'saved-products-list.html' : URL.'liste-produits-sauvegardes.html' ?>" class="color-blue">Voir liste</a>
              <?php else : ?>
                <a href="saveProductList:add-<?php echo $pdt['id'] ?>" class="btn-users-product-list"><div class="puce puce-5"></div>Sauvegarder ce produit</a>
              <?php endif ?>
            </div>
            <div class="zero"></div>
           <?php if ($pdt["adv_cat"] == __ADV_CAT_SUPPLIER__ ) : ?>
            <a href="<?php echo $pdt["cart_add_url"]; ?>"  data-adv-type="<?php echo $pdt["adv_cat"]; ?>" class="ask-estimate-link"><div class="puce puce-4"></div>Demander un devis</a>
           <?php endif ?>
          </div>
        </div>
        <div class="zero"></div>
      </div>
      <?php endfor // pdtList ?>
      
      <div id="cat3-pagination-block">
        
        <div class="cat3-pdt-count"><?php echo $pdtList["count"] ?> produit<?php echo $pdtList["count"] != 1 ? 's': '' ?></div>

       <?php if ($showPriceSortBlock) : ?>
        <div class="filter-sort">
          Trier par : <select>
            <option name=""></option>
            <option name="sort-price-asc" <?php echo ($sort=="price-asc"?'selected="selected"':"") ?>>Prix - / +</option>
            <option name="sort-price-desc"<?php echo ($sort=="price-desc"?'selected="selected"':"") ?>>Prix + / -</option>
          </select>
        </div>
       <?php endif ?>
  
        <div class="page-list">
          <img src="<?php echo URL ?>ressources/images/pagination-bg-left.png" alt="" class="fl" />
          <div class="page-links">
          <?php for ($k = $minBorderPage; $k <= $maxBorderPage; $k++): ?>
             <?php if ($k == $page) : ?>
              <span class="cat3-current-page cat3-pagination-page"><?php echo $k ?></span>
             <?php else : ?>
              <a class="pagination-link" href="<?php echo URL."miniboutiques/".$ms->id."-".$ms->ref_name.($k==1 ? '' : ','.$k) ?>.html"><?php echo $k ?></a>
             <?php endif ?>
           <?php endfor ?>
          </div>
          <img src="<?php echo URL ?>ressources/images/pagination-bg-right.png" alt="" class="pagination-bg-right" />
        </div>
      
      </div>
      
    </div><!-- right panel -->
    
  </div><!-- #left-col -->
  
  <?php require(SITE.'blocks-right.php') ?>
</div>

<?php
} elseif ($ms->type == "cat") {
  
  $mts["MINI-STORE CAT SHOW INIT"]["start"] = microtime(true);
  $cat3List = $cat3CsList = array();
  $cat3CsList_len = 0;
  
  $pdtList = array(
    "data" => array(),
    "count" => 0,
    "totalCount" => 0,
    "saleableCount" => 0,
    "advCatCount" => array(),
    "advCatCountShowed" => array(),
    "priceSum" => 0,
    "priceCount" => 0,
    "priceCountShowed" => 0,
    "priceMax" => 0,
    "priceMin" => 0x7fffffff
  );
  
  foreach ($ms->items as $item) {

    $ccat3 = $xPath->query("parent::category",$dom->getElementById(XML_KEY_PREFIX.$item['categoryID']))->item(0);
    $ccat2 = $xPath->query("parent::category/parent::category",$dom->getElementById(XML_KEY_PREFIX.$ccat3->getAttribute("id")))->item(0);
    $ccat1 = $xPath->query("parent::category/parent::category",$dom->getElementById(XML_KEY_PREFIX.$ccat2->getAttribute("id")))->item(0);
    
    if (empty($ccat2)) {
      $infosCat[$item['categoryID']] = array('catLevel' => 1, 'name' => $ccat3->getAttribute("name"), 'ref_name' => $ccat3->getAttribute("ref_name"));
    } else {
      if (empty($ccat1))
        $infosCat[$item['categoryID']] = array('catLevel' => 2, 'name' => $ccat3->getAttribute("name"), 'ref_name' => $ccat3->getAttribute("ref_name"));
      else
        $infosCat[$item['categoryID']] = array('catLevel' => 3, 'name' => $ccat3->getAttribute("name"), 'ref_name' => $ccat3->getAttribute("ref_name"));
    }

    // Getting a picture for the cat3
    $ccat3_pic_id = 0;
    $ccat3_pics_node = $xPath->query("child::pdt_pic", $ccat3);
    if ($ccat3_pics_node->length >= 1) {
      $ccat3_pics = explode("|",$ccat3_pics_node->item(0)->nodeValue);
      $ccat3_pics_count = count($ccat3_pics);
      if ($ccat3_pics_count != 0)
        $ccat3_pic_id = $ccat3_pics[mt_rand(0,$ccat3_pics_count-1)];
    }
    if ($ccat3_pic_id == 0) { // no picture found in xml
      $stats = explode("|",$xPath->query("child::stats",$ccat3)->item(0)->nodeValue);
      for ($sk = 0, $slen = count($stats); $sk < $slen; $sk++)
        $sccat3[$stats_key[$sk]] = $stats[$sk];

      $res = $db->query("
        SELECT p.id
        FROM products p, products_families pf, advertisers a
        WHERE p.id = pf.idProduct AND pf.idFamily = '".$ccat3->getAttribute("id")."' AND p.idAdvertiser = a.id AND a.actif = 1
        LIMIT ".(mt_rand(0,$sccat3["pdt_count"]-1)).",1", __FILE__, __LINE__);
      list($ccat3_pic_id) = $db->fetch($res);
    }

    // Setting cat2 usefull infos
    $cat3List[] = array(
      "id" => utf8_decode($ccat3->getAttribute("id")),
      "name" => utf8_decode($ccat3->getAttribute("name")),
      "ref_name" => utf8_decode($ccat3->getAttribute("ref_name")),
      "url" => URL."familles/".utf8_decode($ccat3->getAttribute("ref_name")).".html",
      "pic_url" => is_file(PRODUCTS_IMAGE_INC."thumb_small/".$ccat3_pic_id."-1".".jpg") ? PRODUCTS_IMAGE_URL."thumb_small/".$ccat3_pic_id."-1".".jpg" : PRODUCTS_IMAGE_URL."no-pic-thumb_small.gif"
    );

    // Getting 10 first cat2 names for meta/title
    if ($cat3CsList_len++ < 10)
      $cat3CsList[] = utf8_decode($ccat3->getAttribute("name"));

    $catProdList = Doctrine_Query::create()
      ->select('pf.idProduct')
      ->from('ProductsFamilies pf')
      ->innerJoin('pf.product_fr pfr')
      ->innerJoin('pf.advertiser adv')
      ->where('pf.idFamily = ?', $item['categoryID'])
      ->andWhere('pfr.active = 1')
      ->andWhere('adv.actif = 1')
      ->fetchArray();
  
    if (empty($catProdList)) {
      $getCat3FromCat2 = doctrine_query::create()
        ->select()
        ->from('Families f')
        ->where('f.idParent = ?', $item['categoryID'])
        ->fetchArray();
      $catProdList = array();
    
      $getUri = strstr( $_SERVER['REQUEST_URI'], '?cat2=');
      $getCat2Id = explode('=',$getUri);
    
      if (!empty($getCat2Id[1]) && $getCat2Id[1] == $item['categoryID']) {
        $sCat3FromCat2 = doctrine_query::create()
          ->select()
          ->from('Families f')
          ->innerJoin('f.family_fr ffr')
          ->where('f.idParent = ?', $item['categoryID'])
          ->fetchArray();
      }
      if (!empty($getCat3FromCat2)) {
        foreach ($getCat3FromCat2 as $Cat3FromCat2) {
          $prodsFromCat3 = Doctrine_Query::create()
            ->select('pf.idProduct')
            ->from('ProductsFamilies pf')
            ->innerJoin('pf.product_fr pfr')
            ->innerJoin('pf.advertiser adv')
            ->where('pf.idFamily = ?', $Cat3FromCat2['id'])
            ->andWhere('pfr.active = 1')
            ->andWhere('adv.actif = 1')
            ->fetchArray();

          foreach($prodsFromCat3 as $prod)
            $catProdList[] = $prod;
      
        }
      }
    }
  
    $results = array("data" => array(), "count" => 0);
    
    $pdt_infos = array();
    foreach($catProdList as $catProds)
      $pdt_infos[$catProds['idProduct']] = array("catID" => $catProds["idFamily"]);
    
    $res = $db->query("
      SELECT
        p.id, p.price AS pdt_price, p.timestamp, p.shipping_fee,
        pfr.name, pfr.ref_name, pfr.fastdesc, pfr.delai_livraison AS delivery_time,
        pf.idFamily AS catID,
        ps.hits, ps.orders, ps.leads, (".mktime(0,0,0)."- ps.first_hit_time) as age,
        a.id AS adv_id, a.nom1 AS adv_name, a.category AS adv_cat, a.delai_livraison AS adv_delivery_time,
        rc.id AS ref_idtc, rc.refSupplier AS ref_refSupplier, rc.price+rc.ecotax AS ref_price,
        (p.as_estimate + a.as_estimate) as product_as_estimate
      FROM products p
      INNER JOIN products_fr pfr ON p.id = pfr.id AND pfr.active = 1
      INNER JOIN products_families pf ON p.id = pf.idProduct
      INNER JOIN products_stats ps ON p.id = ps.id
      INNER JOIN advertisers a ON p.idAdvertiser = a.id AND a.actif = 1
      LEFT JOIN references_content rc ON p.id = rc.idProduct AND rc.classement = 1
      WHERE p.id in (".implode(",", array_keys($pdt_infos)).")
      GROUP BY p.id", __FILE__, __LINE__);
    
    // Fetching results
    while ($pdt = $db->fetchAssoc($res)) {
      $catID = $pdt_infos[$pdt["id"]]["catID"];
      $order = $pdt_infos[$pdt["id"]]["order"];
      $pdt_infos[$pdt["id"]] = $pdt;
      $pdt_infos[$pdt["id"]]["catID"] = $catID;
      $pdt_infos[$pdt["id"]]["order"] = $order;
      $results["data"][] = &$pdt_infos[$pdt["id"]];
      $results["count"]++;
    }
  
    if ($results["count"] > 0) {
      
      define("NB", 50);
      define("GLOBAL_AVERAGE_PRICE", 700);
      define("TYPICAL_DATA_SET_SIZE", 10);
      
      // GET's
      $page   = isset($_GET["page"])   ? (int)(trim($_GET["page"])) : 1;
      $sort   = isset($_GET["sort"])   ? trim($_GET["sort"]) : "";
      $filter = isset($_GET["filter"]) ? trim($_GET["filter"]) : "";
      $range  = isset($_GET["range"])  ? (preg_match("/^[0-9]+-[0-9]+$/", $_GET["range"]) ? $_GET["range"] : "") : "";
      switch ($filter) {
        case "all" : break;
        case "saleable" : break;
        case "partner" : break;
        case "price" : if (!empty($range)) list($minPrice, $maxPrice) = explode("-", $range); break;
        default : $filter = "";
      }
      $urlOpt = array();
      if (!empty($filter)) $urlOpt["filter"] = "filter=".$filter;
      if (!empty($range)) $urlOpt["filter"] .= "&range=".$range;
      
      // Loop for price calculation and filtering
      
      
      foreach ($results["data"] as $k => &$pdt) {
        
        // Determing price
        $pdt["saleable"] = $pdt["hasPrice"] = false;
        $pdt["price"] = $pdt["pdt_price"];
        if ($pdt["price"] == "ref") {
          $pdt["price"] = $pdt["ref_price"];
        }
        if (empty($pdt["price"])) {
          $pdt["price"] = "sur devis";
        }
        elseif (preg_match('/^[0-9]+((\.|,)[0-9]+){0,1}$/', $pdt["price"])) { // real price
          $pdt["hasPrice"] = true;
          $pdtList["priceCount"]++;
          $pdtList["priceSum"] += $pdt["price"];
          $pdtList["priceMax"] = max($pdt["price"], $pdtList["priceMax"]);
          $pdtList["priceMin"] = min($pdt["price"], $pdtList["priceMin"]);
          if ($pdt["adv_cat"] == __ADV_CAT_SUPPLIER__) {
            $pdt["saleable"] = true;
            $pdtList["saleableCount"]++;
          }
        }
        else {
          $pdt["price"] = "sur devis";
        }
        
        // Filtering
        $show = true;
        switch ($filter) {
          case "saleable" : if (!$pdt["saleable"]) $show = false; break;
          case "partner"  : if ($pdt["adv_cat"] == __ADV_CAT_SUPPLIER__) $show = false; break;
          case "price" : if (!$pdt["hasPrice"] || $pdt["price"] < $minPrice || $pdt["price"] >= $maxPrice) $show = false; break;
          default : break;
        }
        
        if (!isset($pdtList["advCatCount"][$pdt["adv_cat"]])) $pdtList["advCatCount"][$pdt["adv_cat"]] = 0;
        $pdtList["advCatCount"][$pdt["adv_cat"]]++;
        
        if ($show) {
          if (!isset($pdtList["advCatCountShowed"][$pdt["adv_cat"]])) $pdtList["advCatCountShowed"][$pdt["adv_cat"]] = 0;
          $pdtList["advCatCountShowed"][$pdt["adv_cat"]]++;
          
          $pdt["hpd"] = ($pdt["hits"] / $pdt["age"] * 86400);
          if ($pdt["hits"] > 0) {
            $pdt["hits2orders"] = $pdt["orders"] / $pdt["hits"] * 100;
            $pdt["hits2leads"] = $pdt["leads"] / $pdt["hits"] * 100;
          }
          else {
            $pdt["hits2orders"] = $pdt["hits2leads"] = 0;
          }
          $pdt["shipping_fee"] = empty($pdt["shipping_fee"]) ? ($pdt["shipping_fee"] = $pdt["hasPrice"] ? ($pdt["price"] > $fdp_franco ? "Offert" : $fdp." € HT") : "N/D") : $pdt["shipping_fee"]." € HT";
          if (empty($pdt["delivery_time"]))
            $pdt["delivery_time"] = $pdt["adv_delivery_time"];
          $pdt["url"] = URL."produits/".$pdt["catID"]."-".$pdt["id"]."-".$pdt["ref_name"].".html";
          $pdt["cart_add_url"] = "panier:".$pdt["catID"]."-".$pdt["id"]."-".$pdt["ref_idtc"];
          $pdt["pic_url"] = is_file(PRODUCTS_IMAGE_INC."thumb_big/".$pdt["id"]."-1".".jpg") ? PRODUCTS_IMAGE_URL."thumb_big/".$pdt["id"]."-1".".jpg" : PRODUCTS_IMAGE_URL."no-pic-thumb_big.gif";;
          $pdt['set_as_estimate'] = $pdt['price'] >= __THRESHOLD_PRICE_FOR_ESTIMATE__ || $pdt['product_as_estimate'];
          $pdtList["data"][] = &$pdt;
          if ($pdt["hasPrice"])
            $pdtList["priceCountShowed"]++;
          $pdtList["count"]++;
        }
        $pdtList["totalCount"]++;
        
      }
      unset($pdt);
      
      // Determining if we show some blocks
      $showPdtTypeBlock = true;
      if ($pdtList["saleableCount"] == 0 || $pdtList["totalCount"] == $pdtList["saleableCount"]
        || $pdtList["advCatCount"][__ADV_CAT_SUPPLIER__] == 0 || $pdtList["totalCount"] == $pdtList["advCatCount"][__ADV_CAT_SUPPLIER__])
      $showPdtTypeBlock = false;
      
      $showPriceSortBlock = $pdtList["priceCountShowed"] > 1;
      
    // Page calculations
      $pageBorderRange = 5;
      if ($page < 1) $page = 1;
      $maxpage = floor((($pdtList["count"]-1) - ($pdtList["count"]-1)%NB) / NB) + 1;
      if ($page > $maxpage) $page = $maxpage;
      if ($page > 1) $urlOpt["page"] = $page;
      
      $minBorderPage = $page>$pageBorderRange ? (($pageBorderRange-$page)<1 ? ($maxpage<= $pageBorderRange*2+1 ? 1 : $page-$pageBorderRange) :$pageBorderRange-$page) : 1;
      $minBorderPage = $maxpage-$minBorderPage < ($pageBorderRange*2+1) && $maxpage>$pageBorderRange*2+1 ? $maxpage-$pageBorderRange*2 : $minBorderPage;
      $maxBorderPage = $maxpage<$pageBorderRange*2+1 ? $maxpage : ($minBorderPage+$pageBorderRange*2+1>$maxpage ? $maxpage :$page+$pageBorderRange);
      if($maxpage >= $pageBorderRange*2+1)
        $maxBorderPage = ($page<=$pageBorderRange) ? $pageBorderRange*2+1 : ($page+$pageBorderRange>$maxpage ? $maxpage : $page+$pageBorderRange);
      
    // Items to show
      $startItemIndex = ($page-1) * NB;
      $endItemIndex = min($page * NB, $pdtList["count"]) - 1;
      $DisplayedItemCount = $endItemIndex - $startItemIndex + 1;
      
    // Bayesian average of every products
      $bayesianAvg = (GLOBAL_AVERAGE_PRICE * TYPICAL_DATA_SET_SIZE + $pdtList["priceSum"]) / ($pdtList["priceCount"] + TYPICAL_DATA_SET_SIZE);
      
    // Sorting
      switch ($sort) {
        case "updated"    : Utils::sortDbInPlace($pdtList["data"], "timestamp", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
        case "view"       : Utils::sortDbInPlace($pdtList["data"], "hits", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
        case "lead"       : Utils::sortDbInPlace($pdtList["data"], "leads", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
        case "price-asc"  : Utils::sortDbInPlace($pdtList["data"], "price", SORT_ASC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
        case "price-desc" : Utils::sortDbInPlace($pdtList["data"], "price", SORT_DESC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING); break;
        case "relevant"   :
        default :
          $sort = "";
          Utils::sortDbInPlace($pdtList["data"], "order", SORT_ASC, SORT_NUMERIC, "name", SORT_ASC, SORT_STRING);
          break;
      }
      if (!empty($sort)) $urlOpt["sort"] = "sort=".$sort;
      
      $urlOpt["pageFS"] = empty($urlOpt["filter"]) && empty($urlOpt["sort"]) ? "" : "/".$urlOpt["filter"].$urlOpt["sort"];
      if (!empty($urlOpt["page"])) $urlOpt["page"] = ",".$urlOpt["page"];
      if (!empty($urlOpt["sort"])) $urlOpt["sort"] = "&".$urlOpt["sort"];
      if (!empty($urlOpt["filter"])) $urlOpt["filter"] = "&".$urlOpt["filter"];
    
    } // results count > 0
  
  } // for each ms items
  
  $cat3CsList = implode(", ", $cat3CsList);
  $mts["MINI-STORE CAT SHOW INIT"]["end"] = microtime(true);
  //foreach($mts as $mtn => $mt) print $mtn." = <b>".($mt["end"]-$mt["start"])*1000."ms</b><br/>\n";
  
  list($title, $meta_desc, $meta_keys) = str_replace(
    array("%MB_NAME%"),
    array($ms->name),
    array(MB_TITLE, MB_META_DESC, MB_META_KEYS));
  
  $c3i = 0;
  $pageName = "rg";
  require(SITE."head.php");
?>
<div id="body" class="white-bg">
  <div class="categories" id="left-col">
    <div class="left-panel">
      <div id="pdt-filtering" class="filtering">
        <div class="pdt-filtering-title">Familles</div>
        <ul  class="cat3-cat-filtering">
         <?php if (!empty($sCat3FromCat2)) : ?>
          <?php foreach($sCat3FromCat2 as $sCat3) :?>
            <li><a href="<?php echo URL."familles/".$sCat3['family_fr']['ref_name'] ?>.html" rel="nofollow"><?php echo $sCat3['family_fr']['name'] ?></a></li>
          <?php endforeach ?>
         <?php else : ?>
          <?php foreach($ms->items as $item) : ?>
            <?php if ($infosCat[$item['categoryID']]['catLevel'] == 3) : ?>
              <li><a href="<?php echo URL."familles/".$infosCat[$item['categoryID']]['ref_name'] ?>.html" rel="nofollow"><?php echo $infosCat[$item['categoryID']]['name'] ?></a></li>
            <?php elseif ($infosCat[$item['categoryID']]['catLevel'] == 2) : ?>
              <li><a href="<?php echo URL."miniboutiques/".$ms->id."-".$ms->ref_name.$urlOpt["page"].".html?cat2=".$item['categoryID'] ?>" rel="nofollow"><?php echo $infosCat[$item['categoryID']]['name'] ?></a></li>
            <?php endif ?>
          <?php endforeach ?>
         <?php endif ?>
        </ul>
      </div>
    </div>
    
    <div class="right-panel">
      <?php echo $ms->desc ?>
      <div class="zero"></div>
      <div id="cat3-pagination-block">

        <div class="cat3-pdt-count"><?php echo $pdtList["count"] ?> produit<?php echo $pdtList["count"] != 1 ? 's': '' ?></div>
        
       <?php if ($showPriceSortBlock) : ?>
        <div class="filter-sort">
          Trier par : <select>
            <option name=""></option>
            <option name="sort-price-asc" <?php echo ($sort=="price-asc"?'selected="selected"':"") ?>>Prix - / +</option>
            <option name="sort-price-desc"<?php echo ($sort=="price-desc"?'selected="selected"':"") ?>>Prix + / -</option>
          </select>
        </div>
       <?php endif ?>

        <div class="page-list">
          <img src="<?php echo URL ?>ressources/images/pagination-bg-left.png" alt="" class="fl" />
          <div class="page-links">
          <?php for ($k = $minBorderPage; $k <= $maxBorderPage; $k++): ?>
            <?php if ($k == $page) : ?>
              <span class="cat3-current-page cat3-pagination-page"><?php echo $k ?></span>
            <?php else : ?>
              <a class="pagination-link" href="<?php echo URL."miniboutiques/".$ms->id."-".$ms->ref_name.($k==1 ? '' : ','.$k) ?>.html"><?php echo $k ?></a>
            <?php endif ?>
          <?php endfor ?>
          </div>
          <img src="<?php echo URL ?>ressources/images/pagination-bg-right.png" alt="" class="pagination-bg-right" />
        </div>

      </div>

     <?php for ($k = $startItemIndex; $k <= $endItemIndex; $k++) : $pdt = &$pdtList["data"][$k] ?>
      <div class="grey-block">
        <div class="fl cat3-prod-list-pic">
          <div class="picture fl">
            <div class="cat3-picture-border">
              <a href="<?php echo $pdt["url"] ?>"><img src="<?php echo $pdt["pic_url"] ?>" alt="" class="vmaib"/></a><div class="vsma"></div>
              <div class="cat3-product-show"></div>
            </div>
            <?php if ($pdt["adv_cat"] == __ADV_CAT_SUPPLIER__ ) : ?>
            <div class="conseils-d-experts">
              <img alt="Bénéficiez du conseil d'experts sur ce produit" src="<?php echo URL ?>ressources/images/picto-supplier.png" class="vmaib fl">
              <span class="fr">Bénéficiez du conseils<br />d'experts sur ce produit</span>
            </div>
            <?php else : ?>
            <div class="plusieurs-devis">
              <img alt="Gagnez du temps en recevant plusieurs devis" src="<?php echo URL ?>ressources/images/picto-advertiser.png" class="vmaib fl">
              <span class="fr">Gagnez du temps,<br /> en recevant plusieurs devis</span>
            </div>
            <?php endif ?>
          </div>
          
          <div class="fr cat3-prod-list-infos">
            <h2><a class="blue-small-title blue-smaller-title" href="<?php echo $pdt["url"] ?>"><?php echo $pdt["name"] ?></a></h2>
            <?php echo $pdt["fastdesc"] ?>
           <?php if ($pdt["adv_cat"] == __ADV_CAT_SUPPLIER__ ) : ?>
            <p class="cat3-checked-line"><img src="<?php echo URL ?>ressources/images/green-check.png" alt="" />Livraison: <?php echo $pdt["delivery_time"] ?></p>
              <?php if (!$pdt['set_as_estimate']) : ?>
              <p class="cat3-checked-line"><img src="<?php echo URL ?>ressources/images/green-check.png" alt="" />Frais de port: <strong><?php echo $pdt["shipping_fee"] ?></strong></p>
              <?php endif ?>
           <?php endif ?>
           <?php if (!empty ($pdt['average_note'])) {
              echo '<span class="cat3-checked-line"><img src="'.URL.'ressources/images/picto-avis.png" alt="picto-avis" /> Avis client ';
              showStarRater($pdt['average_note']);
              echo ' <a class="color-blue ShowProductFeedback" href="'.$pdt["id"].'">Lire les avis</a></span>';
            } ?>
          </div>
        </div>
        <div class="fr cat3-prod-list-relations">
          <div class="cat3-price">
            <?php echo ($pdt["hasPrice"] ? ($pdt['set_as_estimate'] ? 'Sur devis' : 'à  partir de : <span>'.sprintf("%.02f",$pdt["price"])."€ HT</span>") : 'à  partir de : <span>'.$pdt["price"].'</span>') ?>
          </div>
          <div class="cat3-action">
            <a href="<?php echo $pdt["cart_add_url"] ?>" class="<?php if ($pdt["saleable"] && !$pdt['set_as_estimate']) { echo $pdt['nb_refs'] > 1 ? 'btn-cart-add-big-pink': 'btn-cart-add-small-single'; } else { ?>btn-esti-ask-orange<?php } ?>" data-adv-type="<?php echo $pdt["adv_cat"] ?>" ></a>
            <div class="savedProductsListZone_<?php echo $pdt['id'] ?>">
              <?php $productList = new ProductsSavedList();
              if ($productList->isProductInSavedList($pdt['id'])) : ?>
                <div class="puce puce-9"></div><span class="color-green">Produit sauvegardé</span>
                <a href="<?php echo $session->logged ? COMPTE_URL.'saved-products-list.html' : URL.'liste-produits-sauvegardes.html' ?>" class="color-blue">Voir liste</a>
              <?php else : ?>
                <a href="saveProductList:add-<?php echo $pdt['id'] ?>" class="btn-users-product-list"><div class="puce puce-5"></div>Sauvegarder ce produit</a>
              <?php endif ?>
            </div>
            <div class="zero"></div>
           <?php if ($pdt["adv_cat"] == __ADV_CAT_SUPPLIER__ ) : ?>
            <a href="<?php echo $pdt["cart_add_url"]; ?>"  data-adv-type="<?php echo $pdt["adv_cat"]; ?>" class="ask-estimate-link"><div class="puce puce-4"></div>Demander un devis</a>
           <?php endif ?>
          </div>
        </div>
        <div class="zero"></div>
      </div>
     <?php endfor // pdtList ?>

      <div id="cat3-pagination-block">
        
        <div class="cat3-pdt-count"><?php echo $pdtList["count"] ?> produit<?php echo $pdtList["count"] != 1 ? 's': '' ?></div>
        
       <?php if ($showPriceSortBlock) : ?>
        <div class="filter-sort">
          Trier par : <select>
            <option name=""></option>
            <option name="sort-price-asc" <?php echo ($sort=="price-asc"?'selected="selected"':"") ?>>Prix - / +</option>
            <option name="sort-price-desc"<?php echo ($sort=="price-desc"?'selected="selected"':"") ?>>Prix + / -</option>
          </select>
        </div>
       <?php endif ?>
       
        <div class="page-list">
          <img src="<?php echo URL ?>ressources/images/pagination-bg-left.png" alt="" class="fl" />
          <div class="page-links">
          <?php for ($k = $minBorderPage; $k <= $maxBorderPage; $k++): ?>
            <?php if ($k == $page) : ?>
              <span class="cat3-current-page cat3-pagination-page"><?php echo $k ?></span>
            <?php else : ?>
              <a class="pagination-link" href="<?php echo URL."miniboutiques/".$ms->id."-".$ms->ref_name.($k==1 ? '' : ','.$k) ?>.html"><?php echo $k ?></a>
            <?php endif ?>
          <?php endfor ?>
          </div>
          <img src="<?php echo URL ?>ressources/images/pagination-bg-right.png" alt="" class="pagination-bg-right" />
        </div>
        
      </div>
    
    </div><!-- right panel -->
    
  </div><!-- #left-col -->
  
  <?php require(SITE.'blocks-right.php') ?>
</div>

<?php
} else {
  header("Location: ".URL);
  exit();
}
?>

<?php require(SITE.'foot.php') ?>
